{"meta":{"title":"å°åº¦é˜¿ä¸‰","subtitle":"I'm my own hero","description":"Don't encourage you, you can't do it.","author":"è‘›æœ‹","url":"http://PGGMan.github.io"},"pages":[],"posts":[{"title":"NetWork","slug":"NetWork","date":"2018-09-17T07:51:18.000Z","updated":"2018-09-30T02:55:32.770Z","comments":true,"path":"2018/09/17/NetWork/","link":"","permalink":"http://PGGMan.github.io/2018/09/17/NetWork/","excerpt":"","text":"ç½‘ç»œæ¶æ„ 1.1 æ¯ä¸ªiOSåº”ç”¨éƒ½ä½äºæŸä¸ªç½‘ç»œæ¡†æ¶æ ˆä¹‹ä¸Šã€‚å…±4å±‚æ„æˆ * æœ€ä¸Šå±‚æ˜¯Cocoaå±‚ï¼šåŒ…å«äº†ç”¨äºURLåŠ è½½çš„OC API,Web Kitï¼ŒBonjourä¸Game Kit. * ç¬¬äºŒå±‚æ˜¯Core Foundationå±‚ï¼Œè¿™æ˜¯ä¸€å¥—C API,å…¶ä¸­åŒ…å«äº†CFNetwork,è¿™æ˜¯å¤§å¤šæ•°åº”ç”¨çº§åˆ«çš„ç½‘ç»œä»£ç çš„åŸºç¡€ï¼ŒCFNetworkåœ¨CFStreamä¸CFSocketä¹‹ä¸Šæä¾›äº†ä¸€ä¸ªç®€å•çš„ç½‘ç»œæ¥å£ï¼Œè¿™ä¸¤ä¸ªç±»æ˜¯é’ˆå¯¹BSD socketçš„è½»é‡çº§å°è£…ï¼Œåè€…åˆ™å½¢æˆäº†æœ€ä¸‹é¢çš„å±‚ Appleå»ºè®® 1. å»ºè®®å¼€å‘è€…ä½¿ç”¨CFNetworkå±‚åŠå…¶ä¹‹ä¸Šçš„ï¼› 2. BSDå±‚çš„åŸå§‹socketæ— æ³•è®¿é—®ç³»ç»ŸèŒƒå›´çš„VPNï¼Œä¹Ÿæ— æ³•æ¿€æ´»Wi-Fiå’Œèœ‚çªæ— çº¿ç”µï¼Œè€Œè¿™äº›CFNetworkå·²ç»å¸®æˆ‘ä»¬å¤„ç†å¥½äº†","categories":[],"tags":[]},{"title":"å°å¼æœºç»„è£…","slug":"myComputer","date":"2018-09-03T08:26:52.000Z","updated":"2018-09-05T07:28:21.802Z","comments":true,"path":"2018/09/03/myComputer/","link":"","permalink":"http://PGGMan.github.io/2018/09/03/myComputer/","excerpt":"","text":"å‰å™ ç”µè„‘ï¼Œåœ¨ç°åœ¨æ¥è¯´å·²ç»éå¸¸æ™®éäº†ï¼Œä½åˆ°ä¸€ä¸¤åƒé«˜åˆ°å‡ åä¸‡ã€‚è®°å¾—è‡ªå·±çš„ç¬¬ä¸€å°ç”µè„‘æ˜¯08å¹´é«˜è€ƒåï¼Œå“€æ±‚çˆ¶äº²ä¹°æ¥çš„ã€‚ä¸€å››å¹´è§‰å¾—è¿™å°ç”µè„‘æœ‰ç‚¹è·Ÿä¸ä¸Šå…­äº†ã€‚å°±èŒç”Ÿäº†ç”¨è‡ªå·±çš„ç§¯è“„äº²è‡ªåŠ¨æ‰‹æ”’ä¸€å°ã€‚ä»äº¬ä¸œå’Œå¤©çŒ«ä¹°æ¥äº†ä¸€å¥—è‡ªå·±åœ¨ç™¾åº¦ä¸Šæœåˆ°çš„é…ç½®å•(å¤§æ¦‚é…ç½®æ˜¯CPU:i5 4570 æ˜¾å¡æ˜¯æ‹–åŒå­¦å…¬å¸å†…éƒ¨è´­ä¹°çš„åç¡•7800ï¼Œä¸»æ¿å‹å·ä¸è¯¦äº†ï¼Œå†…å­˜æ¡ï¼šå•æŒ‘é‡‘å£«é¡¿8G(æ—©çŸ¥é“æ¶¨ä»·è¿™ä¹ˆçŒ›ï¼Œå±¯ä¸€è½¦äº†))ã€‚æˆ‘çš„å¤©ï¼Œé‚£æ˜¯ä¸€ä¸ªå…´å¥‹å•Šã€‚ç„¶åè‡ªå·±å°±åœ¨é‚£é¼“æ£é¼“æ£å•Šã€‚æœ€ååˆ°è·‘çº¿äº†ï¼Œæ˜¯åœ¨ä¸æ•¢ä¸‹æ‰‹ï¼Œä¹°çš„è¿™ä¹ˆè´µçš„ä¸œä¸œï¼Œä¸‡ä¸€å¼„åäº†å’‹æ•´ã€‚æœ€åæ²¡åŠæ³•è·‘åˆ°ä¿®ç”µè„‘é‚£èŠ±äº†200å¤§æ´‹è·‘çº¿å’Œè£…ç³»ç»Ÿéƒ½æå®šäº†(è£…å¾—ç›—ç‰ˆwin7)ã€‚è¿™å°ç”µè„‘ä¸€ç›´é…ç›¼ç€æˆ‘ï¼Œä»å¹¿å·å›æ¥åˆ°åŒ—äº¬å®‰ç¨³ä¸‹æ¥åå°±ç›´æ¥æŠŠå®ƒæ¥è¿‡æ¥äº†ã€‚æ— å¥ˆæœ€æ–°çˆ¶äº²é‚£è¾¹ä¸€ç›´æƒ³ç©QQè±¡æ£‹ã€‚äºæ˜¯ä¹ï¼Œåªèƒ½å¿ç—›å‰²çˆ±äº†(å“ˆå“ˆğŸ˜ï¼Œæˆ‘ç»ˆäºæœ‰ç†ç”±æ¢æ›´é«˜é…çš„ç”µè„‘äº†)ã€‚æŠŠç”µè„‘é‚®å¯„å›å®¶æ²¡å¤šä¹…ï¼ŒèŠ±äº†8400å¤§æ´‹æ–°ä¹°çš„ç»„è£…æœºå°±åˆ°äº†ï¼Œç»“æœåŒäº‹è¯´æœ‰æ¬¾æ€§ä»·æ¯”æ›´é«˜çš„ã€‚åªå¥½æŠŠå®ƒæ¨äº†ã€‚èŠ±äº†8700ä¹°äº†ä¸€å°i7 8700 + 1070tiçš„æœºå­ã€‚ä¸è¿‡è¿™å°æœºå­å£°éŸ³æœ‰ç‚¹å¤§ã€‚è€Œä¸”æœºç®±å¤ªå°ï¼Œä¸æ˜¯è‡ªå·±å–œæ¬¢çš„ã€‚è‡ªå·±æ›´å–œæ¬¢ç¬¬ä¸€å°é‚£æ¬¾æµ·ç›—èˆ¹æœºç®±ã€‚äºæ˜¯ä¹åˆæŠŠè¿™å°æ¨äº†ã€‚ç‹ ä¸‹å¿ƒæ¥ï¼Œæ‰“ç®—å¤šèŠ±ä¸ªå‡ ç™¾å¤§æ´‹è‡ªå·±ä¹°é›¶ä»¶ç»„è£…ã€‚è¿™æ ·ä¸ä½†èƒ½ä¹°åˆ°è‡ªå·±å–œæ¬¢çš„é›¶ä»¶(æœ‰äººè¯´è¿™æ˜¯ä¿¡ä»°)è¿˜èƒ½å¼¥è¡¥ä¸€ä¸‹ç¬¬ä¸€æ¬¡ç»„è£…ä¸»æœºçš„é—æ†¾ã€‚äºæ˜¯ä¹æœ€åèŠ±äº†ä¸€ä¸‡ä¸‰åƒå¤§æ´‹ã€‚æ²¡åŠæ³•ã€‚ä¸Šå¤´å•¦(à²¥ _ à²¥)ã€‚ ä¸‹é¢æ˜¯é…ç½®å›¾ æœºç®±ï¼šç¾å•†æµ·ç›—èˆ¹(ä¸­æ€§æœºç®±ï¼Œå¦‚æœå®‰è£…å¤§äºç­‰äº2ä¸ªé£æ‰‡çš„å‰ç½®æ°´å†·ï¼Œéœ€è¦æ‹†ä¸‹ç¡¬ç›˜æ¶) ä¸»æ¿: åç¡•Z370-A(å½“æ—¶å’ŒCPUæ­ç€ä¹°çš„ï¼Œæœ‰ä¼˜æƒ ã€‚è¿™ä¸ªæ¿å­é™¤äº†ä»·æ ¼é«˜ç‚¹æ²¡å•¥ç¼ºç‚¹ï¼Œå¯è¶…é¢‘) CPU: i7-8700kç›’è£…(å¸¦kçš„å±äºå¯è¶…é¢‘çš„Uï¼Œç›’è£…æ˜¯æŠŠæ•£è£…ä¸­æ€§èƒ½ç¨å¾®é«˜çš„ä¸­æŒ‘é€‰å‡ºæ¥çš„) æ˜¾å¡: ä¸ƒå½©è™¹1080çƒˆç„°æˆ˜ç¥X-8GD5X(ç°åœ¨æ˜¾å¡å·²ç»å‡ºåˆ°äº†2080Ti,ä¸ƒå½©è™¹ç›¸å¯¹å»å…¶ä»–å¤§ç‰Œä»·æ ¼ç®—æ¯”è¾ƒä½å»‰çš„,è‡ªå¸¦ä¸€é”®è¶…é¢‘ã€‚ç¬¬ä¸€æ¬¡è¶…å±…ç„¶è“å±äº†) å†…å­˜æ¡: ç¾å•†æµ·ç›—èˆ¹-å¤ä»‡è€…lPX DDR4 3000 16GB(å•æ¡ï¼ŒåŒæ¡8*2 ä¼šè´µå¤§æ¦‚ä¸€ç™¾å…ƒ) ç”µæº: ç¾å•†æµ·ç›—èˆ¹RM650xå…¨æ¨¡ç»„(è¿™ä¸ªç”µæºå“è´¨æ²¡çš„è¯´ï¼Œå°±æ˜¯å®ƒçš„çº¿æœ‰ç‚¹ç¡¬) æ°´å†·: ç¾å•†æµ·ç›—èˆ¹H100i V2ä¸€ä½“å¼æ°´å†·CPUæ•£çƒ­å™¨(è£…åœ¨è¿™ä¸ªæœºç®±ä¸Šéœ€è¦æŠŠç¡¬ç›˜æ¶æ‹†æ‰ï¼Œç°åœ¨æœºæ¢°ç¡¬ç›˜è¿˜åœ¨æœºç®±åº•éƒ¨è´´ç€å‘¢ã€‚æ²¡æ‰¾åˆ°ä»€ä¹ˆå¥½æ¶å­å›ºå®šå‘¢) å›ºæ€ï¼šè‹±ç‰¹å°”M.2 256G(760Pç³») æœºæ¢°ï¼šè¥¿æ•°è“ç›˜1T(æœºæ¢°ç¡¬ç›˜ä¸­é»‘ç›˜è¯»å†™æ•°æ®æœ€å¿«ï¼Œä¸è¿‡æœ‰å›ºæ€ï¼Œè§‰å¾—æ²¡å¿…è¦ã€‚è‡ªå·±ä¹°æ¡ç¡¬ç›˜çº¿ï¼Œæˆ‘æ²¡æœ‰å‘ç°å“ªé‡Œå¸¦) ç»„è£… ç»„è£…é¡ºåº å°†CPUæ‰£åˆ°ä¸»æ¿CPUæ§½å†…,è¿™é‡Œæ²¡ä»€ä¹ˆè¯´çš„ã€‚æœ‰é˜²å‘†æ§½ï¼Œç›´æ¥æŒ‰ç„¶åå¡ä¸Šé‡‘å±åœˆæ‰£ã€‚ æŸ¥å†…å­˜æ¡ï¼Œå¦‚æœæ˜¯4æ§½æˆ–æ›´å¤šçš„ä¸»æ¿ï¼Œè¯·é—´éš”æ’(è¿™é‡Œè¯´çš„ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€ä¸»è¦çš„æ˜¯çœ‹æ’æ§½é¢œè‰²ï¼Œæ’åŒè‰²çš„) å®‰è£…CPUæ°´å†·æ’å’Œé£æ‰‡ï¼Œå› ä¸ºæˆ‘è¿™ä¸ªä¸€ä½“æ°´å†·é£æ‰‡å’Œæ°´å†·æ‹(ç±»ä¼¼äºæš–æ°”ç‰‡å­çš„ä¸œä¸œ)æ˜¯ç”¨èºä¸ä¸²è¡Œå›ºå®šçš„ï¼Œå¹¶ä¸”åŒé£æ‰‡ã€‚å¹¶ä¸”è£…åœ¨æœºç®±å‰é¢(æ³¨æ„é£æ‰‡å¯ä¸è¦è£…åäº†å•Šï¼Œä¸€èˆ¬æ‰‡è½´å¸¦æ ‡çš„æœå¤–ï¼Œé£æ˜¯å¾€é‡Œé¢å¹çš„)ã€‚ç”¨é•¿é’‰ç©¿è¿‡æœºç®±å­”å’Œé£æ‰‡å­”ï¼Œç„¶åç”¨èƒ¶æ¡æŠŠé£æ‰‡ç¨å¾®å›ºå®šä¸€ä¸‹ã€‚ä¸¤ä¸ªé£æ‰‡å›ºå®šå¥½åï¼Œå†æŠŠå†·æ’è´´ä¸Šå»ï¼Œå¯¹é½èºä¸å­”ã€‚æ‹§ç´§ã€‚(ç”¨èƒ¶æ¡å›ºå®šæ˜¯é˜²æ­¢ä¸Šå†·æ’é£æ‰‡ä¹±åŠ¨ï¼Œç”¨å®Œæ’•ä¸‹æ¥å³å¯) æ¥ä¸‹æ¥å°†ä¸»æ¿å®‰è£…åˆ°æœºç®±å†…ï¼Œæ³¨æ„å…ˆåœ¨ä¸»æ¿CPUä½èƒŒéƒ¨å®‰è£…CPUæ°´å†·/é£å†·èºä¸æ¡†ï¼Œæœºç®±èƒŒéƒ¨æœ‰ç©ºéš™çš„ï¼Œå¯ä»¥å›ºå®šä¸»æ¿åå†å®‰è£…ã€‚å›ºå®šä¸»æ¿ï¼Œå¯å…ˆå›ºå®šå³ä¸Šè§’èºä¸å­”ï¼Œç„¶åå³ä¸‹è§’èºä¸å­”ï¼Œè¿™æ ·å…¶ä»–èºä¸å­”ä¹Ÿå›ºå®šäº†ã€‚ CPUå®‰è£…æ°´å†·æ°´æ³µï¼Œä¸»è¦Intel/AMDåŒºåˆ«ï¼Œä¸¤é¢—æ‰£ç¯ä¸ä¸€æ ·ã€‚ ç°åœ¨å¼€å§‹æ’çº¿ [æˆ‘æ˜¯ 1] CPU_FAN/CPU_OPTã€‚ä¸¤è€…çš„åŒºåˆ«æ˜¯ï¼ŒCPU_FANçš„å®«æ®¿æ˜¯éšç€CPUæ¸©åº¦è€Œå˜åŒ–å¾—ï¼ŒCPU_OPTæ˜¯ä¸€ç›´å…¨é€Ÿçš„ã€‚ [æˆ‘æ˜¯ 2] ç”µæºçº¿æ’å£ï¼Œæ˜¾å¡ä½ç½®æ˜¯ç›´æ¥æ’åˆ°æ˜¾å¡ä¸Šçš„ã€‚ [æˆ‘æ˜¯ 3] æ˜¯æœºç®±è·³çº¿ä½,æœºç®±çº¿çš„ä¸€ç»„ [æˆ‘æ˜¯ 4] æœºç®±éŸ³é¢‘çº¿ä½ï¼ˆä¸»æœºå‰é¢çš„è€³æœºå­”ï¼‰æœºç®±çº¿çš„ä¸€æ ¹ å®‰è£…ç”µæºåŠç”µæºçº¿ æ’æ˜¾å¡ï¼Œæ’å®Œåæ’ç”µæºçº¿ ç³»ç»Ÿç›˜åˆ¶ä½œ","categories":[],"tags":[]},{"title":"RunLoop","slug":"RunLoop","date":"2018-07-25T12:57:39.000Z","updated":"2018-08-19T07:03:14.410Z","comments":true,"path":"2018/07/25/RunLoop/","link":"","permalink":"http://PGGMan.github.io/2018/07/25/RunLoop/","excerpt":"","text":"Runloop æ¦‚å¿µ è¿è¡Œå¾ªç¯ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¾ªç¯å¹¶å¤„ç†ä¸€äº›äº‹æƒ… åº”ç”¨åœºæ™¯ å®šæ—¶å™¨(Timerã€CADisplayLink) performSelector GCD äº‹ä»¶å“åº”ã€æ‰‹åŠ¿è¯†åˆ«ã€ç•Œé¢åˆ·æ–° ç½‘ç»œè¯·æ±‚ AutoreleasePool çº¿ç¨‹ä¿æ´» RunLoop æœ‰æ— çš„æƒ…å†µ æ²¡æœ‰runLoopæ—¶ã€‚ç¨‹åºå¯åŠ¨åå°±ä¼šé€€å‡ºï¼ˆæ‰§è¡Œåˆ°ç¬¬7è¡Œï¼‰ 12345678int main(int argc, const char *argv[])&#123; @autoreleasepool&#123; &#125; return 0;&#125; æœ‰runLoopæ—¶ï¼Œç¨‹åºå¹¶ä¸ä¼šé©¬ä¸Šé€€å‡ºï¼Œè€Œæ˜¯ä¿æŒè¿è¡ŒçŠ¶æ€ã€‚ 12345678int main(int argc, const char *argv[])&#123; @autoreleasepool&#123; return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate calss])); &#125; &#125; RunLoop çš„åŸºæœ¬ä½œç”¨ ä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œ å¤„ç†Appä¸­çš„å„ç§äº‹ä»¶ï¼ˆæ¯”å¦‚è§¦æ‘¸äº‹ä»¶ã€å®šæ—¶å™¨äº‹ä»¶ç­‰ï¼‰ èŠ‚çœCPUèµ„æºï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚æ”¹åšäº‹æ—¶åšäº‹ï¼Œè¯¥ä¼‘æ¯æ—¶ä¼‘æ¯ â€¦â€¦ RunLoop å¯¹è±¡ iOSä¸­æœ‰2å¥—APIæ¥è®¿é—®å’Œä½¿ç”¨RunLoop Foundationï¼šNSRunLoop Core Foundationï¼šCFRunLoopRef NSRunLoopå’ŒCFRunLoopReféƒ½ä»£è¡¨ç€RunLoopå¯¹è±¡ NSRunLoopæ˜¯åŸºäºCFRunLoopRefçš„ä¸€å±‚OCåŒ…è£… CFRunLoopæ˜¯å¼€æºçš„(æ³¨: å¼€æºæ¡†æ¶) RunLoopä¸çº¿ç¨‹ æ¯æ¡çº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªé¢„æ”¯å¯¹åº”çš„RunLoopå¯¹è±¡ RunLoopä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„Dictionaryé‡Œï¼Œçº¿ç¨‹ä½œä¸ºkeyï¼ŒRunLoopä½œä¸ºvalue çº¿ç¨‹åˆ›å»ºæ—¶å¹¶æ²¡æœ‰RunLoopå¯¹è±¡ï¼ŒRunLoopä¼šåœ¨ç¬¬ä¸€æ¬¡è·å–å®ƒæ—¶åˆ›å»º.(æ‡’åŠ è½½)* Runloopä¼šåœ¨çº¿ç¨‹ç»“æŸæ—¶é”€æ¯ ä¸»çº¿ç¨‹çš„RunLoopå·²ç»è‡ªåŠ¨è·å–(åˆ›å»º)ï¼Œå­çº¿ç¨‹é»˜è®¤æ²¡æœ‰å¼€å¯RunLoopã€‚ 1234567891011121314151617181920// Core Fundation æºç ï¼š CFRunLoopGetCurrent()CFRunLoopRef _CFRunLoopGet0b(pthread_t t) &#123; if (pthread_equal(t, kNilPthreadT)) &#123; t = pthread_main_thread_np(); &#125; __CFLock(&amp;loopsLock); CFRunLoopRef loop = NULL; // æ³¨æ„çœ‹è¿™é‡Œ /** å‘ç°__CFRunLoopsä¸å­˜åœ¨æ—¶ï¼š å°±ä¼šæŠŠä¼ è¿›æ¥å…ˆçº¿ç¨‹pä½œä¸ºkeyï¼ŒæŠŠåˆ›å»ºçš„RunLoopä½œä¸ºvalue å­˜åˆ°ä¸€ä¸ªRunLoopç®¡ç†å­—å…¸ä¸­ */ if (__CFRunLoops) &#123; loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t)); &#125; __CFUnlock(&amp;loopsLock); return loop;&#125; è·å–RunLoopå¯¹è±¡ Foundation 12[NSRunLoop currentRunLoop]; // è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡[NSRunLoop mainRunLoop]; // è·å–ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡ Core Foundation 123CFRunLoopGetCurrent(); // è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡CFRunLoopGetMain(); // è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡ RunLoopçš„ç»“æ„åŠç›¸å…³ç±»1234567891011121314151617181920212223struct __CFRunLoop &#123; pthread_t _pthread; uint32_t _winthread; CFRuntimeBase _base; pthread_mutex_t _lock; /* locked for accessing mode list */ __CFPort _wakeUpPort; // used for CFRunLoopWakeUp Boolean _unused; volatile _per_run_data *_perRunData; // reset for runs of the run loop CFMutableSetRef _commonModes; CFMutableSetRef _commonModeItems; CFRunLoopModeRef _currentMode; CFMutableSetRef _modes; struct _block_item *_blocks_head; struct _block_item *_blocks_tail; CFAbsoluteTime _runTime; CFAbsoluteTime _sleepTime; CFTypeRef _counterpart;&#125;;","categories":[],"tags":[]},{"title":"éŸ³è§†é¢‘","slug":"éŸ³è§†é¢‘","date":"2018-07-21T07:06:09.000Z","updated":"2018-09-12T09:05:17.684Z","comments":true,"path":"2018/07/21/éŸ³è§†é¢‘/","link":"","permalink":"http://PGGMan.github.io/2018/07/21/éŸ³è§†é¢‘/","excerpt":"","text":"éŸ³è§†é¢‘ ç›´æ’­ ç›´æ’­æµç¨‹ï¼šé‡‡é›†ã€å¤„ç†ã€ç¼–ç ã€æ¨æµã€æµåˆ†å‘ã€æ’­æ”¾ã€‚ éŸ³è§†é¢‘é‡‡é›† éŸ³è§†é¢‘çš„é‡‡é›†æ˜¯ç›´æ’­æ¶æ„çš„ç¬¬ä¸€ä¸ªç¯èŠ‚ã€ä¹Ÿæ˜¯ç›´æ’­çš„è§†é¢‘æ¥æº é‡‡é›†çš„æ¥æºåŒ…æ‹¬ï¼› PCç«¯ï¼šå±å¹•æ‘„åƒå¤´ï¼ˆæ‘„åƒå¤´é©±åŠ¨é€‚é…ï¼‰ iOSç«¯ï¼šæ‘„åƒå¤´é‡‡é›†ï¼ˆå‰åæ‘„åƒå¤´é‡‡é›†ï¼‰ Androidç«¯ï¼šå±å¹•æ‘„åƒå¤´é‡‡é›†ï¼ˆç¡¬ä»¶è¿‡å¤šï¼Œé€‚é…ä¸€å †å‘ï¼‰ å‰å¤„ç† å¤„ç†ä¸»è¦åŒ…æ‹¬: ç¾é¢œã€æ¨¡ç³Šæ•ˆæœã€æ°´å°ç­‰ å„ä¸ªå¹³å°å¤„ç†æ–¹æ³• PCç«¯ï¼šç¾é¢œé•œå¤´ã€ä¸€äº›ç¾é¢œè½¯ä»¶ iOSç«¯ï¼šå›¾åƒå¤„ç†åº“æ˜¯GPUImageï¼Œæä¾›äº†ä¸°å¯Œçš„é¢„å¤„ç†æ•ˆæœï¼Œä¹Ÿå¯åˆ©ç”¨è¯¥åº“è‡ªå®šä¹‰è®¾è®¡ Androidç«¯ï¼šGoogleå¼€æºçš„grafikaï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å›¾å½¢å¤„ç†åº“ ç¼–ç  æ²¡ç»è¿‡ç¼–ç çš„è§†é¢‘éå¸¸åºå¤§ï¼Œå­˜å‚¨èµ·æ¥éƒ½éº»çƒ¦ï¼Œæ›´ä½•å†µç½‘ç»œä¼ è¾“ ç¼–ç é€šè¿‡å‹ç¼©éŸ³è§†é¢‘æ•°æ®æ¥å‡å°‘ä½“ç§¯ï¼Œæ–¹ä¾¿éŸ³è§†é¢‘æ•°æ®çš„æ¨æµã€æ‹‰æµå’Œå­˜å‚¨ï¼Œèƒ½å¤§å¤§æé«˜å­˜å‚¨å’Œä¼ è¾“æ•ˆç‡ éŸ³è§†é¢‘å¿…é¡»ç»è¿‡å‹ç¼©ç¼–ç æ‰èƒ½è¿›è¡Œå­˜å‚¨å’Œä¼ è¾“ å„ä¸ªå¹³å°å¤„ç†ï¼š iOSç«¯ï¼šç¡¬ä»¶æ€§èƒ½å¥½ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œç¡¬ç¼–ç  Androidç«¯ï¼šç¡¬ç¼–ç è¾ƒéš¾ï¼Œéš¾æ‰¾åˆ°åŒä¸€çš„åº“å…¼å®¹å„ä¸ªå¹³å°ï¼ˆæ¨èä½¿ç”¨è½¯ç¼–ç ï¼‰ ç¼–ç æ ‡ç –ï¼š è§†é¢‘ç¼–ç ï¼šH.265ã€H.264ã€VP8ã€VP9ç­‰ éŸ³é¢‘ç¼–ç ï¼šAACï¼ˆé«˜çº§éŸ³é¢‘ç¼–ç ï¼Œç›®çš„æ˜¯å–ä»£MP3æ ¼å¼ï¼‰ã€Opus ä¼ è¾“ ä»æ¨æµç«¯åˆ°æœåŠ¡ç«¯ æ•°æ®ç»è¿‡æ¨æµç«¯é‡‡é›†å’Œé¢„å¤„ç†ï¼Œç¼–ç ä¹‹åæ¨æµåˆ°æœåŠ¡ç«¯ æµä¼ è¾“å°±æ¶‰åŠåˆ°ç›¸åº”çš„ä¼ è¾“åè®®ï¼Œæœ€å¸¸ç”¨çš„åè®®æ˜¯RTMPã€RTSPã€HLSã€ æµåˆ†å‘ éŸ³é¢‘æµæ¨åˆ°æœåŠ¡å™¨åï¼Œä¸ºäº†é€‚é…å„ä¸ªå¹³å°ç«¯å„ç§ä¸åŒåè®®ï¼Œéœ€è¦åœ¨æœåŠ¡ç«¯åšä¸€äº›æµå¤„ç†å·¥ä½œã€‚æ¯”å¦‚è½¬ç æˆä¸åŒæ ¼å¼æ”¯æŒä¸åŒåè®®å¦‚RTMPã€HLSã€FLVã€‚ä»¥é€‚åº”å„ä¸ªå¹³å°ã€‚ æ¯”å¦‚ï¼šiOSã€Androidã€PCã€ç½‘é¡µ æ’­æ”¾ æ‹‰æµè·å–éŸ³è§†é¢‘æ•°æ®åï¼Œéœ€è¦é€šè¿‡è§£ç å™¨è§£ç ï¼Œæ¸²æŸ“æ‰èƒ½åœ¨æ’­æ”¾å™¨ä¸Šæ’­æ”¾ã€‚ æ€»ä½“æ­¥éª¤æ¦‚è§ˆï¼š è§£åè®®ï¼šå»é™¤ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ä¸€äº›æ— ç”¨ä¿¡æ¯ è§£å°è£…ï¼šè·å–åˆ°çš„æ˜¯éŸ³é¢‘&amp;è§†é¢‘æ”¾åœ¨ä¸€èµ·çš„å°è£…æ–‡ä»¶ éŸ³è§†é¢‘è§£ç ï¼šéŸ³è§†é¢‘éƒ½æ˜¯ç»è¿‡å‹ç¼©ç¼–ç çš„å†…å®¹ï¼Œè§£ç åæ‰èƒ½è¿›è¡Œæ’­æ”¾ éŸ³è§†é¢‘åŒæ­¥ï¼šè§†é¢‘&amp;éŸ³é¢‘æ–‡ä»¶éœ€è¦åŒæ­¥æ’­æ”¾ éŸ³è§†é¢‘æ’­æ”¾ï¼šå£°å¡&amp;æ˜¾å¡ç­‰å¯¹éŸ³è§†é¢‘è¿›è¡Œæ’­æ”¾ã€‚ é‡‡é›†éŸ³è§†é¢‘ éŸ³è§†é¢‘é‡‡é›†æ˜¯ç›´æ’­æ¶æ„çš„ç¬¬ä¸€ç¯èŠ‚ï¼Œæ˜¯è§†é¢‘çš„æ¥æº, æ¡†æ¶ä¸»è¦æ˜¯AVFoundationå’ŒCoreMedia,åŒ…æ‹¬è§†é¢‘è¾“å‡ºã€è¾“å…¥å’Œæ–‡ä»¶çš„è¯»å†™ å…¶å®è§†é¢‘çš„é‡‡é›†æœ‰å¤šä¸ªåº”ç”¨åœºæ™¯ï¼šæ¯”å¦‚äºŒç»´ç å¼€å‘ã€ç›´æ’­ éŸ³è§†é¢‘é‡‡é›†åŒ…æ‹¬ä¸¤éƒ¨åˆ† è§†é¢‘é‡‡é›† éŸ³é¢‘é‡‡é›† åœ¨iOSå¼€å‘ä¸­ï¼Œæ˜¯å¯ä»¥åŒæ­¥é‡‡é›†è§†é¢‘&amp;éŸ³é¢‘çš„ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿéå¸¸ç®€å• ç›¸å…³çš„é‡‡é›†APIéƒ½å°è£…åœ¨AVFoundationæ¡†æ¶ä¸­ï¼Œå¯¼å…¥å¯¹åº”æ¡†æ¶ï¼Œå®ç°åŠŸèƒ½å³å¯ ä¸»è¦API AVCaptureSessionï¼šå›è¯ AVCaptureDeviceï¼š è®¾å¤‡ AVCaptureDeviceInput: è¾“å…¥è®¾å¤‡ AVCaptureVideoDataOutputï¼šè§†é¢‘è¾“å‡ºè®¾å¤‡ AVCaptureAudioDataOutputï¼šéŸ³é¢‘è¾“å‡ºè®¾å¤‡ AVCaptureConnectionï¼šè¾“å…¥ä¸è¾“å‡ºæ¡¥æ¥ AVAssetWriterï¼šæ•°æ®å†™å…¥å·¥å…·ç±» AVAssetWriterInputï¼š AVCaptureVideoPreviewLayerï¼šé¢„è§ˆè§†å›¾ AVCaptureSession AVCaptureSessionæ˜¯AVFoundationæ•æ‰ç±»çš„ä¸­å¿ƒæ¢çº½ï¼Œåœ¨è§†é¢‘æ•è·æ—¶,å®¢æˆ·ç«¯å¯ä»¥å®ä¾‹åŒ–AVCaptureSessionå¹¶æ·»åŠ é€‚å½“çš„AVCaptureInputsã€AVCaptureDeviceInputå’Œè¾“å‡ºï¼Œæ¯”å¦‚AVCaptureMovieFileOutputã€‚é€šè¿‡[AVCaptureSession startRunning]å¼€å§‹æ•°æ®æµä»è¾“å…¥åˆ°è¾“å‡º,å’Œ[AVCaptureSession stopRunning]åœæ­¢è¾“å‡ºè¾“å…¥çš„æµåŠ¨ã€‚å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è®¾ç½®sessionPresetå±æ€§å®šåˆ¶å½•åˆ¶è´¨é‡æ°´å¹³æˆ–è¾“å‡ºçš„åˆ†è¾¨ç‡ã€‚ 12345678910111213- (AVCaptureSession *)addCaptureSession&#123; AVCaptureSession *session = [[AVCaptureSession alloc] init]; /** AVCaptureSessionPresetHigh : [é»˜è®¤å€¼] é«˜åˆ†è¾¨ç‡ï¼Œä¼šæ ¹æ®å½“å‰è®¾å¤‡è¿›è¡Œè‡ªé€‚åº” */ session.sessionPreset = AVCaptureSessionPresetHigh; _session = session; return session;&#125; AVCaptureDevice AVCaptureDeviceçš„æ¯ä¸ªå®ä¾‹å¯¹åº”ä¸€ä¸ªè®¾å¤‡ï¼Œå¦‚æ‘„åƒå¤´æˆ–éº¦å…‹é£ã€‚AVCaptureDeviceçš„å®ä¾‹ä¸èƒ½ç›´æ¥åˆ›å»ºã€‚æ‰€æœ‰ç°æœ‰è®¾å¤‡å¯ä»¥ä½¿ç”¨ç±»æ–¹æ³•devicesWithMediaType:defaultDeviceWithMediaType:è·å–ï¼Œè®¾å¤‡å¯ä»¥æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªç»™å®šæµåª’ä½“ç±»å‹ã€‚AVCaptureDeviceå®ä¾‹å¯ç”¨äºæä¾›ç»™AVCaptureSessionåˆ›å»ºä¸€ä¸ªä¸ºAVCaptureDeviceInputç±»å‹çš„è¾“å…¥æºã€‚ 1234567891011121314151617181920212223242526272829303132- (AVCaptureDevice *)addCaptureDevice:(AVCaptureSession *)session&#123; //2 åˆ›å»ºDevice AVCaptureDevice *device = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo]; if ([device lockForConfiguration:nil]) &#123; //è‡ªåŠ¨é—ªå…‰ç¯ï¼Œ if ([device isFlashModeSupported:AVCaptureFlashModeAuto]) &#123; [device setFlashMode:AVCaptureFlashModeAuto]; &#125; // å¸§ç‡ 1ç§’10å¸§ device.activeVideoMinFrameDuration = CMTimeMake(1, 10); //è‡ªåŠ¨ç™½å¹³è¡¡, if ([device isWhiteBalanceModeSupported:AVCaptureWhiteBalanceModeContinuousAutoWhiteBalance]) &#123; [device setWhiteBalanceMode:AVCaptureWhiteBalanceModeContinuousAutoWhiteBalance]; &#125; [device unlockForConfiguration]; &#125; /** AVMediaTypeVideo: æ‘„åƒå¤´, AVMediaTypeAudio: è¯ç­’, AVMediaTypeMuxed: å¼¹å¹•, AVMediaTypeSubtitle: å­—å¹•, AVMediaTypeTimecode */ return device;&#125; AVCaptureDeviceInput AVCaptureDeviceInput æ˜¯AVCaptureSessionè¾“å…¥æº,æä¾›åª’ä½“æ•°æ®ä»è®¾å¤‡è¿æ¥åˆ°ç³»ç»Ÿï¼Œé€šè¿‡AVCaptureDeviceçš„å®ä¾‹åŒ–å¾—åˆ°ï¼Œå°±æ˜¯æˆ‘ä»¬å°†è¦ç”¨åˆ°çš„è®¾å¤‡è¾“å‡ºæºè®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯å‰åæ‘„åƒå¤´ï¼Œé€šè¿‡[AVCaptureDevice devicesWithMediaType:AVMediaTypeVideo]æ–¹æ³•è·å¾—ã€‚ 1234567891011121314- (void)addCaptureDeviceInput:(AVCaptureDevice *)device&#123; //3 åˆ›å»ºè¾“å…¥æºå¹¶æ·»åŠ åˆ°å›è¯ä¸­ NSError *error; AVCaptureDeviceInput *input = [AVCaptureDeviceInput deviceInputWithDevice:device error:&amp;error]; if(input) &#123; [_session addInput:input]; &#125; else &#123; NSLog(@\"%@\", error); return; &#125;&#125; AVCaptureMovieFileOutput AVCaptureMovieFileOutputæ˜¯AVCaptureFileOutputçš„å­ç±»ï¼Œç”¨æ¥å†™å…¥QuickTimeè§†é¢‘ç±»å‹çš„åª’ä½“æ–‡ä»¶ã€‚å› ä¸ºè¿™ä¸ªç±»åœ¨iphoneä¸Šå¹¶ä¸èƒ½å®ç°æš‚åœå½•åˆ¶ï¼Œå’Œä¸èƒ½å®šä¹‰è§†é¢‘æ–‡ä»¶çš„ç±»å‹ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå¹¶ä¸ä½¿ç”¨ï¼Œè€Œæ˜¯ç”¨çµæ´»æ€§æ›´å¼ºçš„AVCaptureVideoDataOutputå’ŒAVCaptureAudioDataOutputæ¥å®ç°è§†é¢‘çš„å½•åˆ¶ã€‚ AVCaptureVideoDataOutput AVCaptureVideoDataOutputæ˜¯AVCaptureOutputä¸€ä¸ªå­ç±»ï¼Œå¯ä»¥ç”¨äºç”¨æ¥è¾“å‡ºæœªå‹ç¼©æˆ–å‹ç¼©çš„è§†é¢‘æ•è·çš„å¸§ï¼ŒAVCaptureVideoDataOutputäº§ç”Ÿçš„å®ä¾‹å¯ä»¥ä½¿ç”¨å…¶ä»–åª’ä½“è§†é¢‘å¸§é€‚åˆçš„apiå¤„ç†ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç”¨captureOutput:didOutputSampleBuffer:fromConnection:ä»£ç†æ–¹æ³•æ¥è·å–å¸§æ•°æ®ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445- (void)addCaptureDeviceOutput:(AVCaptureDevice *)device&#123; //4 åˆ›å»ºè¾“å‡ºæºå¹¶æ·»åŠ åˆ°å›è¯ä¸­ //output AVCaptureVideoDataOutput *output = [[AVCaptureVideoDataOutput alloc] init]; [_session addOutput:output]; //4.1 è®¾ç½®è¾“å‡ºä»£ç† [output setSampleBufferDelegate:self queue:dispatch_queue_create(\"LinXunFengSerialQueue\", DISPATCH_QUEUE_SERIAL)]; //4.2 è¾“å‡ºä¿¡æ¯è®¾ç½® // kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange è¾“å‡ºæ ¼å¼å’ŒèŒƒå›´ // kCVPixelBufferPixelFormatTypeKey æŒ‡å®šåƒç´ è¾“å‡ºæ ¼å¼ NSDictionary* setcapSettings = [NSDictionary dictionaryWithObjectsAndKeys: [NSNumber numberWithInt:kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange], kCVPixelBufferPixelFormatTypeKey, nil]; output.videoSettings = setcapSettings; //4.2 è·å–è¾“å…¥ä¸è¾“å‡ºä¹‹é—´çš„è¿æ¥ è®¾ç½® [self setConnection:output]; &#125;// ä»£ç† è·å¾—çš„æ˜¯CGImage/** CMSampleBufferRef: å¸§ç¼“å­˜æ•°æ®ï¼Œæè¿°å½“å‰å¸§ä¿¡æ¯ è·å–å¸§ç¼“å­˜ä¿¡æ¯ : CMSampleBufferGet CMSampleBufferGetDuration : è·å–å½“å‰å¸§æ’­æ”¾æ—¶é—´ CMSampleBufferGetImageBuffer : è·å–å½“å‰å¸§å›¾ç‰‡ä¿¡æ¯ */// CoreImage: åº•å±‚ç»˜åˆ¶å›¾ç‰‡// è·å–å¸§æ•°æ®- (void)captureOutput:(AVCaptureOutput *)output didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection *)connection &#123; // captureSession ä¼šè¯å¦‚æœæ²¡æœ‰å¼ºå¼•ç”¨ï¼Œè¿™é‡Œä¸ä¼šå¾—åˆ°æ‰§è¡Œ // è·å–å›¾ç‰‡å¸§æ•°æ® CVImageBufferRef imageBuffer = CMSampleBufferGetImageBuffer(sampleBuffer); CIImage *ciImage = [CIImage imageWithCVImageBuffer:imageBuffer]; UIImage *image = [UIImage imageWithCIImage:ciImage]; dispatch_async(dispatch_get_main_queue(), ^&#123; self.imageView.image = image; &#125;);&#125; AVCaptureAudioDataOutput AVCaptureAudioDataOutputæ˜¯AVCaptureOutputçš„å­ç±»ï¼Œå¯ç”¨äºç”¨æ¥è¾“å‡ºæ•è·æ¥çš„éå‹ç¼©æˆ–å‹ç¼©çš„éŸ³é¢‘æ ·æœ¬ï¼ŒAVCaptureAudioDataOutputäº§ç”Ÿçš„å®ä¾‹å¯ä»¥ä½¿ç”¨å…¶ä»–åª’ä½“è§†é¢‘å¸§é€‚åˆçš„apiå¤„ç†ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç”¨captureOutput:didOutputSampleBuffer:fromConnection:ä»£ç†æ–¹æ³•æ¥è·å–éŸ³é¢‘æ•°æ®ã€‚ 123456789- (AVCaptureAudioDataOutput *)audioOutput &#123; if (_audioOutput == nil) &#123; _audioOutput = [[AVCaptureAudioDataOutput alloc] init]; [_audioOutput setSampleBufferDelegate:self queue:self.captureQueue]; &#125; return _audioOutput;&#125;// ä»£ç†å¦‚ä¸Š AVCaptureVideoDataOutput AVCaptureConnection AVCaptureConnectionä»£è¡¨AVCaptureInputPortæˆ–ç«¯å£ä¹‹é—´çš„è¿æ¥ï¼Œå’Œä¸€ä¸ªAVCaptureOutputæˆ–AVCaptureVideoPreviewLayeråœ¨AVCaptureSessionä¸­çš„å‘ˆç°ã€‚ 123456789// æ³¨æ„ï¼š ä¸€å®šè¦åœ¨æ·»åŠ ä¹‹å // è·å–è¾“å…¥ä¸è¾“å‡ºä¹‹é—´çš„è¿æ¥ AVCaptureConnection *connection = [output connectionWithMediaType:AVMediaTypeVideo]; // è®¾ç½®é‡‡é›†æ•°æ®çš„æ–¹å‘ã€é•œåƒ connection.videoOrientation = AVCaptureVideoOrientationPortrait; //connection.videoMirrored = YES; AVCaptureVideoPreviewLayer æ˜¯CoreAnimationé‡Œé¢layerçš„ä¸€ä¸ªå­ç±»ï¼Œç”¨æ¥åšä¸ºAVCaptureSessioné¢„è§ˆè§†é¢‘è¾“å‡ºï¼Œç®€å•æ¥è¯´å°±æ˜¯æ¥åšä¸ºæ‹æ‘„çš„è§†é¢‘å‘ˆç°çš„ä¸€ä¸ªlayerã€‚ 12345678910- (AVCaptureVideoPreviewLayer *)previewLayer &#123; if (_previewLayer == nil) &#123; AVCaptureVideoPreviewLayer *preview = [[AVCaptureVideoPreviewLayer alloc] initWithSession:self.session]; preview.videoGravity = AVLayerVideoGravityResizeAspectFill; _previewLayer = preview; &#125; return _previewLayer;&#125; AVAssetWriter AVAssetWriterä¸ºå†™å…¥åª’ä½“æ•°æ®åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶æä¾›æœåŠ¡ï¼ŒAVAssetWriterçš„å®ä¾‹å¯ä»¥è§„å®šå†™å…¥åª’ä½“æ–‡ä»¶çš„æ ¼å¼ï¼Œå¦‚QuickTimeç”µå½±æ–‡ä»¶æ ¼å¼æˆ–MPEG-4æ–‡ä»¶æ ¼å¼ç­‰ç­‰ã€‚AVAssetWriteræœ‰å¤šä¸ªå¹¶è¡Œçš„è½¨é“åª’ä½“æ•°æ®ï¼ŒåŸºæœ¬çš„æœ‰è§†é¢‘è½¨é“å’ŒéŸ³é¢‘è½¨é“ï¼Œå°†ä¼šåœ¨ä¸‹é¢ä»‹ç»ã€‚AVAssetWriterçš„å•ä¸ªå®ä¾‹å¯ç”¨äºä¸€æ¬¡å†™å…¥ä¸€ä¸ªå•ä¸€çš„æ–‡ä»¶ã€‚é‚£äº›å¸Œæœ›å†™å…¥å¤šæ¬¡æ–‡ä»¶çš„å®¢æˆ·ç«¯å¿…é¡»æ¯ä¸€æ¬¡ç”¨ä¸€ä¸ªæ–°çš„AVAssetWriterå®ä¾‹ã€‚ 12345678910111213141516171819202122- (instancetype)initPath:(NSString*)path Height:(NSInteger)cy width:(NSInteger)cx channels:(int)ch samples:(Float64) rate &#123; self = [super init]; if (self) &#123; self.path = path; [[NSFileManager defaultManager] removeItemAtPath:self.path error:nil]; NSURL* url = [NSURL fileURLWithPath:self.path]; _writer = [AVAssetWriter assetWriterWithURL:url fileType:AVFileTypeMPEG4 error:nil]; _writer.shouldOptimizeForNetworkUse = YES; [self initVideoInputHeight:cy width:cx]; if (rate != 0 &amp;&amp; ch != 0) &#123; [self initAudioInputChannels:ch samples:rate]; &#125; &#125; return self;&#125; AVAssetWriterInput ç”¨AVAssetWriterInputå»æ‹¼æ¥ä¸€ä¸ªå¤šåª’ä½“æ ·æœ¬ç±»å‹ä¸ºCMSampleBuffer(outoutä»£ç†æä¾›çš„ç±»å‹)çš„å®ä¾‹åˆ°AVAssetWriterå¯¹è±¡çš„è¾“å‡ºæ–‡ä»¶çš„ä¸€ä¸ªè½¨é“ï¼›å½“æœ‰å¤šä¸ªè¾“å…¥æ—¶ï¼Œ AVAssetWriterè¯•å›¾åœ¨ç”¨äºå­˜å‚¨å’Œæ’­æ”¾æ•ˆç‡çš„ç†æƒ³æ¨¡å¼å†™åª’ä½“æ•°æ®ã€‚å®ƒçš„æ¯ä¸€ä¸ªè¾“å…¥ä¿¡å·ï¼Œæ˜¯å¦èƒ½æ¥å—åª’ä½“çš„æ•°æ®æ ¹æ®é€šè¿‡readyForMoreMediaDataçš„å€¼æ¥åˆ¤æ–­ã€‚å¦‚æœreadyForMoreMediaDataæ˜¯YES ï¼Œè¯´æ˜è¾“å…¥å¯ä»¥æ¥å—åª’ä½“æ•°æ®ã€‚å¹¶ä¸”ä½ åªèƒ½åª’ä½“æ•°æ®è¿½åŠ åˆ°è¾“å…¥ç«¯ã€‚ 123456789101112131415161718192021222324252627282930313233- (void)initVideoInputHeight:(NSInteger)cy width:(NSInteger)cx &#123; NSDictionary* settings = [NSDictionary dictionaryWithObjectsAndKeys: AVVideoCodecH264, AVVideoCodecKey, [NSNumber numberWithInteger: cx], AVVideoWidthKey, [NSNumber numberWithInteger: cy], AVVideoHeightKey, nil]; _videoInput = [AVAssetWriterInput assetWriterInputWithMediaType:AVMediaTypeVideo outputSettings:settings]; _videoInput.expectsMediaDataInRealTime = YES; [_writer addInput:_videoInput];&#125;- (void)initAudioInputChannels:(int)ch samples:(Float64)rate &#123; NSDictionary *settings = [NSDictionary dictionaryWithObjectsAndKeys: [ NSNumber numberWithInt: kAudioFormatMPEG4AAC], AVFormatIDKey, [ NSNumber numberWithInt: ch], AVNumberOfChannelsKey, [ NSNumber numberWithFloat: rate], AVSampleRateKey, [ NSNumber numberWithInt: 128000], AVEncoderBitRateKey, nil]; _audioInput = [AVAssetWriterInput assetWriterInputWithMediaType:AVMediaTypeAudio outputSettings:settings]; _audioInput.expectsMediaDataInRealTime = YES; [_writer addInput:_audioInput];&#125; é‡‡é›†æ­¥éª¤ PSï¼šå¦‚æœåšè¿‡äºŒç»´ç å¼€å‘ã€åº”è¯¥å¯¹ç›¸å…³æ“ä½œéå¸¸æ•°æ®ï¼ˆéå¸¸ç±»ä¼¼ï¼‰ å¯¼å…¥æ¡†æ¶ ç›¸å…³APIä¸»è¦åœ¨AVFoundationæ¡†æ¶ä¸­ï¼Œå› æ­¤éœ€è¦å…ˆå¯¼å…¥æ¡†æ¶ åˆ›å»ºæ•æ‰å›è¯ (AVCaptureSession) è¯¥å›è¯é€‚ç”¨äºè¿æ¥ä¹‹åçš„è¾“å…¥æº&amp;è¾“å‡ºæº è¾“å…¥æºï¼šæ‘„åƒå¤´&amp;è¯ç­’ è¾“å‡ºæºï¼šæ‹¿åˆ°å¯¹åº”çš„éŸ³é¢‘&amp;è§†é¢‘ å›è¯ï¼šç”¨äºå°†è¾“å…¥æº&amp;è¾“å‡ºæºè¿æ¥èµ·æ¥ è®¾ç½®è§†é¢‘è¾“å…¥æº&amp;è¾“å‡ºæº è¾“å…¥æºï¼šï¼ˆAVCaptureDeviceInputï¼‰ï¼šä»æ‘„åƒå¤´è¾“å…¥ è¾“å‡ºæºï¼š(AVCaptureAudioDataOutputï¼‰ï¼šå¯ä»¥è®¾ç½®ä»£ç†ï¼Œåœ¨ä»£ç†æ–¹æ³•ä¸­æ‹¿åˆ°æ•°æ® å°†è¾“å…¥&amp;è¾“å‡ºæ·»åŠ åˆ°å›è¯ä¸­ æ·»åŠ é¢„è§ˆå›¾å±‚ (AVCaptureVideoPreviewLayer)ï¼ˆå¯é€‰ï¼‰ å¦‚æœå¸Œæœ›ç”¨æˆ·çœ‹åˆ°é‡‡é›†çš„ç”»é¢ï¼Œå¯ä»¥æ·»åŠ é¢„è§ˆå›¾å±‚ è¯¥é¢„è§ˆå›¾å±‚ä¸æ˜¯å¿…é¡»çš„ï¼Œå³ä½¿æ²¡æœ‰æ·»åŠ ä¹Ÿå¯ä»¥æ­£å¸¸é‡‡é›†æ•°æ®ã€‚ å¼€å§‹é‡‡é›†å³å¯ è°ƒç”¨ä¼šè¯ï¼ˆAVCaptureSessionï¼‰çš„startRunningæ–¹æ³•å³å¯å¼€å§‹é‡‡é›†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192// ViewController.m// VideoDemo//// Created by å°åº¦é˜¿ä¸‰ on 2018/7/23.// Copyright Â© 2018å¹´ å°åº¦é˜¿ä¸‰. All rights reserved.//#import \"ViewController.h\"#import &lt;AVFoundation/AVFoundation.h&gt;@interface ViewController ()&lt;AVCaptureVideoDataOutputSampleBufferDelegate&gt;/** å¿…é¡»è¿›è¡Œå¼ºå¼•ç”¨*/@property (nonatomic ,strong) AVCaptureSession *session;@property (nonatomic ,weak) AVCaptureVideoPreviewLayer *previewLayer;@property (nonatomic ,weak) UIImageView *imageView;@end@implementation ViewController- (UIImageView *)imageView&#123; if (!_imageView) &#123; UIImageView *imageView = [[UIImageView alloc] initWithFrame:self.view.bounds]; [self.view addSubview:imageView]; _imageView = imageView; &#125; return _imageView;&#125;- (void)viewDidLoad &#123; [super viewDidLoad]; //1 åˆ›å»ºå›è¯ AVCaptureSession *session = [self addCaptureSession]; //2 è·å–éŸ³è§†é¢‘è®¾å¤‡ AVCaptureDevice *device = [self addCaptureDevice:session]; //3 è¾“å…¥è®¾å¤‡ [self addCaptureDeviceInput:device]; //4 è¾“å‡ºè®¾å¤‡ [self addCaptureDeviceOutput:device]; //start [session startRunning]; &#125;- (AVCaptureSession *)addCaptureSession&#123; AVCaptureSession *session = [[AVCaptureSession alloc] init]; /** AVCaptureSessionPresetHigh : [é»˜è®¤å€¼] é«˜åˆ†è¾¨ç‡ï¼Œä¼šæ ¹æ®å½“å‰è®¾å¤‡è¿›è¡Œè‡ªé€‚åº” */ session.sessionPreset = AVCaptureSessionPresetHigh; _session = session; return session;&#125;- (AVCaptureDevice *)addCaptureDevice:(AVCaptureSession *)session&#123; //2 åˆ›å»ºDevice AVCaptureDevice *device = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo]; if ([device lockForConfiguration:nil]) &#123; //è‡ªåŠ¨é—ªå…‰ç¯ï¼Œ if ([device isFlashModeSupported:AVCaptureFlashModeAuto]) &#123; [device setFlashMode:AVCaptureFlashModeAuto]; &#125; // å¸§ç‡ 1ç§’10å¸§ device.activeVideoMinFrameDuration = CMTimeMake(1, 10); //è‡ªåŠ¨ç™½å¹³è¡¡, if ([device isWhiteBalanceModeSupported:AVCaptureWhiteBalanceModeContinuousAutoWhiteBalance]) &#123; [device setWhiteBalanceMode:AVCaptureWhiteBalanceModeContinuousAutoWhiteBalance]; &#125; [device unlockForConfiguration]; &#125; return device;&#125;- (void)addCaptureDeviceInput:(AVCaptureDevice *)device&#123; //3 åˆ›å»ºè¾“å…¥æºå¹¶æ·»åŠ åˆ°å›è¯ä¸­ NSError *error; AVCaptureDeviceInput *input = [AVCaptureDeviceInput deviceInputWithDevice:device error:&amp;error]; if(input) &#123; [_session addInput:input]; &#125; else &#123; NSLog(@\"%@\", error); return; &#125;&#125;- (void)addCaptureDeviceOutput:(AVCaptureDevice *)device&#123; //4 åˆ›å»ºè¾“å‡ºæºå¹¶æ·»åŠ åˆ°å›è¯ä¸­ //output AVCaptureVideoDataOutput *output = [[AVCaptureVideoDataOutput alloc] init]; [_session addOutput:output]; //4.1 è®¾ç½®è¾“å‡ºä»£ç† dispatch_queue_t queue = dispatch_queue_create(\"LinXunFengSerialQueue\", DISPATCH_QUEUE_SERIAL); [output setSampleBufferDelegate:self queue:queue]; //4.2 è¾“å‡ºä¿¡æ¯è®¾ç½® // kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange è¾“å‡ºæ ¼å¼å’ŒèŒƒå›´ // kCVPixelBufferPixelFormatTypeKey æŒ‡å®šåƒç´ è¾“å‡ºæ ¼å¼ NSDictionary* setcapSettings = [NSDictionary dictionaryWithObjectsAndKeys: [NSNumber numberWithInt:kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange], kCVPixelBufferPixelFormatTypeKey, nil]; output.videoSettings = setcapSettings; //4.2 è·å–è¾“å…¥ä¸è¾“å‡ºä¹‹é—´çš„è¿æ¥ è®¾ç½® [self setConnection:output]; &#125;-(void)setConnection:(AVCaptureVideoDataOutput *)output&#123; // æ¡¥æ¥ AVCaptureConnection *connection = [output connectionWithMediaType:AVMediaTypeVideo]; connection.videoOrientation = AVCaptureVideoOrientationPortrait;&#125;- (void)addPreviewLayer&#123; // é¢„è§ˆlayer AVCaptureVideoPreviewLayer *previewLayer = [AVCaptureVideoPreviewLayer layerWithSession:self.session]; [self.view.layer addSublayer:previewLayer]; _previewLayer = previewLayer; &#125;// ä»£ç†- (void)captureOutput:(AVCaptureOutput *)output didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection *)connection &#123; // captureSession ä¼šè¯å¦‚æœæ²¡æœ‰å¼ºå¼•ç”¨ï¼Œè¿™é‡Œä¸ä¼šå¾—åˆ°æ‰§è¡Œ // è·å–å›¾ç‰‡å¸§æ•°æ® // ä¸ºåª’ä½“æ•°æ®è®¾ç½®ä¸€ä¸ªCMSampleBufferçš„Core Videoå›¾åƒç¼“å­˜å¯¹è±¡ CVImageBufferRef imageBuffer = CMSampleBufferGetImageBuffer(sampleBuffer); UIImage *image; if (@available(iOS 9.0, *)) &#123; CIImage *ciImage = [CIImage imageWithCVImageBuffer:imageBuffer]; image = [UIImage imageWithCIImage:ciImage]; &#125; else &#123; image = [self imageFromSampleBuffer:imageBuffer]; &#125; dispatch_async(dispatch_get_main_queue(), ^&#123; self.imageView.image = image; &#125;);&#125;// iOS9.0 å›¾ç‰‡å¤„ç†-(UIImage *)imageFromSampleBuffer:(CVImageBufferRef)imageBuffer&#123; // é”å®špixel bufferçš„åŸºåœ°å€ CVPixelBufferLockBaseAddress(imageBuffer, 0); // å¾—åˆ°pixel bufferçš„åŸºåœ°å€ void *baseAddress = CVPixelBufferGetBaseAddress(imageBuffer); // å¾—åˆ°pixel bufferçš„è¡Œå­—èŠ‚æ•° size_t bytesPerRow = CVPixelBufferGetBytesPerRow(imageBuffer); // å¾—åˆ°pixel bufferçš„å®½å’Œé«˜ size_t width = CVPixelBufferGetWidth(imageBuffer); size_t height = CVPixelBufferGetHeight(imageBuffer); // åˆ›å»ºä¸€ä¸ªä¾èµ–äºè®¾å¤‡çš„RGBé¢œè‰²ç©ºé—´ CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB(); // ç”¨æŠ½æ ·ç¼“å­˜çš„æ•°æ®åˆ›å»ºä¸€ä¸ªä½å›¾æ ¼å¼çš„å›¾å½¢ä¸Šä¸‹æ–‡ï¼ˆgraphics contextï¼‰å¯¹è±¡ CGContextRef context = CGBitmapContextCreate(baseAddress, width, height, 8, bytesPerRow, colorSpace, kCGBitmapByteOrder32Little | kCGImageAlphaPremultipliedFirst); // æ ¹æ®è¿™ä¸ªä½å›¾contextä¸­çš„åƒç´ æ•°æ®åˆ›å»ºä¸€ä¸ªQuartz imageå¯¹è±¡ CGImageRef quartzImage = CGBitmapContextCreateImage(context); // è§£é”pixel buffer CVPixelBufferUnlockBaseAddress(imageBuffer,0); // é‡Šæ”¾contextå’Œé¢œè‰²ç©ºé—´ CGContextRelease(context); CGColorSpaceRelease(colorSpace); // ç”¨Quartz imageåˆ›å»ºä¸€ä¸ªUIImageå¯¹è±¡image UIImage *image = [UIImage imageWithCGImage:quartzImage scale:1 orientation:UIImageOrientationUp]; // é‡Šæ”¾Quartz imageå¯¹è±¡ CGImageRelease(quartzImage); return (image);&#125;- (void)dealloc&#123; [self.session stopRunning]; self.session = nil;&#125;@end åˆ‡æ¢é•œå¤´&amp;èšç„¦&amp;å†™å…¥éŸ³è§†é¢‘åˆ‡æ¢é•œå¤´ åˆ‡æ¢æ­¥éª¤ ç»™åˆ‡æ¢è¿‡ç¨‹æ·»åŠ åŠ¨ç”» è·å–å½“å‰æ‘„åƒå¤´æ˜¯å‰ç½®è¿˜æ˜¯åç½® é€šè¿‡æ–°æ‘„åƒå¤´ï¼ˆè‹¥ä¹‹å‰æ˜¯å‰ç½®ï¼Œåˆ™æ­¤æ¬¡æ˜¯åç½®ï¼‰ é€šè¿‡æ–°æ‘„åƒå¤´é‡æ–°è·å–è®¾å¤‡ï¼ˆAVCaptureDeviceï¼‰ é€šè¿‡è®¾å¤‡(AVCaptureDevice)åˆ›å»ºæ–°çš„è¾“å…¥(AVCaptureDeviceInput) ç§»é™¤æ—§inputå¹¶ä¸”æ·»åŠ æ–°Input æ³¨æ„ï¼šä¿®æ”¹sessioné…ç½®ä¹‹å‰å…ˆè°ƒç”¨å¼€å¯ä¿®æ”¹é…ç½®é€‰é¡¹ï¼Œé…ç½®å®Œæˆåï¼Œè°ƒç”¨æäº¤ä¿®æ”¹é…ç½®é¡¹ ä¸»è¦ä»£ç 123456[session beginConfiguration]; /** éœ€è¦ä¿®æ”¹çš„é…ç½®ä¿¡æ¯ */[session commitConfiguration]; ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123; if (self.input) &#123; //1 è‹¥å½“å‰æ˜¯å‰ç½®æ‘„åƒå¤´ï¼Œåˆ™éœ€æ–°è®¾åæ‘„åƒå¤´ï¼Œåä¹‹ï¼Œäº¦å¦‚æ­¤ã€‚ dispatch_async(dispatch_get_global_queue(0, 0), ^&#123; AVCaptureDevicePosition position = (self.input.device.position == AVCaptureDevicePositionFront) ? AVCaptureDevicePositionBack :AVCaptureDevicePositionFront; _curPosition = position; // è·å–æ‘„åƒå¤´è®¾å¤‡(å‰ç½® æˆ–è€… åç½® ä¾æ®ä¼ å…¥çš„ AVCaptureDevicePosition è€Œå®š) AVCaptureDevice *device = [self cameroWithPosition:position]; NSError *error; AVCaptureDeviceInput *newInput = [AVCaptureDeviceInput deviceInputWithDevice:device error:&amp;error]; if(newInput) &#123; dispatch_async(dispatch_get_main_queue(), ^&#123; CATransition *rotaionAnim = [CATransition animation]; rotaionAnim.type = @\"oglFlip\"; rotaionAnim.subtype = @\"fromLeft\"; rotaionAnim.duration = 0.5; [self.view.layer addAnimation:rotaionAnim forKey:nil]; [self.session beginConfiguration]; // é‡è®¾è¾“å…¥æº [self.session removeInput:self.input]; self.input = newInput; [self.session addInput:newInput]; // é‡è®¾è¾“å‡ºæº [self.session removeOutput:self.output]; [self addCaptureDeviceOutput:device]; [self.session commitConfiguration]; &#125;); &#125; else &#123; NSLog(@\"%@\", error); return; &#125; &#125;); &#125; &#125; å·¦å³æˆåƒé—®é¢˜ å½“ä½¿ç”¨å‰ç½®æ‘„åƒå¤´æ—¶ï¼Œæ³¨æ„å·¦å³æˆåƒé—®é¢˜ã€‚ éœ€è¦åœ¨è¾“å‡ºè®¾å¤‡(output)çš„æ¡¥æ¥(AVCaptureVideoDataOutput)è®¾ç½®ä¸€ä¸‹é•œåƒæ˜ å°„(ç…§é•œå­æ•ˆæœ) 12345678910111213-(void)setConnection:(AVCaptureVideoDataOutput *)output&#123; // æ¡¥æ¥ AVCaptureConnection *connection = [output connectionWithMediaType:AVMediaTypeVideo]; connection.videoOrientation = AVCaptureVideoOrientationPortrait; // è§£å†³å‰ç½®æ‘„åƒå¤´å·¦å³æˆåƒé—®é¢˜:(å½“å‰æ˜¯å‰ç½®æ‘„åƒå¤´ åˆ™å¯åŠ¨é•œå­åå°„æ•ˆæœ) if (_curPosition == AVCaptureDevicePositionUnspecified || _curPosition == AVCaptureDevicePositionFront) &#123; connection.videoMirrored = YES; &#125; else &#123; connection.videoMirrored = NO; &#125;&#125; å†™å…¥æ–‡ä»¶ç¾é¢œæ»¤é•œæ•ˆæœGPUImage GPUImage æ˜¯ä¸€ä¸ªå¼€æºçš„åŸºäºGPUçš„å›¾ç‰‡æˆ–è§†é¢‘å¤„ç†æ¡†æ¶ã€‚å…¶æœ¬èº«å†…ç½®äº†å¤šå¤§120å¤šç§å¸¸è§çš„æ»¤é•œæ•ˆæœ GPUImage æ˜¯åˆ©ç”¨GPUï¼Œä½¿åœ¨å›¾ç‰‡å’Œè§†é¢‘ä¸Šåº”ç”¨ä¸åŒçš„æ•ˆæœå’Œæ»¤é•œå˜å¾—éå¸¸çš„å®¹æ˜“ã€‚åŒæ—¶å®ƒè¿˜æ‹¥æœ‰å‡ºè‰²çš„æ€§èƒ½ã€‚å¹¶ä¸”å®ƒçš„æ€§èƒ½è¦æ¯”è‹¹æœå†…ç½®çš„ç›¸å…³APIå‡ºè‰² é«˜æ–¯æ¨¡ç³Š(æ¯›ç»ç’ƒ)æ•ˆæœ åœ¨iOSä¸­å®ç°æ¯›ç»ç’ƒæ•ˆæœæ–¹å¼æœ‰å¾ˆå¤š UIToolBaræœ¬èº«æœ‰æ¯›ç»ç’ƒæ•ˆæœ iOS8ä¹‹åUIEffectViewç›´æ¥åˆ›å»ºæ¯›ç»ç’ƒView ç³»ç»ŸCoreImageæ¡†æ¶ä¸­ç›´æ¥ä¿®æ”¹å›¾ç‰‡ GPUImageæ¡†æ¶ç»™å›¾ç‰‡æ·»åŠ ä¸€å±‚æ»¤é•œ ç”¨GPUImageå®ç°æ¯›ç»ç’ƒæ•ˆæœæ€è·¯ è·å–è¦ä¿®æ”¹æˆæ¯›ç»ç’ƒçš„å›¾ç‰‡ ç»™å›¾ç‰‡æ·»åŠ æ»¤é•œ ç”Ÿæˆæ–°çš„å›¾ç‰‡ å®ç°ä»£ç 12 è§†é¢‘ç¼–ç iOSç¡¬ç¼–ç iOSè½¯ç¼–ç YUVé¢œè‰²ç©ºé—´æµåª’ä½“åè®®æ¨æµæ’­æ”¾Demoåœ°å€ï¼šéŸ³è§†é¢‘demo","categories":[],"tags":[]},{"title":"è®¾è®¡æ¨¡å¼ä¸æ¶æ„","slug":"è®¾è®¡æ¨¡å¼ä¸æ¶æ„","date":"2018-07-19T00:45:47.000Z","updated":"2018-07-25T11:05:57.142Z","comments":true,"path":"2018/07/19/è®¾è®¡æ¨¡å¼ä¸æ¶æ„/","link":"","permalink":"http://PGGMan.github.io/2018/07/19/è®¾è®¡æ¨¡å¼ä¸æ¶æ„/","excerpt":"","text":"æ¶æ„æ¶æ„ï¼ˆArchitectureï¼‰ è½¯ä»¶å¼€å‘ä¸­çš„è®¾è®¡æ–¹æ¡ˆ ç±»ä¼¼äºå»ºé€ æ¥¼æˆ¿çš„å›¾çº¸ ç±»ä¸ç±»ä¹‹é—´çš„å…³ç³»ï¼Œæ¨¡å—ä¸æ¨¡å—ä¹‹é—´çš„å…³ç³»ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„å…³ç³» å¸¸ç”¨æ¶æ„ MVCã€MVPã€MVVMã€VIPERã€CDD ä¸‰å±‚æ¶æ„ã€å››å±‚æ¶æ„ â€¦â€¦ MVCMVC - Appleç‰ˆ Modelä¸VCå’ŒViewä¸VCäº§ç”Ÿè”ç³»ï¼Œä½†æ˜¯Modelä¸Viewä¸äº§ç”Ÿè”ç³»ã€‚ ä¼˜ç‚¹: Viewä¸ Modelä¸å…³è”ï¼ŒViewé‡ç”¨æ€§å¼ºã€‚ ç¼ºç‚¹: VCä»£ç è¿‡äºè‡ƒè‚¿ã€‚ MVC - å˜é©ç‰ˆ Modelä¸VCå’ŒViewä¸VCäº§ç”Ÿè”ç³»ï¼ŒåŒæ—¶Viewæ‹¥æœ‰Modelã€‚ ä¼˜ç‚¹: VCä»£ç ä¸è‡³äºè¿‡äºè‡ƒè‚¿ã€‚ ç¼ºç‚¹: Viewä¸Modelç»‘å®šäº†ï¼Œè€¦åˆæ€§å¼ºã€‚é‡ç”¨æ€§å¼±ã€‚ MVP MVPæ˜¯ç”±Viewã€Modelã€Presenterç»„æˆã€‚æ ¸å¿ƒæ¡¥æ¢å°±æ˜¯Presenterã€‚ Presenterè´Ÿè´£æŠŠModelæ•°æ®æ•´åˆæˆViewæ•°æ®ä¼ é€’ç»™Modelï¼›å¹¶è´Ÿè´£å¤„ç†Viewçš„äº‹ä»¶ã€‚ ä¼˜ç‚¹: è€¦åˆæ€§ä½ã€æ¨¡å—èŒè´£åˆ’åˆ†æ˜æ˜¾ã€åˆ©äºåˆ†æ¨¡å—æµ‹è¯•ã€Viewæœç”¨ç‡é«˜ ç¼ºç‚¹: å½“Viewä¸šåŠ¡é€»è¾‘å‘ç”Ÿå˜æ›´ï¼Œå¯èƒ½å¯¼è‡´é¢„æ”¯å…³è”çš„æ‰€æœ‰Presenteréƒ½å‘ç”Ÿæ”¹å˜ã€‚ MVVM MVVMä¸MVPå¾ˆåƒï¼Œå®ƒè´Ÿè´£Modelå’ŒViewä¹‹é—´çš„è¿æ¥ï¼Œå¹¶å¤„ç†Viewçš„ä¸šåŠ¡é€»è¾‘ ä¸åŒç‚¹ï¼šViewå’ŒViewModelæ˜¯åŒå‘ç»‘å®šçš„(äº’ç›¸æ‹¥æœ‰),å¹¶ä¸”Viewä¼šå¯¹viewModelè¿›è¡Œç›‘å¬ã€‚å½“ViewModelå¾—å€¼æ”¹å˜ï¼ŒViewå¯¹åº”çš„å€¼ä¹Ÿä¼šæ”¹å˜ã€‚ ç›‘å¬æ–¹å¼:RACã€KVOã€KVOController(faecBookå¼€æºæ¡†æ¶ã€githubå¯ä»¥æ‰¾åˆ°) 123456789101112- (void)addObserveModelProperty&#123; __weak typeof(self) waekSelf = self; [self.KVOController observe:viewModel keyPath:@\"name\" options:NSKeyValueObservingOptionNew block:^(id _Nullable observer, id _Nonnull object, NSDictionary&lt;NSKeyValueChangeKey,id&gt; * _Nonnull change) &#123; waekSelf.nameLabel.text = change[NSKeyValueChangeNewKey]; &#125;]; [self.KVOController observe:viewModel keyPath:@\"image\" options:NSKeyValueObservingOptionNew block:^(id _Nullable observer, id _Nonnull object, NSDictionary&lt;NSKeyValueChangeKey,id&gt; * _Nonnull change) &#123; waekSelf.iconView.image = [UIImage imageNamed:change[NSKeyValueChangeNewKey]]; &#125;];&#125; ä¼˜ç‚¹ï¼šæ–¹ä¾¿æµ‹è¯•ã€ä¾¿äºä»£ç çš„ç§»æ¤ã€å…¼å®¹MVC ç¼ºç‚¹: ç±»ä¼šå¢å¤šã€æ–°äººä¸å¤ªæ˜“æ‡‚ã€‚ åˆ†å±‚å¼€å‘ åˆ†å±‚å¼€å‘åˆ†ä¸ºï¼šä¸‰å±‚æ¶æ„ã€å››å±‚æ¶æ„ ä¸‰å±‚æ¶æ„åŒ…å«ï¼šç•Œé¢å±‚ã€ä¸šåŠ¡å±‚ã€æ•°æ®å±‚(å››å±‚æ¶æ„ä¼šæŠŠæ•°æ®å±‚åˆ†ä¸ºç½‘ç»œå±‚ã€æœ¬åœ°æ•°æ®å±‚) æˆ‘ä»¬å¹³æ—¶è¯´çš„MVCã€MVPã€MVVMéƒ½å±äºç•Œé¢å±‚ã€‚ è®¾è®¡æ¨¡å¼è®¾è®¡æ¨¡å¼(Design Pattern) æ˜¯ä¸€å¥—å‘—åå¤ä½¿ç”¨ã€ä»£ç è®¾è®¡ç»éªŒçš„æ€»ç»“ ä½¿ç”¨è®¾è®¡æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼šå¯é‡ç”¨ä»£ç ï¼Œè®©ä»£ç æ›´å®¹æ˜“è¢«äººç†è§£ï¼Œä¿è¯ä»£ç å¯é æ€§ã€‚ ä¸€èˆ¬ä¸ç¼–ç¨‹è¯­è¨€æ— å…³ï¼Œæ˜¯ä¸€å¥—æ¯”è¾ƒæˆç†Ÿçš„ç¼–ç¨‹æ€æƒ³ è®¾è®¡æ¨¡å¼å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±» åˆ›å»ºå‹æ¨¡å¼ï¼šå¯¹è±¡å®ä¾‹åŒ–çš„æ¨¡å¼ï¼Œç”¨äºè§£è€¦å¯¹è±¡çš„å®ä¾‹åŒ–è¿‡ç¨‹ã€‚ å•ä¾‹æ¨¡å¼ã€å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œç­‰ç­‰ ç»“æ„æ€§æ¨¡å¼ï¼šæŠŠç±»æˆ–å¯¹è±¡ç»“åˆåœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ›´å¤§çš„ç»“æ„ ä»£ç†æ¨¡å¼(ä¸æ˜¯OCä¸­çš„ä¼ å€¼ä»£ç†ï¼ŒNSProxyå°±ç±»ä¼¼æ­¤å¤„çš„ä»£ç†æ¨¡å¼)ã€é€‚é…å™¨æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€è£…é¥°æ¨¡å¼ã€ç­‰ç­‰ è¡Œä¸ºæ€§æ¨¡å¼ï¼šç±»æˆ–å¯¹è±¡ä¹‹é—´å¦‚ä½•äº¤äº’ï¼ŒåŠåˆ’åˆ†è´£ä»»å’Œç®—æ³• è§‚å¯Ÿè€…æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ã€ç­‰ç­‰ å¾…ç»­","categories":[],"tags":[]},{"title":"GCD","slug":"GCD","date":"2018-07-18T11:11:04.000Z","updated":"2018-10-26T08:35:39.760Z","comments":true,"path":"2018/07/18/GCD/","link":"","permalink":"http://PGGMan.github.io/2018/07/18/GCD/","excerpt":"","text":"GCDå¹¶ä¸æ˜¯çº¿ç¨‹,GCDæ˜¯çº¿ç¨‹çš„ç®¡ç†å·¥å…· GCDçš„4ä¸ªæ¦‚å¿µ åŒæ­¥ã€å¼‚æ­¥å’Œå¹¶å‘ã€ä¸²è¡Œ 1.1 åŒæ­¥ï¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚ 1.2 å¼‚æ­¥: åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå…·å¤‡å¼€å¯çº¿ç¨‹çš„èƒ½åŠ›ã€‚ 2.1 ä¸²è¡Œ: ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ 2.2 å¹¶å‘: å¤šä¸ªä»»åŠ¡å¹¶å‘(åŒæ—¶)æ‰§è¡Œ å¹¶å‘ä¸ä¸²è¡Œé˜Ÿåˆ—12345678910111213// globalé˜Ÿåˆ— æ˜¯å¹¶å‘é˜Ÿåˆ—dispatch_get_global_queue(0, 0);// mainé˜Ÿåˆ— æ˜¯ç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—(åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ)dispatch_get_main_queue(); /**creaté˜Ÿåˆ— å½“ä¼ å…¥ DISPATCH_QUEUE_SERIAL ä¸ºä¸²è¡Œé˜Ÿåˆ— å½“ä¼ å…¥ DISPATCH_QUEUE_CONCURRENT ä¸ºå¹¶å‘é˜Ÿåˆ—*/dispatch_queue_create(\"myQueue\", DISPATCH_QUEUE_SERIAL); performSelector å‡½æ•° performSelector:withObject: åº•å±‚æ˜¯è°ƒç”¨objc_msgSendå‡½æ•° performSelector:withObject:afterDelay:æ˜¯å‘å½“å‰çº¿ç¨‹æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåˆ°æ—¶é—´äº†è°ƒç”¨objc_msgSendå‡½æ•°. performSelector:onThread:withObject:waitUntilDone:æ˜¯å‘ä¼ å…¥çº¿ç¨‹ä¸­æ·»åŠ ä»»åŠ¡ï¼Œä¹Ÿæ¶‰åŠåˆ°äº†runLoopç›¸å…³(å½“runLoopæ²¡æœ‰å¯åŠ¨æ—¶) é¢è¯•é¢˜ç›¸å…³ é¢è¯•é¢˜ - 1 1234567891011121314151617181920212223- (void)viewDidLoad &#123; [super viewDidLoad]; dispatch_queue_t q = dispatch_get_global_queue(0, 0); dispatch_async(q, ^&#123; // å¼‚æ­¥å¹¶å‘: å­çº¿ç¨‹æ‰§è¡Œ NSLog(@\"1\"); [self performSelector:@selector(test2) withObject:@\"2\" afterDelay:0.0]; [self performSelector:@selector(test2) withObject:@\"2\"]; NSLog(@\"3\"); &#125;); &#125;- (void)test2&#123; NSLog(@\"2\");&#125;// æ‰“å°ç»“æœï¼š1 3,2æ²¡æœ‰æ‰“å°ã€‚è¯´æ˜test2æ²¡è°ƒç”¨ã€‚å› ä¸ºå­çº¿ç¨‹é»˜è®¤æ²¡æœ‰runloop,è™½ç„¶è·å–ååˆ›å»ºäº†runloop,ä½†æ˜¯runloopæ²¡æœ‰è¢«å¯åŠ¨ã€‚// [self performSelector:@selector(test2) withObject:@\"2\"]; æ— æ•ˆ// GUNstepä¸­å¯ä»¥çœ‹åˆ° é¢è¯•é¢˜ - 2 123456789101112131415- (void)test2&#123; NSLog(@\"2\");&#125;- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123; NSThread *thread = [[NSThread alloc] initWithBlock:^&#123; NSLog(@\"1\"); &#125;]; [self performSelector:@selector(test2) onThread:thread withObject:@\"\" waitUntilDone:YES];&#125;// æ‰“å°ç»“æœ 1ï¼Œå¹¶ä¸”å´©æºƒ.// å› ä¸ºthreadæ‰§è¡Œå®Œblockåï¼Œçº¿ç¨‹å·²ç»é€€å‡ºäº†ã€‚å†å»æ‰§è¡Œæ·»åŠ ä»»åŠ¡ä¼šå¯¼è‡´å´©æºƒã€‚ é˜Ÿåˆ—ç»„çš„ä½¿ç”¨ 1 dispatch_group_asyncå¹¶å‘ç»„æ‰§è¡Œéœ€è¦ç”¨æ­¤å‡½æ•°ï¼Œsyncå‡½æ•°æ˜¯åŒæ­¥çš„ä¸ä¼šå¼€å¯å­çº¿ç¨‹ã€‚ 2 dispatch_group_notify å½“ç»„å†…ä»»åŠ¡æ‰§è¡Œå®Œåä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œæ­¤å‡½æ•°å¯ä»¥å¤šæ¬¡å®ç°ã€‚ 3 dispatch_group_wait(, )å½“å‰ç»„å†…çº¿ç¨‹æš‚åœï¼Œå»æ‰§è¡Œä¼ å…¥ç»„å†…ä»»åŠ¡ã€‚ 1234567891011121314151617181920212223242526272829303132- (void)gcdGroup&#123; //1 åˆ›å»º å¹¶å‘é˜Ÿåˆ— å’Œ ç»„ dispatch_queue_t global = dispatch_get_global_queue(0, 0); dispatch_group_t group = dispatch_group_create(); dispatch_group_async(group, global, ^&#123; for (int i = 0; i &lt; 10; i++) &#123; NSLog(@\"%@\",[NSThread currentThread]); &#125; &#125;); dispatch_group_async(group, global, ^&#123; for (int i = 0; i &lt; 10; i++) &#123; NSLog(@\"%@\",[NSThread currentThread]); &#125; &#125;); //2 å½“1å‰é¢æ‰§è¡Œå®Œå å¼‚æ­¥ä¸»çº¿ç¨‹æ‰§è¡Œ dispatch_queue_t mainQ = dispatch_get_main_queue(); dispatch_group_notify(group, mainQ, ^&#123; for (int i = 0; i &lt; 10; i++) &#123; NSLog(@\"%@\",[NSThread currentThread]); &#125; &#125;); //2 å½“1å‰é¢æ‰§è¡Œå®Œå å¼‚æ­¥å­çº¿ç¨‹æ‰§è¡Œ dispatch_group_notify(group, global, ^&#123; for (int i = 0; i &lt; 10; i++) &#123; NSLog(@\"%@\",[NSThread currentThread]); &#125; &#125;);&#125; çº¿ç¨‹å®‰å…¨ çº¿ç¨‹å®‰å…¨äº§ç”Ÿæƒ…å†µ: èµ„æºå…±äº« 1 ä¸€å—èµ„æºå¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯èƒ½ä¼šè®¿é—®åŒä¸€å—èµ„æº 2 æ¯”å¦‚å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼ŒåŒä¸€ä¸ªå˜é‡ã€åŒä¸€ä»½æ–‡ä»¶ åŒæ­¥é”ç›¸å…³ 1 é”çš„å®ç° OSSpinLockè‡ªæ—‹é” os_unfair_lock pthread_mutex dispatch_sumphore dispatch_queue(DISPATCH_QUEUE_SERIAL)ä¸²è¡Œé˜Ÿåˆ— NSLock NSRecursiveock NSConditionæ¡ä»¶é” NSConditionLockæ¡ä»¶é”(NSConditionçš„å°è£…) @synchronized 2 é”çš„ç±»å‹ 1 è‡ªæ—‹é” 2 äº’æ–¥é” 3 é€’å½’é” 4 æ¡ä»¶é” 5 ä¿¡å·é‡ 6 ä¸²è¡Œé˜Ÿåˆ— OSSpinLock 12 -c123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657/**1 åŒæ­¥ä¸å¼‚æ­¥1.1 åŒæ­¥ï¼šæŠŠä¸€ä¸ªä»»åŠ¡æ·»åŠ åˆ°æŸqueueåå°±é©¬ä¸Šç¦»å¼€ã€‚1.2 å¼‚æ­¥ï¼šæŠŠä¸€ä¸ªä»»åŠ¡æ·»åŠ åˆ°æŸqueueå,ç­‰è¿™ä¸ªä»»åŠ¡å®Œæˆæ€»ç»“ï¼šæ‰€ä»¥,å¼‚æ­¥è°ƒåº¦å’ŒåŒæ­¥è°ƒåº¦çš„åŒºåˆ«ä¸åœ¨äºè¢«æ·»åŠ çš„ä»»åŠ¡æ€æ ·æ‰§è¡Œ,è€Œåœ¨äºè°ƒç”¨çº¿ç¨‹æ˜¯å¦ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œ*/// åŒæ­¥ - (void) syntFunction&#123;// dispatch_queue_t concurrentQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);// ä¼šæ­»é” // dispatch_queue_t concurrentQueue =dispatch_get_main_queue(); dispatch_queue_t concurrentQueue = dispatch_queue_create(\"my.concurrent.queue\", DISPATCH_QUEUE_CONCURRENT); NSLog(@\"1\"); dispatch_sync(concurrentQueue, ^()&#123; NSLog(@\"2\"); [NSThread sleepForTimeInterval:10]; NSLog(@\"3\"); &#125;); NSLog(@\"4\");&#125;// æ‰“å°ç»“æœ11:36:25.313 GCDSeTest[544:303] 111:36:25.313 GCDSeTest[544:303] 211:36:30.313 GCDSeTest[544:303] 3//æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œ11:36:30.314 GCDSeTest[544:303] 4/*********************************åˆ†ç•Œ******************************************/// å¼‚æ­¥- (void) asynFunction&#123;// dispatch_queue_t concurrentQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);// dispatch_queue_t concurrentQueue =dispatch_get_main_queue(); dispatch_queue_t concurrentQueue = dispatch_queue_create(\"my.concurrent.queue\", DISPATCH_QUEUE_CONCURRENT); NSLog(@\"1\"); dispatch_async(concurrentQueue, ^()&#123; NSLog(@\"2\"); [NSThread sleepForTimeInterval:5]; NSLog(@\"3\"); &#125;); NSLog(@\"4\")&#125;// æ‰“å°ç»“æœ 11:42:43.820 GCDSeTest[568:303] 1 11:42:43.820 GCDSeTest[568:303] 4 11:42:43.820 GCDSeTest[568:1003] 2 11:42:48.821 GCDSeTest[568:1003] 3//æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œæ—¶é—´ 1. åŒæ­¥ä¸å¼‚æ­¥-æ€»ç»“ï¼š 1 åŒæ­¥(sync) ä¸ç®¡æ˜¯åœ¨ä¸»é˜Ÿåˆ—(main)ã€å…¨å±€é˜Ÿåˆ—(global)ã€ç”Ÿæˆé˜Ÿåˆ—(creat)éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­å°±è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œä¸å¼€å¯å­çº¿ç¨‹ 2 å¼‚æ­¥(aync) åœ¨å…¨å±€é˜Ÿåˆ—(global)ã€ç”Ÿæˆé˜Ÿåˆ—(creat)ä¿©ç§æƒ…å†µä¸‹ä¼šå¼€å¯å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚ä½†æ˜¯åœ¨ä¸»é˜Ÿåˆ—(main)ä¸­ä¸ä¼šå¼€å¯å­çº¿ç¨‹ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ -c1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798 /** GCDæ¦‚å¿µ *//*************************************END*****************************************//**2 GCD - group 2.1 å¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå…¨éƒ¨æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œå›è°ƒæ–¹æ³•*/- (void)groupAction&#123; dispatch_queue_t dispatchQueue = dispatch_queue_create(\"ted.queue.next1\", DISPATCH_QUEUE_CONCURRENT); dispatch_queue_t globalQueue = dispatch_get_global_queue(0, 0); dispatch_group_t dispatchGroup = dispatch_group_create(); dispatch_group_async(dispatchGroup, dispatchQueue, ^()&#123; sleep(5); NSLog(@\"ä»»åŠ¡ä¸€å®Œæˆ\"); NSLog(@\"1çš„çº¿ç¨‹%@\",[NSThread currentThread]); &#125;); dispatch_group_async(dispatchGroup, dispatchQueue, ^()&#123; sleep(6); NSLog(@\"ä»»åŠ¡äºŒå®Œæˆ\"); NSLog(@\"2çš„çº¿ç¨‹%@\",[NSThread currentThread]); &#125;); dispatch_group_async(dispatchGroup, globalQueue, ^&#123; sleep(10); NSLog(@\"ä»»åŠ¡ä¸‰å®Œæˆ\"); NSLog(@\"3çš„çº¿ç¨‹%@\",[NSThread currentThread]); &#125;); dispatch_group_notify(dispatchGroup, dispatch_get_main_queue(), ^()&#123; NSLog(@\"notifyï¼šä»»åŠ¡éƒ½å®Œæˆäº†\"); NSLog(@\"4çš„çº¿ç¨‹%@\",[NSThread currentThread]); &#125;);&#125;// æ‰“å°ç»“æœ2017-12-19 10:13:53.995774+0800 ä»»åŠ¡ä¸€å®Œæˆ2017-12-19 10:13:53.996010+0800 1çš„çº¿ç¨‹&lt;NSThread: 0x60c0004697c0&gt;&#123;number = 3, name = (null)&#125;2017-12-19 10:13:54.991769+0800 ä»»åŠ¡äºŒå®Œæˆ2017-12-19 10:13:54.991943+0800 2çš„çº¿ç¨‹&lt;NSThread: 0x6040000723c0&gt;&#123;number = 4, name = (null)&#125;2017-12-19 10:13:58.996507+0800 ä»»åŠ¡ä¸‰å®Œæˆ2017-12-19 10:13:58.996650+0800 3çš„çº¿ç¨‹&lt;NSThread: 0x600000077440&gt;&#123;number = 5, name = (null)&#125;2017-12-19 10:13:58.996781+0800 notifyï¼šä»»åŠ¡éƒ½å®Œæˆäº†2017-12-19 10:13:58.996874+0800 4çš„çº¿ç¨‹&lt;NSThread: 0x6080000688c0&gt;&#123;number = 1, name = main&#125;/***********************************END*******************************************//** GCD -æ­»é” 3.0 å¿…é¡»æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ä»¥ä¸‹æ–¹æ³•æ‰ä¼šå‡ºç°æ­»é” 3.1 åŒæ­¥æ·»åŠ ä¸»é˜Ÿåˆ—å›å¯¼è‡´æ­»é” å› ä¸ºåŒæ­¥ä¼šç­‰å¾…GCDä»»åŠ¡æ·»åŠ å®Œååœ¨æ‰§è¡Œï¼Œè€Œä¸»é˜Ÿåˆ— 3.2 é˜Ÿåˆ—é˜»å¡ï¼Œè€Œä¸æ˜¯çº¿ç¨‹é˜»å¡*/- ï¼ˆvoidï¼‰viewDidLoad&#123; [super viewDidLoad]; // æ‰§è¡Œæ­»é” [self deadlock];&#125;- (void)deadlock&#123; NSLog(@\"ä»»åŠ¡1\"); dispatch_sync(dispatch_get_main_queue(), ^(void)&#123; NSLog(@\"è¿™é‡Œæ­»é”äº†\"); &#125;); NSLog(@\"ä»»åŠ¡2\"); &#125;// æ‰“å°ç»“æœ2017-12-19 10:36:29.992425+0800 ä»»åŠ¡1/**æ€»ç»“ 1.1 GCDéµå¾ªä¸¥æ ¼çš„å…ˆè¿›å…ˆå‡ºåŸåˆ™ï¼ŒviewDidLoadæ˜¯é˜Ÿåˆ—å¤´,dispatch_syncå‡½æ•°ä¸­çš„ä»»åŠ¡æ’åœ¨viewDidLodä¹‹å 1.2 ä¸»é˜Ÿåˆ—æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œå¹¶ä¸”dispatch_syncæ˜¯åŒæ­¥æ·»åŠ ï¼Œä¼šç­‰å¾…dispatch_syncå‡½æ•°ä¸­ä»»åŠ¡æ‰§è¡Œå®Œåç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚é€ æˆäº’ç›¸ç­‰å¾…*//***********************************END*******************************************//** 1 dispatch_queue_create: 2 dispatch_get_global_queue: * 1ä¸2éƒ½å…·å¤‡å¼€å¯å­çº¿ç¨‹çš„èƒ½åŠ› * 2(global) ä¸éœ€è¦è¿›è¡Œå†…å­˜ç®¡ç† * 1ï¼ˆcreatï¼‰åœ¨MRCçš„ç¯å¢ƒä¸‹éœ€è¦å°±è¡Œå†…å­˜ç®¡ç†,ç”¨å®Œä¹‹åéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ *//***********************************END*******************************************//** 1 ä¸²è¡Œä¸å¹¶è¡Œæ˜¯åŒæ­¥æˆ–å¼‚æ­¥æ“ä½œé˜Ÿåˆ—åçš„æ‰§è¡Œæ•ˆæœ 1.1 ä¸²è¡Œï¼šæŒ‰é¡ºåºçš„æ‰§è¡Œ 1.2 å¹¶è¡Œï¼šå¤šä»»åŠ¡ä¸€èµ·æ‰§è¡Œ*//***********************************END*******************************************/ GCDä»€ä¹ˆæƒ…å†µä¸‹äº§ç”Ÿæ­»é” 1è°ƒç”¨dispatch_syncå¾€å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ 0 - ä½ ç†è§£çš„å¤šçº¿ç¨‹ï¼Ÿ 1 - iOSçš„å¤šçº¿ç¨‹æ–¹æ¡ˆæœ‰å“ªå‡ ç§ï¼Ÿä½ æ›´å€¾å‘äºå“ªä¸€ç§ 2 - ä½ åœ¨é¡¹ç›®ä¸­ç”¨åˆ°è¿‡GCDå— 3 - GCDçš„é˜Ÿåˆ—ç±»å‹ 4 - è¯´ä¸€ä¸‹OperationQueue å’Œ GCDåŒºåˆ«ï¼Œä»¥åŠå„è‡ªçš„ä¼˜åŠ¿ 5 - çº¿ç¨‹å®‰å…¨çš„å¤„ç†æ‰‹æ®µæœ‰å“ªäº› 5.1 - OCä½ äº†è§£çš„é”æœ‰å“ªäº›ï¼Ÿ 5.2 - è‡ªæ—‹å’Œäº’æ–¥å¯¹æ¯” 5.3 - é”çš„ä¼˜å…ˆçº§ 5.4 - ç”¨é”å®ç°ä¾èµ– 5.3 - ä½¿ç”¨ä»¥ä¸Šé”éœ€è¦æ³¨æ„å“ªäº› 5.4 - ç”¨C/OC/C++ï¼Œä»»é€‰å…¶ä¸€ï¼Œå®ç°è‡ªæ—‹æˆ–äº’æ–¥ 6 - ç¼–ç¨‹é¢è¯•é¢˜ 7 - ç”¨é”å®ç°çº¿ç¨‹é—´çš„ä¾èµ– 123456789101112131415161718192021222324252627282930313233343536373839404142434445- (void)test&#123; NSLog(@\"2\"); &#125;// 1- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123; dispatch_queue_t queue = dispatch_get_global_queue(0, 0); dispatch_async(queue, ^&#123; NSLog(@\"1\"); [self performSelector:@selector(test) withObject:nil afterDelay:.0]; NSLog(@\"3\"); &#125;);&#125;po æ‰“å°ç»“æœæ˜¯: 1 3 - (void)test&#123; NSLog(@\"2\"); &#125;// 2- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123; NSLog(@\"1\"); [self performSelector:@selector(test) withObject:nil afterDelay:.0]; NSLog(@\"3\");&#125; po æ‰“å°ç»“æœæ˜¯: 1 3 2 /** performSelector: withObject: afterDelay: å®è´¨æ˜¯å¾€å½“å‰çº¿ç¨‹æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨ 1 æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè™½ç„¶æ­¤æ–¹æ³•åº•å±‚è·å–äº†å½“å‰runLoopï¼Œä½†æ˜¯æ²¡æœ‰è¢«å¯åŠ¨ 2 æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œé»˜è®¤æœ‰runLoop performSelector: withObject: å®è´¨æ˜¯ç»™è°ƒç”¨ objc_msgSend() ç›¸å½“äºç›´æ¥è°ƒç”¨æ–¹æ³•*/ 1234567891011121314151617181920- (void)test&#123; NSLog(@\"2\"); &#125;- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123; NSThread *thread = [[NSThread alloc] initWithBlock:^&#123; NSLog(@\"1\"); &#125;]; [thread start]; [self performSelector:@selector(test) onThread:thread withObject:nil waitUntilDone:YES]; &#125;/** æ‰“å°ç»“æœæ˜¯ï¼š 1 å¹¶ä¸”å´©æºƒï¼Œå› ä¸ºå­çº¿ç¨‹å¯åŠ¨åå°±ç»“æŸäº†ã€‚ */ å¤šçº¿ç¨‹çš„å®‰å…¨é—®é¢˜ 1 - èµ„æºå…±äº« è§£å†³æ–¹æ¡ˆ ä½¿ç”¨çº¿ç¨‹åŒæ­¥ æŠ€æœ¯(åŒæ­¥ï¼Œå°±æ˜¯ååŒæ­¥è°ƒï¼ŒæŒ‰é¢„å®šçš„å…ˆåæ¬¡åºè¿›è¡Œ)iOSä¸­çš„çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆ 1 - OSSpinLock 2 - os_unfair_lock 3 - pthread_mutex 4 - dispatch_semaphore 5 - dispatch_queue(DISPATCH_QUEUE_SERIAL) 6 - NSLock 7 - NSRecursiveLock 8 - NSCondition 9 - NSConditionLock A - @synchronized 1 - OSSpinLock è‡ªæ—‹é”ï¼Œå½“çº¿ç¨‹è¢«é”ï¼Œå®ƒä¼šé‡å¤æ£€æµ‹é”æ˜¯å¦æ‰“å¼€ã€‚é«˜çº§é”(ä¸€ç›´åœ¨é‚£ç­‰) å†…éƒ¨ç›¸å½“äºä¸€ä¸ªdo wileå¾ªç¯ä¸€ç›´åœ¨æ£€æµ‹é”çš„çŠ¶æ€123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110#import \"ViewController.h\"#import &lt;libkern/OSAtomic.h&gt;@interface ViewController ()@property (nonatomic ,assign) NSInteger ticketCount;@property (nonatomic ,assign) NSInteger money;@property (nonatomic ,assign) OSSpinLock lcok;@property (nonatomic ,assign) OSSpinLock lcok1;@end@implementation ViewController- (void)viewDidLoad &#123; [super viewDidLoad]; // åˆå§‹åŒ–è‡ªæ—‹é” self.lcok = OS_SPINLOCK_INIT; self.lcok1 = OS_SPINLOCK_INIT; &#125;- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123; [self moneyTest]; [self ticketTest]; &#125;#pragma mark - å­˜å–é’±- (void)moneyTest&#123; self.money = 300; dispatch_queue_t queue = dispatch_get_global_queue(0, 0); dispatch_async(queue, ^&#123; for (int i = 0; i &lt; 5; i++) &#123; [self saveMoney]; &#125; &#125;); dispatch_async(queue, ^&#123; for (int i = 0; i &lt; 5; i++) &#123; [self drawMoney]; &#125; &#125;); dispatch_async(queue, ^&#123; for (int i = 0; i &lt; 5; i++) &#123; [self saveMoney]; &#125; &#125;); &#125;- (void)saveMoney&#123; OSSpinLockLock(&amp;_lcok1); NSInteger oldmoney = self.money; sleep(0.2); oldmoney += 50; self.money = oldmoney; OSSpinLockUnlock(&amp;_lcok1); NSLog(@\"çº¿ç¨‹%@--é’±æ•°:%ld\",[NSThread currentThread],self.money); &#125;- (void)drawMoney&#123; OSSpinLockLock(&amp;_lcok1); NSInteger oldmoney = self.money; sleep(0.2); oldmoney -= 20; self.money = oldmoney; OSSpinLockUnlock(&amp;_lcok1); NSLog(@\"çº¿ç¨‹%@--é’±æ•°:%ld\",[NSThread currentThread],self.money); &#125;#pragma mark - å–ç¥¨- (void)saleTicket&#123; OSSpinLockLock(&amp;_lcok); NSInteger oldTicketCount = self.ticketCount; sleep(0.2); oldTicketCount--; self.ticketCount = oldTicketCount; OSSpinLockUnlock(&amp;_lcok); NSLog(@\"çº¿ç¨‹%@--ç¥¨æ•°:%ld\",[NSThread currentThread],self.ticketCount);&#125;- (void)ticketTest&#123; self.ticketCount = 30; dispatch_queue_t queue = dispatch_get_global_queue(0, 0); dispatch_async(queue, ^&#123; for (int i = 0; i &lt; 10; i++) &#123; [self saleTicket]; &#125; &#125;); dispatch_async(queue, ^&#123; for (int i = 0; i &lt; 10; i++) &#123; [self saleTicket]; &#125; &#125;); dispatch_async(queue, ^&#123; for (int i = 0; i &lt; 10; i++) &#123; [self saleTicket]; &#125; &#125;);&#125;@end æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³• è¿›ç¨‹ã€çº¿ç¨‹ä¹‹é—´çš„è°ƒåº¦éƒ½æ˜¯ç”¨çš„è¿™ç§ç®—æ³• çº¿ç¨‹ä¼˜å…ˆçº§ å½“çº¿ç¨‹ä¼˜å…ˆçº§é«˜ï¼Œåˆ†é…æ—¶é—´ç‰‡çš„æ¦‚ç‡æ¯”è¾ƒé«˜ ä¼˜å…ˆçº§åè½¬é—®é¢˜ ç›®å‰OSSpinLockå·²ç»ä¸å®‰å…¨ åœ¨çº¿ç¨‹è°ƒåº¦çš„æ—¶å€™ï¼Œçº¿ç¨‹æ˜¯æœ‰æƒé‡çš„(ä¼˜å…ˆçº§) å¦‚æœç­‰å¾…é”çš„çº¿ç¨‹ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œå®ƒä¼šä¸€ç›´å ç”¨ç€CPUçš„èµ„æºï¼Œä¼˜å…ˆçº§ä½çš„çº¿ç¨‹æ— æ³•é‡Šæ”¾é” è‡ªæ—‹é”è¢«é˜»å¡æ—¶ä¸æ˜¯ä¼‘çœ ï¼Œè€Œæ˜¯é‡å¤å¾ªç¯æŸ¥çœ‹é”çš„çŠ¶æ€å¿™ç­‰ 2 - os_unfair_lock os_unfair_lock ç”¨äºå–ä»£ä¸å®‰å…¨çš„ OSSpinLockï¼Œä»iOS10å¼€å§‹æ”¯æŒ ä»åº•å±‚è°ƒç”¨çœ‹ï¼Œç­‰å¾…os_unfair_locké”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€,éå¿™ç­‰ ã€‚å®ƒåº•å±‚ä¹Ÿæ˜¯è°ƒç”¨(syscall :ç³»ç»Ÿçº§æŒ‡ä»¤ï¼Œç›´æ¥å»ç¡è§‰) ä½çº§é”(å‘ç°è¢«é”å°±å»ä¼‘çœ ) éœ€è¦å¯¼å…¥å¤´æ–‡ä»¶#import &lt;os/lock.h&gt; 123456789// åˆå§‹åŒ–os_unfair_lock lock = OS_UNFAIR_LOCK_INIT;// å°è¯•åŠ é”os_unfair_lock_trylock(&amp;lock)// åŠ é”os_unfair_lock_lock(&amp;lock)// è§£é”os_unfair_lock_unlock(&amp;lock) æ­»é”é—®é¢˜ å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥å¹¶åŠ é”ï¼Œä¸è¿›è¡Œè§£é”ï¼Œå…¶ä»–çº¿ç¨‹æ°¸è¿œé˜»å¡åœ¨è¿™é‡Œï¼Œä¼šå¯¼è‡´æ­»é” 2 - pthread_mutex(äº’æ–¥é”/é€’å½’é”) äº’æ–¥é”: - ç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€ ä½çº§é”(å‘ç°è¢«é”å°±å»ä¼‘çœ ) å®ƒåº•å±‚è°ƒç”¨(syscall :ç³»ç»Ÿçº§æŒ‡ä»¤ï¼Œç›´æ¥å»ç¡è§‰) é€’å½’é”: - å…è®¸åŒä¸€æ¡çº¿ç¨‹é‡å¤åŠ é” 123atommic : (è‡ªæ—‹é”)// ç»™å±æ€§åŠ ä¸Šatomicä¿®é¥°ï¼Œå¯ä»¥ä¿è¯å±æ€§çš„setterå’Œgetteréƒ½æ˜¯åŸå­æ€§æ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¿è¯setterå’Œgetterå†…éƒ¨æ˜¯çº¿ç¨‹åŒæ­¥çš„objc_accessors_mm runtimeæºç  IOæ“ä½œ(æ–‡ä»¶æ“ä½œ) è¯»å†™å®‰å…¨(å¤šè¯»å•å†™) åŒä¸€æ—¶é—´ï¼Œåªæœ‰1ä¸ªçº¿ç¨‹è¿›è¡Œå†™çš„æ“ä½œ åŒä¸€æ—¶é—´ï¼Œå…è®¸æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»çš„æ“ä½œ åŒä¸€æ—¶é—´ï¼Œä¸æ¶¦å¾å³æœ‰å†™çš„æ“ä½œï¼Œåˆæœ‰è¯»çš„æ“ä½œ pthread_rwlock1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859#import \"ViewController.h\"#import &lt;pthread.h&gt;@interface ViewController()@property (nonatomic ,assign) pthread_rwlock_t lock;@end@implementation ViewController- (void)viewDidLoad &#123; [super viewDidLoad]; // 1åˆ›å»ºè¯»å†™é” pthread_rwlock_init(&amp;(_lock), NULL);&#125;- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123; dispatch_queue_t q = dispatch_get_global_queue(0, 0); for (int i = 0; i &lt; 10; i ++) &#123; dispatch_async(q, ^&#123; [self read]; &#125;); dispatch_async(q, ^&#123; [self write]; &#125;); &#125;&#125;// è¯»- (void)read&#123; pthread_rwlock_rdlock(&amp;_lock); NSLog(@\"%s\",__func__); pthread_rwlock_unlock(&amp;_lock);&#125;// å†™- (void)write&#123; pthread_rwlock_wrlock(&amp;_lock); sleep(1); NSLog(@\"%s\",__func__); pthread_rwlock_unlock(&amp;_lock);&#125;// é”€æ¯- (void)dealloc&#123; pthread_rwlock_destroy(&amp;_lock); &#125;@end- (void)dealloc&#123; pthread_rwlock_destroy(&amp;_lock); &#125;@end dispatch_barrier_async(å¼‚æ­¥æ …æ ) æ³¨æ„ç‚¹ è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å¹¶å‘é˜Ÿåˆ—å¿…é¡»æ˜¯è‡ªå·±é€šè¿‡dispatch_queue_createåˆ›å»ºçš„ å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªä¸²è¡Œæˆ–æ˜¯ä¸€ä¸ªå…¨å±€çš„å¹¶å‘é˜Ÿåˆ—ï¼Œé‚£è¿™ä¸ªå‡½æ•°ä¾¿ç­‰åŒäºdispatch_asyncå‡½æ•°çš„æ•ˆæœ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546#import \"ViewController.h\"#import &lt;pthread.h&gt;@interface ViewController()@property (nonatomic ,strong) dispatch_queue_t queue;@end@implementation ViewController- (void)viewDidLoad &#123; [super viewDidLoad]; _queue = dispatch_queue_create(\"myQueue\", DISPATCH_QUEUE_CONCURRENT);&#125;- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123; for (int i = 0; i &lt; 5; i++) &#123; [self barrarRead]; [self barrarRead]; [self barrarWrite]; [self barrarWrite]; [self barrarRead]; [self barrarWrite]; &#125; &#125;#pragma mark - æ …æ - (void)barrarWrite&#123; dispatch_barrier_async(self.queue, ^&#123; sleep(1); NSLog(@\"%s\",__func__); &#125;); &#125;- (void)barrarRead&#123; dispatch_async(self.queue, ^&#123; sleep(1); NSLog(@\"%s\",__func__); &#125;); &#125;@end GNUstep æ²¡æœ‰å¼€æºçš„NSæ¡†æ¶ï¼Œè¢«å®ƒå¼€æºå®ç°äº†ä¸€éã€‚","categories":[],"tags":[]},{"title":"é€†å‘ç¯å¢ƒæ­å»º","slug":"é€†å‘ç¯å¢ƒæ­å»º","date":"2018-07-15T12:01:02.000Z","updated":"2018-07-15T12:01:02.263Z","comments":true,"path":"2018/07/15/é€†å‘ç¯å¢ƒæ­å»º/","link":"","permalink":"http://PGGMan.github.io/2018/07/15/é€†å‘ç¯å¢ƒæ­å»º/","excerpt":"","text":"","categories":[],"tags":[]},{"title":"Mach-O","slug":"Mach-O","date":"2018-07-15T12:00:13.000Z","updated":"2018-07-15T12:00:13.708Z","comments":true,"path":"2018/07/15/Mach-O/","link":"","permalink":"http://PGGMan.github.io/2018/07/15/Mach-O/","excerpt":"","text":"","categories":[],"tags":[]},{"title":"iOSç­¾åæœºåˆ¶","slug":"iOSç­¾åæœºåˆ¶","date":"2018-07-15T11:59:46.000Z","updated":"2018-07-15T11:59:46.111Z","comments":true,"path":"2018/07/15/iOSç­¾åæœºåˆ¶/","link":"","permalink":"http://PGGMan.github.io/2018/07/15/iOSç­¾åæœºåˆ¶/","excerpt":"","text":"","categories":[],"tags":[]},{"title":"æ€§èƒ½ä¼˜åŒ–","slug":"æ€§èƒ½ä¼˜åŒ–","date":"2018-07-11T12:36:45.000Z","updated":"2018-07-18T09:23:00.078Z","comments":true,"path":"2018/07/11/æ€§èƒ½ä¼˜åŒ–/","link":"","permalink":"http://PGGMan.github.io/2018/07/11/æ€§èƒ½ä¼˜åŒ–/","excerpt":"","text":"CPUä¸GPU åœ¨å±å¹•æˆåƒçš„è¿‡ç¨‹ä¸­ï¼ŒCPUå’ŒGPUèµ·ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚ CPU(Central Processing Unitã€ä¸­å¤®å¤„ç†å™¨) å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ã€å¯¹è±¡å±æ€§çš„è°ƒæ•´ã€å¸ƒå±€è®¡ç®—ã€æ–‡æœ¬çš„è®¡ç®—å’Œæ’ç‰ˆã€å›¾ç‰‡çš„æ ¼å¼è½¬æ¢å’Œè§£ç ã€å›¾åƒçš„ç»˜åˆ¶(Core Graphics) CPUé€‚åˆè®¡ç®—å·¥ä½œã€‚(å–å†³äºå¤„ç†ä»»åŠ¡çš„æ–¹å¼) GPU(Graphics Processing Unitã€å›¾å½¢å¤„ç†å™¨) çº¹ç†çš„æ¸²æŸ“ GPUé€‚åˆæ¸²æŸ“å·¥ä½œã€‚(å–å†³äºå¤„ç†ä»»åŠ¡çš„æ–¹å¼) å±å¹•å±•ç¤ºå›¾ç‰‡æµç¨‹ CPUæŠŠå›¾å½¢æ•°æ®è®¡ç®—å¥½ï¼Œç„¶åGPUæ¸²æŸ“åå­˜æ”¾äºå¸§ç¼“å­˜ä¸­(iOSæ˜¯åŒç¼“å­˜æœºåˆ¶ã€‚å‰å¸§ç¼“å­˜ã€åå¸§ç¼“å­˜.å½“å‰å¸§ç¼“å­˜æ­£åœ¨å·¥ä½œæˆ–è€…å·²æ»¡ï¼Œå°±ä¼šåœ¨åå¸§ç¼“å­˜ä¸­è¿›è¡Œ)ï¼Œç”±è§†é¢‘æ§åˆ¶å™¨éƒ¨ä»¶è¯»å–ï¼Œæœ€åå±•ç¤ºåœ¨å±å¹•ä¸Šã€‚ å±å¹•æˆåƒåŸç† 1 é¦–å…ˆï¼Œå‘å‡ºå‚ç›´åŒæ­¥ä¿¡å·(vSync).ç»˜åˆ¶ä¸€é¡µå›¾åƒçš„èµ·ç‚¹.(æ¯ç§’60æ¬¡ï¼Œä¹Ÿå°±æ˜¯é—´éš”æ—¶é—´æ˜¯16æ¯«ç§’) 2 ç„¶åï¼Œä»ä¸Šå¾€ä¸‹å‘é€æ°´å¹³åŒæ­¥ä¿¡å·(H Sync) 3 å½“æœ€åä¸€ä¸ªæ°´å¹³åŒæ­¥ä¿¡å·(HSync)å®Œæˆï¼Œå°±ä¼šå¼€å¯ä¸‹ä¸€è½®å›(å‘é€å‚ç›´åŒæ­¥ä¿¡å·ï¼Œç»˜åˆ¶ä¸‹ä¸€å¸§) å¡é¡¿äº§ç”Ÿçš„åŸå›  åœ¨ä¸€å¸§æ—¶é—´å†…ï¼Œ CPUå’ŒGPUå…¶ä¸­ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå·¥ä½œæ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´å‚ç›´åŒæ­¥ä¿¡å·åœ¨è¿™ä¸€å¸§å†…æ‹¿ä¸åˆ°æ•°æ®(å‚ç›´åŒæ­¥ä¿¡å·ç”±å±å¹•ç”¨ç¡¬ä»¶æ—¶é’Ÿäº§ç”Ÿçš„ä¿¡å·ä¸­çš„ä¸€ç§),æ‰€ä»¥å°±äº§ç”Ÿäº†æ‰å¸§ç°è±¡ å½“CPUå’ŒGPUå®Œæˆåï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å‚ç›´åŒæ­¥ä¿¡å·(VSync)æ¥è¯»å–æ•°æ®ã€‚ è§£å†³æ–¹å‘: é™ä½CPUå’ŒGPUçš„å·¥ä½œé‡ã€‚ å¡é¡¿ä¼˜åŒ– CPU å°½é‡ç”¨è½»é‡çº§çš„å¯¹è±¡ï¼Œæ¯”å¦‚ç”¨ä¸åˆ°äº‹ä»¶å¤„ç†çš„åœ°æ–¹ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨CALayerå–ä»£UIViewã€‚ ä¸è¦é¢‘ç¹åœ°è°ƒç”¨UIViewçš„ç›¸å…³å±æ€§ï¼Œæ¯”å¦‚frameã€boundsã€transformç­‰å±æ€§ã€‚å°½é‡å‡å°‘ä¸å¿…è¦çš„ä¿®æ”¹ å°½é‡æå‰è®¡ç®—å¥½å¸ƒå±€ï¼Œåœ¨æœ‰éœ€è¦æ—¶ä¸€æ¬¡æ€§è°ƒæ•´å¯¹åº”çš„å±æ€§ã€‚ä¸è¦å¤šæ¬¡ä¿®æ”¹å±æ€§ AutoLayoutä¼šæ¯”ç›´æ¥è®¾ç½®frameæ¶ˆè€—æ›´å¤šçš„CPUèµ„æºã€‚ å›¾ç‰‡çš„sizeæœ€å¥½åˆšå¥½è·ŸUIImageViewçš„sizeä¿æŒä¸€è‡´ã€‚ æ§åˆ¶ä¸€ä¸‹çº¿ç¨‹çš„æœ€å¤§å¹¶å‘æ•°é‡ã€‚ å°½é‡æŠŠè€—æ—¶æ“ä½œæ”¾åˆ°å­çº¿ç¨‹ã€‚ æ–‡æœ¬å¤„ç†(å°ºå¯¸è®¡ç®—ã€ç»˜åˆ¶) å›¾ç‰‡å¤„ç†(è§£ç ã€ç»˜åˆ¶)(ç”¨imageNamedåŠ è½½çš„æ˜¯å‹ç¼©è¿‡å¾—äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¦æƒ³åœ¨å±å¹•ä¸Šæ˜¾ç¤ºè¿˜éœ€è¦è§£ç ã€ç»˜åˆ¶ï¼Œé»˜è®¤åœ¨ä¸»çº¿ç¨‹è¿›è¡Œ)ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546+ (void)imageName_PG:(NSString *)name forImageView:(UIImageView *)imgView&#123; dispatch_async(dispatch_get_global_queue(0, 0), ^&#123; //1 è·å–CGImage CGImageRef cgImage = [UIImage imageNamed:name].CGImage; //2 alphaInfo CGImageAlphaInfo alphaInfo = CGImageGetAlphaInfo(cgImage) &amp; kCGBitmapAlphaInfoMask; BOOL hasAlpha = NO; // çŸ©é˜µ if (alphaInfo == kCGImageAlphaPremultipliedLast || alphaInfo == kCGImageAlphaPremultipliedFirst || alphaInfo == kCGImageAlphaLast || alphaInfo == kCGImageAlphaFirst) &#123; hasAlpha = YES; &#125; //3 bitmapInfo(ä½æ˜ å°„ä¿¡æ¯) CGBitmapInfo bitmapInfo = kCGBitmapByteOrder32Host; bitmapInfo |= hasAlpha ? kCGImageAlphaPremultipliedFirst : kCGImageAlphaNoneSkipFirst; //4 size size_t width = CGImageGetWidth(cgImage); size_t height = CGImageGetHeight(cgImage); //5 context CGContextRef context = CGBitmapContextCreate(NULL, width, height, 0, 0, CGColorSpaceCreateDeviceRGB(), bitmapInfo); //6 draw CGContextDrawImage(context, CGRectMake(0, 0, width, height), cgImage); // è·å¾— CGImage cgImage = CGBitmapContextCreateImage(context); UIImage *newImage = [UIImage imageWithCGImage:cgImage]; CGContextRelease(context); CGImageRelease(cgImage); dispatch_async(dispatch_get_main_queue(), ^&#123; imgView.image = newImage; &#125;); &#125;);&#125; GPU å°½é‡å‡å°‘è§†å›¾æ•°é‡å’Œå±‚æ¬¡ã€‚ å°½é‡é¿å…çŸ­æ—¶é—´å†…å¤§é‡å›¾ç‰‡çš„æ˜¾ç¤ºï¼Œå°½å¯èƒ½å°†å¤šå¼ å›¾ç‰‡åˆæˆä¸€å¼ è¿›è¡Œæ˜¾ç¤ºã€‚ æŠŠå¤šå¼ å›¾ç‰‡åˆæˆä¸€å¼ è¿›è¡Œæ¸²æŸ“ã€‚ GPUèƒ½å¤„ç†çš„æœ€å¤§çº¹ç†å°ºå¯¸æ˜¯4096 * 4096. ä¸€æ—¦è¶…è¿‡è¿™ä¸ªå°ºå¯¸ï¼Œå°±ä¼šå ç”¨CPUèµ„æºè¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥çº¹ç†å°½é‡ä¸è¦è¶…è¿‡è¿™ä¸ªå°ºå¯¸ å‡å°‘é€æ˜çš„è§†å›¾(alpha &lt; 1),ä¸é€æ˜çš„å°±è®¾ç½®opaqueä¸ºYESã€‚ å°½é‡é¿å…å‡ºç°ç¦»å±æ¸²æŸ“ ç¦»å±æ¸²æŸ“ åœ¨OpenGLä¸­ï¼ŒGPUæœ‰2ä¸­æ¸²æŸ“æ–¹å¼ On-Screen Rendering: å½“å‰å±å¹•æ¸²æŸ“ï¼Œåœ¨å½“å‰ç”¨äºæ˜¾ç¤ºçš„å±å¹•ç¼“å­˜åŒºè¿›è¡Œæ¸²æŸ“æ“ä½œ(å¸§ç¼“å­˜(å‰ã€å)) Off-Screen Rendering: ç¦»å±æ¸²æŸ“ï¼Œåœ¨å½“å‰å±å¹•ç¼“å†²åŒºä»¥å¤–å¼€è¾Ÿä¸€ä¸ªç¼“å†²åŒºè¿›è¡Œæ¸²æŸ“æ“ä½œã€‚ Off-Screen Renderingç¦»å±æ¸²æŸ“ å½“æ¸²æŸ“æ¯”è¾ƒè€—æ€§èƒ½æˆ–è€…å½“å‰ç¼“å­˜åŒºï¼ˆå‰åï¼‰å·²ç»è¢«å ç”¨ï¼Œå°±ä¼šå¼€å¯ç¦»å±æ¸²æŸ“ã€‚ ç¦»å±æ¸²æŸ“æœ¬èº«æ‰§è¡Œçš„æ¸²æŸ“ä»»åŠ¡å°±æ˜¯æ¯”è¾ƒè€—æ€§èƒ½çš„ã€‚ éœ€è¦åˆ›å»ºæ–°çš„ç¼“å­˜åŒºã€‚ ç¦»å±æ¸²æŸ“çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œéœ€è¦å¤šæ¬¡åˆ‡æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå…ˆæ˜¯ä»å½“å‰å±å¹•(On -Screen)åˆ‡æ¢åˆ°ç¦»å±ï¼ˆoff -Screenï¼‰ï¼›ç­‰åˆ°ç¦»å±æ¸²æŸ“ç»“æŸä»¥åï¼Œå°†ç¦»å±›ç¼“å†²åŒºçš„æ¸²æŸ“ç»“æœæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œåˆéœ€è¦å°†ä¸Šä¸‹æ–‡ç¯å¢ƒä»ç¦»å±›åˆ‡æ¢åˆ°å½“å‰å±å¹•ç¼“å†²åŒºã€‚ è§¦å‘Off-Screen Renderingç¦»å±æ¸²æŸ“ çš„æ“ä½œ å…‰æ …è¯ï¼šlayer.shouldRasterize = YES é®ç½©ï¼šlayer.master = mySublayer åœ†è§’ï¼ŒåŒæ—¶è®¾ç½®è£å‰ª: layer.masksToBounds = YESï¼Œlayer.cornerRadiuså¤§äº0. åœ†è§’å¯ä»¥ç”¨CoreGraphicsç»˜åˆ¶è£å‰ªåœ†è§’ï¼Œæˆ–è€…å«ç¾å·¥æä¾›åœ†è§’å›¾ç‰‡ é˜´å½±: layer.shadowXXX å¦‚æœè®¾ç½®äº†layer.shadowPathå°±ä¸ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ã€‚ å¡é¡¿æ£€æµ‹ å¹³æ—¶æ‰€è¯´çš„å¡é¡¿ ä¸»è¦æ˜¯å› ä¸ºåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œäº†æ¯”è¾ƒè€—æ—¶çš„æ“ä½œ å¯ä»¥æ·»åŠ Observeråˆ°ä¸»çº¿ç¨‹RunLoopä¸­ï¼Œé€šè¿‡ç›‘å¬RunLoopçŠ¶æ€åˆ‡æ¢çš„è€—æ—¶ï¼Œä»¥è¾¾åˆ°ç›‘æ§å¡é¡¿çš„ç›®çš„(ä¸»è¦ç›‘å¬RunLoopç»“æŸç¡çœ åˆ°æ‰§è¡ŒSource0ä¹‹é—´çš„è€—æ—¶æ“ä½œ)ã€‚ æ£€æµ‹å·¥å…·: æ£€æµ‹Demoè€—ç”µæ¥æº CPUå¤„ç† Processing ;æ•°æ®å¤„ç†è®¡ç®— ç½‘ç»œ: Networking :ç½‘ç»œè¯·æ±‚ å®šä½: Location :ç”¨æˆ·ä½ç½®å®šä½ å›¾åƒ: Graphics :å›¾åƒæ¸²æŸ“ è€—ç”µä¼˜åŒ– å°½é‡é™ä½CPUã€GPUåŠŸè€— å°‘ç”¨å®šæ—¶å™¨ ä¼˜åŒ–I/Oæ“ä½œ å°½é‡ä¸è¦é¢‘ç¹å†™å…¥å°æ•°æ®ã€‚æœ€å¥½æ‰¹é‡ä¸€æ¬¡æ€§å†™å…¥ã€‚ è¯»å†™å¤§é‡é‡è¦æ•°æ®æ—¶ï¼Œè€ƒè™‘ç”¨dispatch_ioï¼Œå…¶æä¾›äº†åŸºäºGCDçš„å¼‚æ­¥æ“ä½œæ–‡ä»¶I/Oçš„APIï¼Œç”¨dispatch_ioç³»ç»Ÿä¼šä¼˜åŒ–ç£ç›˜è®¿é—® æ•°æ®é‡æ¯”è¾ƒå¤§çš„ï¼Œå»ºè®®ä½¿ç”¨æ•°æ®åº“(æ¯”å¦‚SQLite CoreData)(æ•°æ®åº“æ€ä¹ˆä¼˜åŒ–çš„ï¼Ÿ) ç½‘ç»œä¼˜åŒ– å‡å°‘ã€å‹ç¼©ç½‘ç»œæ•°æ®(protocol buffer ä½“ç§¯æ¯”JSONè¿˜å°) ä¸Šä¼ æ–‡ä»¶ä¹Ÿè¿›è¡Œå‹ç¼©(å›¾ç‰‡ã€I/O) ç½‘ç»œè¯·æ±‚ç»“æœåŸºæœ¬ä¸€æ ·çš„å¯ä»¥ç”¨ç¼“å­˜(NSMutableURLRequest ç„¶åç”¨NSCacheè¿›è¡Œç¼“å­˜) 123NSMutableURLRequestNSCache å°½é‡ä½¿ç”¨æ–­ç‚¹ç»­ä¼  ç½‘ç»œä¸å¯ç”¨æ—¶ï¼Œä¸è¦å°è¯•æ‰§è¡Œç½‘ç»œè¯·æ±‚ è®©ç”¨æˆ·å¯ä»¥å–æ¶ˆé•¿æ—¶é—´è¿è¡Œæˆ–è€…é€Ÿåº¦å¾ˆæ…¢çš„ç½‘ç»œæ“ä½œï¼Œè®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´ æ‰¹é‡ä¸‹è½½ï¼Œå‡å°‘å‘é€ç½‘ç»œè¯·æ±‚çš„æ•°é‡ å®šä½ä¼˜åŒ– ç¡¬ä»¶æ£€æµ‹ä¼˜åŒ– åŠ é€Ÿå‰‚ã€é™€èºä»ªã€æ‘‡æ™ƒã€‚ä¼šäº§ç”ŸåŠ¨ä½œ(motion)äº‹ä»¶åœ¨ä¸éœ€è¦æ£€æµ‹çš„åœºåˆï¼Œåº”è¯¥åŠæ—¶å…³é—­è¿™äº›ç¡¬ä»¶ APPçš„å¯åŠ¨ APPçš„å¯åŠ¨å¯ä»¥åˆ†ä¸º2ç§ å†·å¯åŠ¨(Cold Launch): ä»é›¶å¼€å§‹å¯åŠ¨APP çƒ­å¯åŠ¨(Warm Launch): APPå·²ç»åœ¨å†…å­˜ä¸­ï¼Œåœ¨åå°å­˜æ´»ç€ï¼Œå†æ¬¡ç‚¹å‡»å›¾æ ‡å¯åŠ¨APP APPå¯åŠ¨æ—¶é—´çš„ä¼˜åŒ–ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å†·å¯åŠ¨è¿›è¡Œä¼˜åŒ– é€šè¿‡æ·»åŠ ç¯å¢ƒå˜é‡å¯ä»¥æ‰“å°å‡ºAPPçš„å¯åŠ¨æ—¶é—´åˆ†æ(Edit scheme -&gt; Run -&gt; Arguments(400æ¯«ç§’ä»¥å†…ç®—æ­£å¸¸çš„) DYLD_PRINT_STATISTICSè®¾ç½®ä¸º1(dyld_print_statistics) DYLD_PRINT_STATISTICS_DETAILSè®¾ç½®ä¸º1ï¼Œä¼šå±•ç¤ºæ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ APPçš„å¯åŠ¨è¿‡ç¨‹ APPçš„å†·å¯åŠ¨å¯ä»¥æ¦‚æ‹¬ä¸º3å¤§é˜¶æ®µ(æ³¨: éœ€è¦å›¾) dyld runtime main APPçš„å¯åŠ¨ - dyld dyld (dynamic link editor), Appleçš„åŠ¨æ€é“¾æ¥å™¨ï¼Œå¯ä»¥ç”¨æ¥è£…è½½Mach-Oæ–‡ä»¶(å¯æ‰§è¡Œæ–‡ä»¶ã€åŠ¨æ€åº“ç­‰)","categories":[],"tags":[]},{"title":"Block","slug":"Block","date":"2018-07-09T06:09:27.000Z","updated":"2018-07-15T11:48:48.743Z","comments":true,"path":"2018/07/09/Block/","link":"","permalink":"http://PGGMan.github.io/2018/07/09/Block/","excerpt":"","text":"Block blockæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªOCå¯¹è±¡ï¼Œå®ƒå†…éƒ¨ä¹Ÿæœ‰ä¸€ä¸ªisaæŒ‡é’ˆ blockæ˜¯å°è£…äº†å‡½æ•°è°ƒç”¨ä»¥åŠå‡½æ•°è°ƒç”¨ç¯å¢ƒçš„OCå¯¹è±¡ blockçš„åº•å±‚ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º(OCä»£ç é€šè¿‡clangè½¬æˆc++ä»£ç ) xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main-arm64.cpp xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-8.0.0 main.m 1234567891011121314151617181920212223242526// OCä»£ç  // main.m// GNU//// Created by å°åº¦é˜¿ä¸‰ on 2018/7/9.// Copyright Â© 2018å¹´ å°åº¦é˜¿ä¸‰. All rights reserved.//#import &lt;UIKit/UIKit.h&gt;#import \"AppDelegate.h\"int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; int a = 10; NSString *name = @\"abc\"; ^&#123; NSLog(@\"%d--%@\",a,name); &#125;(); return 0; &#125;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109// CPPä»£ç /** __main_block_impl_0 -&gt; impl*/struct __block_impl &#123; void *isa; // è¯´æ˜blockæ˜¯ä¸ªOCå¯¹è±¡ int Flags; int Reserved; // void *FuncPtr; // å­˜å‚¨ç€ __main_block_func_0å‡½æ•°è°ƒç”¨çš„å†…å­˜åœ°å€ // __main_block_func_0: blockå†…éƒ¨ä»£ç å°è£…æˆçš„å‡½æ•°&#125;;/** block ç»“æ„ä½“*/struct __main_block_impl_0 &#123; struct __block_impl impl; // æ˜¯ä¸ªç»“æ„ä½“å˜é‡ï¼Œä¸æ˜¯æŒ‡é’ˆã€‚ struct __main_block_desc_0* Desc; // æ•è·çš„å˜é‡ int a; NSString *name; // æ„é€ å‡½æ•° (ç±»ä¼¼äºOCçš„initæ–¹æ³•)ï¼Œè¿”å›ç»“æ„ä½“å¯¹è±¡ï¼ˆ__main_block_impl_0ï¼‰ __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _a, NSString *_name, int flags=0) : a(_a), name(_name) &#123; impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; &#125;&#125;;/** blockå†…éƒ¨ä»£ç å°è£…æˆçš„å‡½æ•°*/static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123; int a = __cself-&gt;a; // bound by copy NSString *name = __cself-&gt;name; // bound by copy NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_g8_prk3m15j55xgythlcdcnj91c0000gn_T_main_f5d28b_mi_1,a,name); &#125;/** blockå†…éƒ¨å†…å­˜ç®¡ç†ç›¸å…³ä»£ç */ static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;name, (void*)src-&gt;name, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;/** blockå†…éƒ¨å†…å­˜ç®¡ç†ç›¸å…³ä»£ç */ static void __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;name, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;/** block æè¿°ä¿¡æ¯*/static struct __main_block_desc_0 &#123; size_t reserved; // è¯¥Blockå‡çº§åæ‰€å­˜æ”¾çš„åŒºåŸŸï¼Œæ ˆblock -&gt; å †block size_t Block_size; // blockå ç”¨å¤šå°‘å†…å­˜ void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*); void (*dispose)(struct __main_block_impl_0*);&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;/**mainå‡½æ•°*/int main(int argc, char * argv[]) &#123; // @autoreleasepool å†…å­˜ç®¡ç†ä¸­ä¼šé™åˆ°å®ƒçš„ä½œç”¨ /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; int a = 10; NSString *name = (NSString *)&amp;__NSConstantStringImpl__var_folders_g8_prk3m15j55xgythlcdcnj91c0000gn_T_main_f5d28b_mi_0; ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, a, name, 570425344))(); return 0; &#125;&#125;/************************* Blockç»“æ„ä½“çš„å¦å¤–ä¸€ç§å†™æ³• *************************/struct __main_block_impl_0 &#123; /********** impl ******/ void *isa; int Flags; int Reserved; void *FuncPtr; /********** impl ******/ struct __main_block_desc_0* Desc; int a; NSString *name; __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _a, NSString *_name, int flags=0) : a(_a), name(_name) &#123; impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; &#125;&#125;;/************** blockè°ƒç”¨**************/// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯blockï¼Œåé¢æ˜¯å‚æ•°.block -&gt;funPtr(myblock) blockè°ƒç”¨è¿‡ç¨‹: å½“blockè°ƒç”¨å¤–éƒ¨å±€éƒ¨å˜é‡æ—¶,ä¼šè¿›è¡Œå˜é‡æ•è·,é€šè¿‡__main_block_copy_0ã€__main_block_dispose_0å¯¹å˜é‡è¿›è¡Œå†…å­˜ç®¡ç†ã€‚blockå†…éƒ¨çš„ä»£ç ä¼šå°è£…æˆ__main_block_func_0å‡½æ•°ã€‚å¹¶å­˜å‚¨åˆ°__main_block_impl_0(blockç»“æ„ä½“)ä¸­çš„funPträ¸­ã€‚ Blockä½¿ç”¨åœºæ™¯ 12345678910111213141516171819202122232425262728#import \"Person.h\"@interface Person ()/**blockä½œä¸ºå±æ€§ä½¿ç”¨*/// è¿”å›å€¼(^åç§°)(å‚æ•°)@property (nonatomic ,copy) void(^myBlock)(void);@end@implementation Person- (void)testTask&#123; // ä¼ é€’block !self.myBlock?:self.myBlock();&#125;/**blockä½œä¸ºå‡½æ•°å‚æ•°*/// (è¿”å›å€¼ (^)(å‚æ•°)åç§°)- (void)makeBlockTask:(void (^)(NSString *))callback&#123; /**Tagger Pointer*/ NSString * str = @\"123\"; // æ‰§è¡Œblock callback(str);&#125;@end Blockç±»å‹ blockåˆ†ä¸ºä¸‰ç§ï¼Œå…¨å±€Blockã€æ ˆBlockã€å †Blockã€‚ iOSç¨‹åºåŠ è½½åˆ°å†…å­˜ä¸­,ç”±ä½åˆ°é«˜(å†…å­˜åœ°å€). åˆ†ä¸º ä¿ç•™åŒºã€_TEXT(ä»£ç æ®µ)ã€_DATA(æ•°æ®æ®µ)ã€heap(å †)ã€stack(æ ˆ)ã€å†…æ ¸åŒºã€‚ ä¿ç•™åŒº:ç”±äºç”¨åˆ°äº†ASLRæŠ€æœ¯(åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ã€iOS4.3å¼€å§‹)ã€‚ä¿ç•™åŒºåˆ†ä¸ºåç§»åŒºã€_PAGEZEROã€Header Load commands.å†…å­˜ç®¡ç†å’Œmach-Oæ–‡ä»¶ä¸­ä¼šè¯¦ç»†è¯´ï¼Œè¿™é‡Œåªéœ€è¦å…³æ³¨_DATA(æ•°æ®æ®µ)ã€heap(å †)ã€stack(æ ˆ)ã€‚ å…¨å±€Blockå­˜æ”¾åœ¨_DATA(æ•°æ®æ®µ)ï¼›æ ˆBlockå­˜åœ¨åœ¨stack(æ ˆ)ï¼›å †Blockå­˜æ”¾åœ¨heap(å †)ã€‚ clangç±»å‹ OCç±»å‹ å­˜å‚¨åŒºåŸŸ å†³å®šå› ç´ (ç¯å¢ƒ) _NSConcreteGlobalBlock _NSGlobalBlock_ é™æ€æ•°æ®åŒº æ²¡æœ‰è®¿é—®autoå˜é‡ _NSConcreteStackBlock _NSStackBlock_ æ ˆ è®¿é—®äº†autoå˜é‡ _NSConcreteMallocBlock _NSMallocBlock_ å † _NSStackBlock_è°ƒç”¨äº†copy Blockå˜é‡æ•è·(capture) Blockå˜é‡æ•è·çš„ç›®: ä¸ºäº†ä¿è¯Blockå†…éƒ¨èƒ½å¤Ÿæ­£å¸¸è®¿é—®å¤–éƒ¨çš„å˜é‡ã€‚ è¯´ç™½äº†å°±æ˜¯å—å¤–éƒ¨å˜é‡ä½œç”¨åŸŸå½±å“ åŸå› ï¼š å…¨å±€å˜é‡ï¼Œå…¨å±€éƒ½å¯ä»¥è®¿é—®ï¼Œä¸ä¼šå‡ºç°blockæ‰§è¡Œå‰è¢«é‡Šæ”¾é—®é¢˜ï¼Œæ‰€ä»¥ä¸éœ€è¦æ•è· å±€éƒ¨å˜é‡ autoï¼Œå¯èƒ½blockæ‰§è¡Œå‰å°±å‡ºäº†ä½œç”¨åŸŸè¢«é‡Šæ”¾ã€‚æ‰€ä»¥éœ€è¦å˜é‡æ•è· å±€éƒ¨å˜é‡ staticï¼Œé™æ€å˜é‡æ—¶å­˜æ”¾åœ¨_DATAæ•°æ®æ®µä¸­ï¼Œä¸ä¼šè¢«é‡Šæ”¾ã€‚ä½†æ˜¯ï¼ŒæŒ‡å‘å®ƒçš„æŒ‡é’ˆä¼šè¢«é‡Šæ”¾ã€‚blockä¼šè¿›è¡ŒæŒ‡é’ˆå¤åˆ¶ã€‚æ‰€ä»¥éœ€è¦å˜é‡æ•è· ä»£ç å¦‚ä¸‹: å…¨å±€å˜é‡: blockç»“æ„ä½“å†…å¹¶æ²¡æœ‰å…³äºå…¨å±€å­—ç¬¦ä¸²ç›¸å…³çš„ä¿¡æ¯ã€‚æ²¡æœ‰æ•è·(ç›´æ¥è®¿é—®) 1234567891011121314151617181920212223242526272829/********************** OC ***********************/NSString *name = @\"abc\";int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; ^&#123; NSLog(@\"%@\",name); &#125;(); return 0; &#125;&#125;/********************** cpp ***********************/// å®šä¹‰çš„å…¨å±€å­—ç¬¦ä¸²NSString *name = (NSString *)&amp;__NSConstantStringImpl__var_folders_g8_prk3m15j55xgythlcdcnj91c0000gn_T_main_aa8b72_mi_0;// blockç»“æ„ä½“struct __main_block_impl_0 &#123; struct __block_impl impl; struct __main_block_desc_0* Desc; __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123; impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; &#125;&#125;; å±€éƒ¨å˜é‡ auto: blockç»“æ„ä½“å†…ç”Ÿäº†ä¸€ä¸ªNSString *nameå­—ç¬¦ä¸²ã€‚è¿›è¡Œäº†å˜é‡æ•è·(å€¼ä¼ é€’) 12345678910111213141516171819202122232425262728/********************** OC ***********************/int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; // é»˜è®¤å‰é¢æ˜¯æœ‰ auto çš„ NSString *name = @\"abc\"; ^&#123; NSLog(@\"%@\",name); &#125;(); return 0; &#125;&#125;/********************** cpp ***********************/// å®šä¹‰çš„å…¨å±€å­—ç¬¦ä¸²struct __main_block_impl_0 &#123; struct __block_impl impl; struct __main_block_desc_0* Desc; NSString *name; // å…³æ³¨è¿™é‡Œ __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, NSString *_name, int flags=0) : name(_name) &#123; impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; &#125;&#125;; å±€éƒ¨å˜é‡ static: blockç»“æ„ä½“å†…ç”Ÿäº†ä¸€ä¸ªNSString *nameæŒ‡å‘å¤–éƒ¨staticä¿®é¥°æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ã€‚è¿›è¡Œäº†å˜é‡æ•è·(æŒ‡é’ˆä¼ é€’) 12345678910111213141516171819202122232425262728/********************** OC ***********************/int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; // é»˜è®¤å‰é¢æ˜¯æœ‰ auto çš„ NSString *name = @\"abc\"; ^&#123; NSLog(@\"%@\",name); &#125;(); return 0; &#125;&#125;/********************** cpp ***********************/// å®šä¹‰çš„å…¨å±€å­—ç¬¦ä¸²struct __main_block_impl_0 &#123; struct __block_impl impl; struct __main_block_desc_0* Desc; NSString *name; // å…³æ³¨è¿™é‡Œ __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, NSString *_name, int flags=0) : name(_name) &#123; impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; &#125;&#125;; Blockçš„copy ä¸‰ç§blockè¿›è¡Œcopyæ“ä½œçš„å˜åŒ–(å…¨å±€ã€å †ã€æ ˆ) block çš„ç±» å­˜å‚¨åŒºåŸŸ copyæ•ˆæœ _NSConcreteGlobalBlock æ•°æ®æ®µ ä»€ä¹ˆä¹Ÿä¸åš _NSConcreteStackBlock æ ˆ ä»æ ˆåˆ°å † _NSConcreteMallocBlock å † å¼•ç”¨è®¡æ•°å¢åŠ  ARCç¯å¢ƒä¸‹: ç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Š blockä½œä¸ºå‡½æ•°è¿”å›å€¼ blockè¢«å¼ºæŒ‡é’ˆå¼•ç”¨ blockä½œä¸ºCocoa APIä¸­æ–¹æ³•åå«æœ‰usingBlockçš„æ–¹æ³•å‚æ•°æ—¶ blockä½œä¸ºGCD APIçš„æ–¹æ³•å‚æ•°æ—¶ blockå±æ€§å»ºè®®ä¹¦å†™1234567891011/** MRCä¸‹ï¼Œblockéœ€è¦æ‰‹åŠ¨copy,å±æ€§copyä¼šåœ¨seettingæ–¹æ³•ä¸­å¯¹æ–°å€¼è¿›è¡Œcopyæ“ä½œ*/@property (copy, nonatomic) void(^myBlock)(void);/** ARCä¸‹ï¼Œç¼–è¯‘å™¨å·²ç»å°±è¡Œäº†è‡ªåŠ¨copyæ“ä½œï¼Œç”¨copyæˆ–strong æ¥ä¿®é¥°éƒ½å¯ä»¥*/@property (copy, nonatomic) void(^myBlock)(void);// å…³äºå±æ€§å…³é”®å­— è¯·çœ‹å†…å­˜ç®¡ç† blockè®¿é—® OCå¯¹è±¡ç±»å‹çš„autoå˜é‡ã€‚ å…¨å±€block_NSConcreteGlobalBlock æ–¹æ³•å˜é‡æ˜¯å®‰å…¨çš„ã€‚å› ä¸ºå®ƒå­˜å‚¨åœ¨æ•°æ®æ®µï¼Œå¹¶ä¸”å®ƒæ‰€è®¿é—®çš„å¤–éƒ¨å˜é‡ä¹Ÿæ˜¯å®‰å…¨çš„(éautoã€‚ä¸ä¼šæœ‰è¶…å‡ºä½œç”¨åŸŸçš„å±é™©)ã€‚æ‰€ä»¥å…¨å±€blockè¿›è¡Œcopyåè‡ªèº«æ²¡å˜åŒ–ï¼Œä¹Ÿä¸ä¼šå¯¹å®ƒè®¿é—®çš„å˜é‡äº§ç”Ÿå½±å“ã€ æ ˆblockNSConcreteStackBlock : æ ˆblockæ˜¯ä¸ä¼šå¯¹å¤–éƒ¨å˜é‡è¿›è¡Œå¼•ç”¨è®¡æ•°æ“ä½œçš„(å¼ºã€å¼±å¼•ç”¨)ï¼Œä¸ç®¡ä¿®é¥°è¯æ˜¯ï¼ˆ__strongã€__weakã€__unsafe__unretainedï¼‰,éƒ½æ˜¯å¼±å¼•ç”¨ã€‚ å½“å®ƒè¿›è¡Œcopyæ—¶ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°(_Block_object_assign()) _Block_object_assign()å‡½æ•°ä¼šæ ¹æ®autoå˜é‡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe__unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨(retain)æˆ–è€…å¼±å¼•ç”¨ã€‚ 12345678// copyå‡½æ•°static void __main_block_copy_0( struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;name, (void*)src-&gt;name, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125; å †block _NSConcreteMallocBlock ä¼šå¯¹è®¿é—®çš„å¤–éƒ¨å¯¹è±¡ç±»å‹çš„çš„autoå˜é‡ è¿›è¡Œå¼•ç”¨è®¡æ•°(å¼ºå¼±å¼•ç”¨æ“ä½œã€‚æ ¹æ®ä¿®é¥°è¯) Block ä¸OCå¯¹è±¡ç±»å‹çš„ä¿®é¥°è¯ __block __block å¯ä»¥ç”¨äºè§£å†³blockå†…éƒ¨æ— æ³•ä¿®æ”¹autoå˜é‡å€¼å¾—é—®é¢˜(autoå˜é‡é»˜è®¤ å˜é‡æ•è·å€¼ä¼ é€’) __block ä¸èƒ½ä¿®é¥°å…¨å±€å˜é‡ã€é™æ€å˜é‡(ç›´æ¥è®¿é—®ã€æŒ‡é’ˆä¼ é€’)ã€‚ 1234567891011121314#import &lt;UIKit/UIKit.h&gt;#import \"AppDelegate.h\"#import \"Person.h\"int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; // ä¿®é¥°åŸºæœ¬æ•°æ®ç±»å‹autoå˜é‡ __block int a = 10; // ä¿®é¥°OCå¯¹è±¡ç±»å‹autoå˜é‡ __block Person *p = [[Person alloc] init]; return 0; &#125;&#125; 12345678910111213141516171819202122232425#import &lt;UIKit/UIKit.h&gt;#import \"AppDelegate.h\"#import \"Person.h\"int b = 30; // å®šä¹‰å…¨å±€å˜é‡int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; //1 ä¿®é¥°é™æ€å˜é‡ // æŠ¥é”™: __block attribute not allowed, only allowed on local variables __block static int c = 20; //2 ä¿®é¥°OCå¯¹è±¡ç±»å‹autoå˜é‡ NSLog(@\"%p\",&amp;b); __block int b; NSLog(@\"%p\",&amp;b); /** æ‰“å°ç»“æœ: 2018-07-11 21:07:56.717418+0800 BlockDemo[2325:777978] 0x10c3ff1b8 2018-07-11 21:07:56.718018+0800 BlockDemo[2325:777978] 0x7ffee3803088 è¯æ˜__blockä¿®é¥°çš„ b ç›¸å½“äºæ–°å®šä¹‰çš„å˜é‡ */ return 0; &#125;&#125; __blockå®ç°åŸç† ç¼–è¯‘å™¨ä¼šå°†__blockå˜é‡åŒ…è£…æˆä¸€ä¸ªå¯¹è±¡ é€šè¿‡è§‚çœ‹ä¸‹é¢ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºautoå˜é‡è¢«åŒ…è£…æˆäº† __Block_byref_a_0 ç»“æ„ä½“(ç»“æ„ä½“åï¼š__Block_byref_å˜é‡å_0) 12345678910111213141516171819202122232425262728293031323334/*************************** oc ä»£ç  *****************************/ __block int age = 10;^&#123; NSLog(@\"%d\", age)&#125;();/*************************** cpp ä»£ç  *****************************/ int b = 30; // å®šä¹‰çš„å…¨å±€å˜é‡// autoå˜é‡ è¢«__blockåŒ…è£…æˆçš„ ç»“æ„ä½“struct __Block_byref_a_0 &#123; void *__isa;__Block_byref_a_0 *__forwarding; // æŒ‡å‘ç»“æ„ä½“è‡ªèº«çš„æŒ‡é’ˆ int __flags; int __size; int a; // __blockä¿®é¥°çš„ autoå˜é‡ã€‚æŒ‡å‘äº†å¤–éƒ¨çš„ &#125;;struct __main_block_impl_0 &#123; struct __block_impl impl; struct __main_block_desc_0* Desc; __Block_byref_a_0 *a; // è¿™é‡Œå‡ºç°äº†ä¸€ä¸ª __Block_byref_a_0 ç±»å‹çš„ç»“æ„ä½“æŒ‡é’ˆ __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, __Block_byref_a_0 *_a, int flags=0) : a(_a-&gt;__forwarding) &#123; impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; &#125;&#125;; __Block_byref_a_0å†…éƒ¨çš„auto å˜é‡: ä¸å¤–éƒ¨çš„åŒåautoå˜é‡(æ­¤å¤„æ˜¯å˜é‡ int a)æŒ‡å‘çš„å†…å­˜åœ°å€ä¸€æ ·ã€‚ å½“blockä»æ ˆcopyåˆ°å †æ—¶ï¼Œautoå˜é‡ä¹Ÿä¼šè¢«æ‹·è´åˆ°å †å†… __blockçš„å†…å­˜ç®¡ç† å½“blockåœ¨æ ˆä¸Šæ—¶ï¼Œå¹¶ä¸ä¼šå¯¹__blockå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨ åº”ä¸ºæ ˆblockçš„ç”Ÿå‘½å‘¨æœŸä¸autoå˜é‡çš„ç”Ÿå‘½å‘¨æœŸç›¸åŒï¼Œæ‰€ä»¥ä¸éœ€è¦å¼ºå¼•ç”¨ï¼Œä¸º__blockå˜é‡è¡ç”Ÿçš„ç»“æ„ä½“ä¿å‘½ å½“blockè¢«copyåˆ°å †æ—¶ ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•° copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°ã€‚ _Block_object_assignå‡½æ•°ä¼šå¯¹__blockå˜é‡å½¢æˆå¼ºå¼•ç”¨(retain) __main_block_copy_0å†…éƒ¨ä¼šè°ƒç”¨__Block_objct_assignå‡½æ•°ï¼Œæ­¤å‡½æ•°(åè€…)ä¼šæ ¹æ®æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®é¥°ç¬¦(__strongã€__weakã€__unsafe_unretained)åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨(retain)æˆ–è€…å¼±å¼•ç”¨(æ³¨æ„: è¿™é‡Œä»…é™äºARCæ—¶ï¼ŒMRCæ—¶ä¸ä¼šè‡ªåŠ¨retain) å½“blockä»å †ä¸­ç§»é™¤æ—¶ ä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•° disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨__Block_object_disposeå‡½æ•° _Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„__blockå˜é‡ï¼ˆreleaseï¼‰ __block çš„__forwardingæŒ‡é’ˆ12345678// __blockä¿®é¥° autoå˜é‡a ç”Ÿæˆçš„ç»“æ„ä½“struct __Block_byref_a_0 &#123; void *__isa;__Block_byref_a_0 *__forwarding; // forwardingæŒ‡é’ˆ int __flags; int __size; int a; &#125;; å…¨å±€block: ä¸ä¼šç”Ÿæˆæ¬¡ç»“æ„ä½“, å› ä¸ºå…¨å±€blockæ˜¯ä¸è®¿é—®autoå˜å˜é‡äº§ç”Ÿçš„ï¼Œè€Œ__Block_byref_a_0åªæœ‰åœ¨__blockä¿®é¥°autoå˜é‡æ—¶æ‰ä¼šäº§ç”Ÿã€‚ä¸¤è€…æ˜¯çŸ›ç›¾çš„ã€‚ æ ˆblock: __forwardingæŒ‡é’ˆæŒ‡å‘å®ƒçš„ç»“æ„ä½“æœ¬èº«ã€‚ å †block: å †blockæ˜¯æ ˆblockcopyäº†ä¸€ä»½æ”¾åˆ°äº†å †ä¸Šã€‚æ ˆblockçš„__forwardingæŒ‡é’ˆæŒ‡å‘å †blockçš„ __Block_byref_a_0ç»“æ„ä½“ï¼Œè€Œå †blockçš„__forwardingæŒ‡é’ˆæŒ‡å‘äº†å®ƒçš„ç»“æ„ä½“æœ¬èº«ã€ blockçš„å†…å­˜ç®¡ç†å‡½æ•°æ“ä½œ__main_block_copy_0ã€__main_block_dispose_0123456789101112// retainstatic void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;// releasestatic void __main_block_dispose_0(struct __main_block_impl_0*src)&#123;_Block_object_dispose((void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125; è¿™ä¸¤ä¸ªå‡½æ•°ä¼šæ ¹æ®æœ€åä¸€ä¸ªå¸¸é‡(æ­¤å¤„ä¸º 8)å†³å®šå¯¹ä¼ å…¥çš„å˜é‡(æ­¤å¤„ä¸º a)æ€æ ·è¿›è¡Œå†…å­˜ç®¡ç†(æ­¤å¤„æ˜¯ __blockå˜é‡) å¯¹è±¡ â€“ BLOCK_FIELD_IS_OBJECT (3) __block å˜é‡ â€“ BLOCK_FIELD_IS_BYREF (8) __weak __weakå¯ä»¥ç”¨äºè§£å†³blockå¾ªç¯å¼•ç”¨é—®é¢˜(ç”¨æ¥ä¿®é¥°OCå¯¹è±¡ï¼Œä¿®é¥°åŸºæœ¬æ•°æ®ç±»å‹ä¼šæŠ¥è­¦å‘Š) ç”¨æ³•å¦‚ä¸‹ 1__weak typeof(self) weakSelf = self; __weakä¿®é¥°çš„OCå˜é‡åœ¨blockç»“æ„ä½“å†…ä¼šæœ‰__weakæ ‡è®°ã€‚åœ¨è°ƒç”¨__main_block_copy_0ã€__main_block_dispose_0å‡½æ•°æ—¶ï¼Œè™½ç„¶ä¼ å…¥çš„å¸¸é‡ä¹Ÿæ˜¯3(BLOCK_FIELD_IS_OBJECT)ã€‚ä½†æ˜¯ä»–ä»¬å¯¹æ ‡è®°ä¸º__weakçš„OCå¯¹è±¡ä¸ä¼šè¿›è¡Œå¼•ç”¨è®¡æ•°æ“ä½œ(å¼ºå¼•ç”¨) __strong __strongçš„ä½œç”¨æ˜¯ç¡®ä¿blockå†…å…¶æ‰€ä¿®é¥°çš„OCå¯¹è±¡ä¸ä¼šè¢«é‡Šæ”¾ã€‚åœ¨è°ƒç”¨__main_block_copy_0ã€__main_block_dispose_0å‡½æ•°æ—¶ï¼Œä¼šå¯¹å…¶ä¿®é¥°çš„å¯¹è±¡è¿›è¡Œå¼•ç”¨è®¡æ•°ç›¸å…³çš„æ“ä½œã€‚ ç”¨æ³•å¦‚ä¸‹:12345678910111213141516int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; Person *P = [[Person alloc] init]; __weak typeof(P) weakP = P; void (^myBlock)(void) = ^&#123; __strong typeof(P) strongP = weakP; NSLog(@\"%@\",strongP.name); &#125;; myBlock(); return 0; &#125;&#125;","categories":[],"tags":[]},{"title":"Runtime","slug":"Runtime","date":"2018-07-03T01:52:06.000Z","updated":"2018-07-10T02:13:15.874Z","comments":true,"path":"2018/07/03/Runtime/","link":"","permalink":"http://PGGMan.github.io/2018/07/03/Runtime/","excerpt":"","text":"Runtime Objective-Cæ˜¯ä¸€é—¨åŠ¨æ€æ€§æ¯”è¾ƒå¼ºçš„å˜æˆè¯­è¨€ï¼Œè·ŸCã€C++ç­‰è¯­è¨€ç”±ç€å¾ˆå¤§çš„ä¸åŒ Objective-Cçš„åŠ¨æ€æ€§æ˜¯ç”±Runtime APIæ¥æ”¯æ’‘çš„ Runtime APIæä¾›çš„å€Ÿå£åŸºæœ¬éƒ½æ˜¯Cè¯­è¨€çš„ï¼Œæºç ç”±C\\C++æ±‡ç¼–è¯­è¨€ç¼–å†™ isaæŒ‡é’ˆ è¦æƒ³å­¦ä¹ Runtime,é¦–å…ˆè¦äº†è§£å®ƒçš„åº•å±‚çš„ä¸€äº›å¸¸ç”¨æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚isaæŒ‡é’ˆ åœ¨arm64ä¹‹å‰ï¼Œisaå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„æŒ‡é’ˆï¼Œå­˜å‚¨ç€Classã€Meta-Classå¯¹è±¡çš„å†…å­˜åœ°å€ ä»arm64ä¹‹åï¼Œå¯¹isaè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå˜æˆäº†ä¸€ä¸ªå…±ç”¨ä½“(union)ç»“æ„ï¼Œè¿˜ä½¿ç”¨ä½åŸŸ(: 1 (å ç”¨ä¸€ä½))æ¥å­˜ å‚¨æ›´å¤šçš„ä¿¡æ¯ isaæŒ‡é’ˆç»“æ„ 12345678910111213141516171819202122/** arm64 æ¶æ„ */union isa_t &#123; isa_t() &#123; &#125; isa_t(uintptr_t value) : bits(value) &#123; &#125; Class cls; uintptr_t bits; struct &#123; uintptr_t nonpointer : 1; // æ˜¯å¦æ˜¯ä¼˜åŒ–è¿‡çš„isaæŒ‡é’ˆã€‚0:ä»£è¡¨æ™®é€šæŒ‡é’ˆï¼Œå­˜å‚¨ç€Class / Meta-Classå¯¹è±¡çš„å†…å­˜åœ°å€ï¼›1: ä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå’Œå…±ç”¨ä½“å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ã€‚ uintptr_t has_assoc : 1; // æ˜¯å¦è®¾ç½®è¿‡å…³è”å¯¹è±¡ã€‚è‹¥æ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«(releaseæºç ä¸­ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰å¥½å‡ ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ‰ä¼šé‡Šæ”¾æ›´å¿«) uintptr_t has_cxx_dtor : 1; // è¡¨ç¤ºè¯¥å¯¹è±¡æ˜¯å¦æœ‰ C++ çš„ææ„å‡½æ•°ï¼Œè‹¥æ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«.(releaseæºç ä¼šåˆ¤æ–­ï¼Œåªæœ‰å¥½å‡ ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ‰ä¼šé‡Šæ”¾æ›´å¿«) uintptr_t shiftcls : 33; // å­˜å‚¨ç€Class / Meta-Classå¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯(ç›¸å½“äºæ™®é€šisaæŒ‡é’ˆçš„ä½œç”¨) uintptr_t magic : 6; // ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ– uintptr_t weakly_referenced : 1; // æ˜¯å¦æœ‰è¢«è‹¥æŒ‡é’ˆæŒ‡å‘è¿‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿« uintptr_t deallocating : 1; // å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾ uintptr_t has_sidetable_rc : 1; // å¼•ç”¨è®¡æ•°å™¨æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨isaä¸­ã€‚è‹¥ä¸º1ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå«sideTableçš„ç±»å±æ€§ä¸­(å†…å­˜ç®¡ç†ä¸­ä¼šæåˆ°) uintptr_t extra_rc : 19; // ç”¨19ä½æ¥å­˜å‚¨è®¡æ•°å™¨ç›¸å…³æ•°æ®,è¶…å‡ºåä¼šå­˜å‚¨äº has_sidetable_rcç»“æ„ä½“å†…(N - 1) &#125;;&#125; Class ç»“æ„å›¾å¦‚ä¸‹ objc_classç»“æ„ä½“ Classçš„åº•å±‚å®ç°:objc_class 123456struct objc_class &#123; Class isa; // class / Meta-calss æŒ‡é’ˆ Class superclass; // çˆ¶ç±»æŒ‡é’ˆ cache_t cache; // æ–¹æ³•ç¼“å­˜ (å“ˆå¸Œè¡¨) class_data_bits_t bits; // ç”¨äºè·å–å…·ä½“çš„ç±»ä¿¡æ¯&#125; FAST_DATA_MASK æ©ç ,objc_classä¸­çš„bitså±æ€§&amp;(äº) FAST_DATA_MASK å¯ä»¥è·å–åˆ° class_rw_t cç»“æ„ä½“ class_rw_tç»“æ„ä½“ objc_class -&gt; bits -&gt; data() å­˜å‚¨ç±» åŠ è½½å®Œæˆ åçš„ç›¸å…³ä¿¡æ¯ã€‚æ­¤ç»“æ„ä½“æ˜¯ç±»åŠ è½½çš„æ—¶å€™åˆ›å»ºçš„(ä¾‹å¦‚ é‡Œé¢çš„æ–¹æ³•åˆ—è¡¨ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼Œä¸å…‰å­˜å‚¨ç€å½“å‰ç±»çš„ï¼Œè€Œä¸”è¿˜åŒ…æ‹¬åˆ†ç±»çš„ã€çˆ¶ç±»çš„) 12345678910111213141516171819struct class_rw_t&#123; uint32_t flags; uint32_t version; const class_ro_t *ro; // å­˜å‚¨ç€ç±»ä¸­å®šä¹‰çš„æˆå‘˜å˜é‡ã€æ–¹æ³•ã€åè®®ç­‰ä¿¡æ¯(åªè¯») method_list_t * methods; // æ–¹æ³•åˆ—è¡¨(åˆ†ç±» + (ro -&gt; baseMethodList)) æ³¨æ„é¡ºåºï¼Œåˆ†ç±»åœ¨å‰ property_list_t * properties; // å±æ€§åˆ—è¡¨(åˆ†ç±» + (ro -&gt; ivars)) æ³¨æ„é¡ºåºï¼Œåˆ†ç±»åœ¨å‰ property_list_t * protocols; // åè®®åˆ—è¡¨(åˆ†ç±» + (ro -&gt; baseProtocols)) æ³¨æ„é¡ºåºï¼Œåˆ†ç±»åœ¨å‰(åªè¯») Class firstSubclass; Class nextSiblingClass; char *demangledName; // æ˜¯è®¡ç®—æœºè¯­è¨€ç”¨äºè§£å†³å®ä½“åç§°å”¯ä¸€æ€§çš„ä¸€ç§æ–¹æ³•ï¼Œåšæ³•æ˜¯å‘åç§°ä¸­æ·»åŠ ä¸€äº›ç±»å‹ä¿¡æ¯ï¼Œç”¨äºä»ç¼–è¯‘å™¨ä¸­å‘é“¾æ¥å™¨ä¼ é€’æ›´å¤šè¯­ä¹‰ä¿¡æ¯ã€‚&#125; /** firstSubclass ä¸ nextSiblingClass åœ¨ static inline void foreach_realized_class_and_subclass( Class top, std::function&lt;void (Class)&gt; code) ä¸­ç”¨åˆ°ï¼Œæ­¤å‡½æ•°æ˜¯ä½œç”¨æ˜¯ Enumerates a class and all of its realized subclasses. */ class_ro_tç»“æ„ä½“ class_rw_t -&gt; ro æ­¤ç»“æ„ä½“å­˜å‚¨ç€å½“å‰ç±»çš„ç›¸å…³ä¿¡æ¯ 12345678910111213141516171819202122struct class_ro_t &#123; uint32_t flags; uint32_t instanceStart; // å®ä¾‹å¯¹è±¡çš„å†…å­˜åœ°å€(èµ·ç‚¹) uint32_t instanceSize; // (instance)å®ä¾‹å¯¹è±¡å ç”¨çš„å†…å­˜ç©ºé—´#ifdef __LP64__ uint32_t reserved;#endif const uint8_t * ivarLayout; // æˆå‘˜å˜é‡çš„å¸ƒå±€æ–¹å¼(å†…å­˜å¯¹é½åŠ è½½åˆ°å†…å­˜å’Œé‡Šæ”¾çš„æ—¶å€™éƒ½éœ€è¦ç”¨åˆ°å®ƒæ¥è®¡ç®—åŒºåŸŸ) const char * name; // ç±»å method_list_t * baseMethodList; // æ–¹æ³•åˆ—è¡¨(å½“å‰ç±»ä¸­å®šä¹‰çš„æˆå‘˜å˜é‡) protocol_list_t * baseProtocols; // åè®®åˆ—è¡¨ const ivar_list_t * ivars; // æˆå‘˜å˜é‡åˆ—è¡¨(åªè¯») const uint8_t * weakIvarLayout; // å¼±æˆå‘˜å˜é‡çš„å¸ƒå±€æ–¹å¼(å†…å­˜å¯¹é½ï¼Œé‡Šæ”¾å¯¹è±¡çš„æ—¶å€™ç”¨æ¥è®¡ç®—é‡Šæ”¾å†…å­˜åŒºåŸŸçš„ã€‚åŸæ¥ä»¥ä¸ºæ˜¯å“ˆå¸Œè¡¨çš„æ©ç ï¼Œå¹¸äºæŸ¥äº†åŠå¤©èµ„æ–™,æœ€ååœ¨è‹¹æœå¼€å‘è€…æ–‡æ¡£ä¸­æ‰¾åˆ°äº†ç›¸å…³çš„èµ„æ–™) property_list_t *baseProperties; // å±æ€§åˆ—è¡¨(å½“å‰ç±»ä¸­å®šä¹‰çš„å±æ€§) method_list_t *baseMethods() const &#123; // baseMethodList return baseMethodList; &#125;&#125; method_tç»“æ„ä½“ class_rw_té‡Œé¢çš„methodsã€propertiesã€protocolsæ˜¯äºŒç»´æ•°ç»„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹å†…å®¹ã€åˆ†ç±»çš„å†…å®¹(åˆ†ç±»åœ¨å‰)* åˆ†ç±»åœ¨å‰: ç¼–è¯‘æ—¶ï¼Œæ˜¯ç°å°†class_ro_tä¸­çš„ä¿¡æ¯æ‹·è´è¿‡æ¥ï¼Œç„¶åé€šè¿‡åˆ†ç±»ä¿¡æ¯é•¿åº¦ï¼ŒæŠŠæ•°ç»„å†…å®¹å‘åç§»åŠ¨ä½ç½®ï¼ŒæŠŠåˆ†ç±»ä¿¡æ¯æ”¾åˆ°å‰é¢ class_ro_té‡Œé¢çš„baseMethodListã€baseProtocolsã€ivarsã€basePropertiesæ˜¯ä¸€ç»´æ•°ç»„ï¼Œæ˜¯åªè¯»çš„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹å†…å®¹ class_rw_tå’Œclass_ro_tä¸­éƒ½åŒ…å«ç€method_tç»“æ„ä½“(æ–¹æ³•ç»“æ„ä½“) 12345struct method_t &#123; SEL name; // æ–¹æ³•å const char *types; // ç¼–ç (è¿”å›å€¼ç±»å‹ã€å‚æ•°ç±»å‹ã€‚å…³æ³¨ä¸€ä¸‹@encodeæŒ‡ä»¤) IMP imp; // æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ (å‡½æ•°åœ°å€)&#125; IMPä»£è¡¨å‡½æ•°çš„å…·ä½“å®ç° SELä»£è¡¨æ–¹æ³•\\å‡½æ•°åï¼Œä¸€èˆ¬å«åšé€‰æ‹©å™¨,åº•å±‚ç»“æ„è·Ÿchar *ç±»ä¼¼ å¯ä»¥é€šè¿‡@selector()å’Œsel_registerName(char *)è·å¾— å¯ä»¥é€šè¿‡sel_getName()å’ŒNSStringFromSelector()è½¬æˆå­—ç¬¦ä¸² ä¸åŒç±»ä¸­çš„ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œæ‰€å¯¹åº”çš„é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„ã€‚ typesåŒ…å«äº†å‡½æ•°è¿”å›å€¼ï¼Œå‚æ•°ç¼–ç çš„å­—ç¬¦ä¸² æ–¹æ³•æŸ¥æ‰¾ æ–¹æ³•æŸ¥æ‰¾å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ† 1 æ˜¯æœ‰å…³äºæ–¹æ³•ç¼“å­˜ 2 æ–¹æ³•åˆ—è¡¨åŠçˆ¶ç±»æŸ¥æ‰¾ æ–¹æ³•ç¼“å­˜ objc_class -&gt; cache Classå†…éƒ¨ç»“æ„ä¸­æœ‰ä¸ªæ–¹æ³•ç¼“å­˜cache(cache_t),ç”¨æ•£åˆ—è¡¨(å“ˆå¸Œè¡¨)æ¥ç¼“å­˜æ›¾ç»è°ƒç”¨è¿‡å¾—æ–¹æ³•ï¼Œå¯ä»¥æé«˜æ–¹æ³•æŸ¥æ‰¾çš„é€Ÿåº¦ 1234567891011121314// cachestruct cache_t &#123; struct bucket_t *_buckets; //æ•£åˆ—è¡¨ mask_t _mask; // ç¼–ç (è¿”å›å€¼ç±»å‹ã€å‚æ•°ç±»å‹ã€‚å…³æ³¨ä¸€ä¸‹@encodeæŒ‡ä»¤) mask_t _occupied; // å·²ç»ç¼“å­˜çš„æ–¹æ³•æ•°é‡ &#125; // bucket_tstruct bucket_t &#123; cache_key_t _key; // SELä½œä¸ºkey (_key = SEL &amp; _mask) IMP _imp; // å‡½æ•°çš„å†…å­˜åœ°å€ &#125; å½“æ–¹æ³•/è¢«è°ƒç”¨åå°±ä¼šå­˜å‚¨åˆ°cacheæ•£åˆ—è¡¨ä¸­ï¼Œè°ƒç”¨è€…ç±»ä¸­æ²¡æœ‰ä¼šé€šè¿‡superClassæŒ‡é’ˆå»çˆ¶ç±»æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åä¼šå­˜å‚¨åˆ°è°ƒç”¨è€…çš„cacheæ•£åˆ—è¡¨ä¸­ cacheçš„å®ç°åŸç†æ˜¯ç©ºé—´æ¢æ—¶é—´ï¼ŒSEL&amp;_mask(æ©ç )å¾—åˆ°è§’æ ‡ï¼Œç›´æ¥é€šè¿‡è§’æ ‡å»IMPï¼Œå­˜å‚¨çš„è¿‡ç¨‹ä¸­:å‘ç°å½“å‰è§’æ ‡ä¸‹å·²ç»æœ‰IMPä¼šå‘ä¸Šç§»åŠ¨å½“å‰è§’æ ‡ï¼Œåˆ°æœ€å‰é¢åä¼šä»å°¾éƒ¨ç»§ç»­æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä½ç½®ä¸ºæ­¢ã€‚å½“æ‰¾ä¸åˆ°ä¸ºæ­¢å°±ä¼šæ”¾å¼ƒå½“å‰cacheå†…å­˜ç©ºé—´ï¼Œä»æ–°å»ºç«‹ä¸€ä¸ªå“ˆå¸Œè¡¨å¹¶ä¸”æ‰©å®¹ã€‚ objc_msgSendæ‰§è¡Œæµç¨‹ runtimeçš„æºç åŸºæœ¬æ˜¯ç”±C C++ å’Œæ±‡ç¼–å®ç°çš„ï¼Œå‘ä¸€äº›è°ƒç”¨é¢‘æ¬¡é«˜(objc_msgSend)æ˜¯ç”¨æ±‡ç¼–å®ç°çš„ æºç  ENTRY(å®)å…¥å£ 12345678910/** objc_msgSend(p,sel_registerName(\"eat\")) å†…éƒ¨å®ç°: ï¼ˆæ±‡ç¼–ï¼‰ 1.å…ˆåˆ¤æ–­ p(æ¶ˆæ¯æ¥æ”¶è€…) æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ç›´æ¥é€€å‡ºå‡½æ•°è°ƒç”¨ 2.è‹¥receiver(p)å­˜åœ¨ï¼Œ å»è¯»å–ç¼“å­˜.å¦‚æœå­˜åœ¨å°±ç›´æ¥è°ƒç”¨ 3.è‹¥ç¼“å­˜ä¸­æ²¡æœ‰å‡½æ•°,ä¼šå»è°ƒç”¨å¦ä¸€ä¸ªå®ï¼Œå†å»æŸ¥çœ‹ä¸€ä¸‹ç¼“å­˜(ä»¥é˜²æ‰‹åŠ¨æ·»åŠ æ–¹æ³•) 4.å½“è¿™æ¬¡æŸ¥ç¼“å­˜ä¹Ÿæ²¡æœ‰æ‰¾åˆ°æ–¹æ³•æ—¶ï¼Œå»éå†æ–¹æ³•åˆ—è¡¨é‡Œé¢æ‰¾(å¦‚æœæ’å¥½åºçš„äºŒåˆ†æŸ¥æ‰¾ï¼Œæ²¡æœ‰æ’å¥½åºçš„çº¿æ€§æŸ¥æ‰¾),æ‰¾åˆ°æ–¹æ³•åè¾¹æ–¹æ³•å¡«å……åˆ°ç¼“å­˜ */ æºç å¦‚ä¸‹ æµç¨‹å¦‚ä¸‹ objc_msgSendåŠ¨æ€è§£æ å½“objc_msgSend()æŸ¥æ‰¾æ–¹æ³•å¤±è´¥åï¼Œå°±ä¼šæ¥åˆ°æ­¤æ­¥ æµç¨‹å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495/************************ Main.m ************************/#import &lt;UIKit/UIKit.h&gt;#import \"AppDelegate.h\"#import \"Student.h\"int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; Student *p = [[Student alloc] init]; [p test]; [Student eat]; return 0; &#125;&#125;/*********************** .h *************************/#import \"Person.h\"@interface Student : Person- (void)test;+ (void)eat;@end/************************ .m ************************///// Student.m// RuntimeDemo//// Created by å°åº¦é˜¿ä¸‰ on 2015/5/27.// Copyright Â© 2018å¹´ å°åº¦é˜¿ä¸‰. All rights reserved.//#import \"Student.h\"#import &lt;objc/runtime.h&gt;@implementation Student+ (BOOL)resolveInstanceMethod:(SEL)sel&#123; //1 åˆ¤æ–­æ˜¯å¦æ˜¯æƒ³è¦å®ç°çš„æ–¹æ³• if (sel == sel_registerName(\"test\")) &#123; // 2 åˆ›å»ºMethod æ¶ˆæ¯å¯¹è±¡ Method method = class_getInstanceMethod(self, @selector(other)); /** 1 è¢«æ·»åŠ æ–¹æ³•çš„ç±»å¯¹è±¡ 2 æ·»åŠ çš„æ–¹æ³•å SEL 3 æ·»åŠ çš„æ–¹æ³•åœ°å€ IMP 4 æ·»åŠ çš„æ–¹æ³•Types (å­—ç¬¦ä¸²ç»„æˆï¼›é‡Œé¢åŒ…å«è¿”å›å€¼ç±»å‹ã€å‚æ•°ç±»å‹) */ class_addMethod(self, sel, method_getImplementation(method), method_getTypeEncoding(method)); return YES; &#125; return [super resolveInstanceMethod:sel];&#125;+ (BOOL)resolveClassMethod:(SEL)sel&#123; // 1åˆ¤æ–­æ˜¯å¦æ˜¯è¦å®ç°çš„ç±»æ–¹æ³• // sel_registerName(\"eat\") ç­‰ä»·äº @selector(@\"eat\") if (sel == sel_registerName(\"eat\")) &#123; // 2åˆ›å»ºç±»æ–¹æ³• Method method = class_getClassMethod(self, sel_registerName(\"classError\")); /** 1 è¢«æ·»åŠ æ–¹æ³•çš„å…ƒç±»å¯¹è±¡ |_(æ³¨æ„æ˜¯ meta-class)_| 2 æ·»åŠ çš„æ–¹æ³•å SEL 3 æ·»åŠ çš„æ–¹æ³•åœ°å€ IMP 4 æ·»åŠ çš„æ–¹æ³•Types (å­—ç¬¦ä¸²ç»„æˆï¼›é‡Œé¢åŒ…å«è¿”å›å€¼ç±»å‹ã€å‚æ•°ç±»å‹) */ class_addMethod(objc_getMetaClass(class_getName(self)), sel, method_getImplementation(method), method_getTypeEncoding(method)); // æ ‡è®°å·²ç»è§£æ return YES; &#125; // æ²¡æœ‰è§£æ return [super resolveClassMethod:sel];&#125;- (void) other&#123; NSLog(@\"%s\",__func__); &#125;+ (void)classError&#123; NSLog(@\"%s\",__func__);&#125;@end objc_msgSendæ¶ˆæ¯è½¬å‘ å½“æ¶ˆæ¯è§£æå¤±è´¥åä¼šæ¥åˆ°æ­¤æ­¥ æµç¨‹å¦‚ä¸‹ 123456789101112131415161718192021// å¤‡èƒæ–¹æ³•: éœ€è¦è¿”å›ä¸€ä¸ªå¯ä»¥å¤„ç†æ–¹æ³•çš„å¯¹è±¡/ç±»å¯¹è±¡// å¯¹è±¡æ–¹æ³• èµ°è¿™é‡Œ // (å¯¹è±¡æ–¹æ³•æ‰¾ä¸åˆ°ä¼šè°ƒç”¨ç”¨æ­¤æ–¹æ³•)- (id)forwardingTargetForSelector:(SEL)aSelector&#123; if (aSelector == sel_registerName(\"test\")) &#123; return [[Car alloc] init]; &#125; return [super forwardingTargetForSelector:aSelector];&#125;// ç±»æ–¹æ³• èµ°è¿™é‡Œ// (ç±»æ–¹æ³•æ‰¾ä¸åˆ°ä¼šç›—ç”¨æ­¤æ–¹æ³•)+ (id)forwardingTargetForSelector:(SEL)aSelector&#123; if (aSelector == sel_registerName(\"eat\")) &#123; return [[Car alloc] init]; // objc_sendMsg([[Car alloc] init], \"eat\") &#125; // å¦‚æœæ²¡æœ‰è¿”å› return [super forwardingTargetForSelector:aSelector];&#125; 123456789101112131415161718192021222324252627282930313233// æ¶ˆæ¯ç­¾å: ä¸ç­¾åç›´æ¥è°ƒç”¨doesNotRecognizeSelectoræ–¹æ³•å´©æºƒï¼›å®ç°åä¼šè°ƒç”¨forwardæ–¹æ³•// å¯¹è±¡æ–¹æ³• // è‡ªå·±å®ç°æ­¤æ–¹æ³•ï¼Œ(å¯¹è±¡æ–¹æ³•ç­¾å)- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector&#123; if (aSelector == sel_registerName(\"test\")) &#123; return [NSMethodSignature signatureWithObjCTypes:\"v@:\"];; &#125; return [super methodSignatureForSelector:aSelector];&#125;// ç±»æ–¹æ³• // è‡ªå·±å®ç°æ­¤æ–¹æ³•ï¼Œ(å¯¹è±¡æ–¹æ³•ç­¾å)+ (NSMethodSignature *)instanceMethodSignatureForSelector:(SEL)aSelector&#123; if (aSelector == sel_registerName(\"test\")) &#123; return [NSMethodSignature signatureWithObjCTypes:\"v@:\"];; &#125; return [super instanceMethodSignatureForSelector:aSelector];&#125;/**********************************************************************/// å¯¹è±¡æ–¹æ³• èµ°è¿™é‡Œ- (void)forwardInvocation:(NSInvocation *)anInvocation&#123; // é‡Œé¢å¯ä»¥ä¸åšæ“ä½œï¼Œä½†æ˜¯å¿…é¡»å®ç°æ­¤æ–¹æ³•ï¼Œ // è‹¥ä¸å®ç°: unrecognized selector sent to instance &#125;// ç±»æ–¹æ³• èµ°è¿™é‡Œ+ (void)forwardInvocation:(NSInvocation *)anInvocation&#123; NSLog(@\"122342525\"); &#125; Runtime - API12 é¢è¯•é¢˜ç›¸å…³ 1 - è®²ä¸€ä¸‹æ¶ˆæ¯è½¬å‘æœºåˆ¶ 12 2 - æ¶ˆæ¯è½¬å‘æœºåˆ¶æµç¨‹ 12 3 - ä»€ä¹ˆæ˜¯Runtime? å¹³æ—¶é¡¹ç›®ä¸­æœ‰ç”¨è¿‡å— ? OCæ˜¯ä¸€é—¨åŠ¨æ€æ€§æ¯”è¾ƒå¼ºçš„ç¼–ç¨‹è¯­è¨€ï¼Œå…è®¸å¾ˆå¤šæ“ä½œæ¨è¿Ÿåˆ°ç¨‹åºè¿è¡Œæ—¶å†è¿›è¡Œã€‚ OCçš„åŠ¨æ€æ€§å°±æ˜¯ç”±Runtimeæ¥æ”¯æ’‘å’Œå®ç°çš„ï¼ŒRuntimeæ˜¯ä¸€å¥—Cè¯­è¨€çš„APIï¼Œå°è£…äº†å¾ˆå¤šåŠ¨æ€æ€§ç›¸å…³çš„å‡½æ•° å¹³æ—¶ç¼–å†™çš„OCä»£ç ï¼Œåº•å±‚éƒ½æ˜¯è½¬æ¢æˆäº†Runtime APIè¿›è¡Œè°ƒç”¨ * åˆ©ç”¨å…³è”å¯¹è±¡(AssociatedObject)ç»™åˆ†ç±»æ·»åŠ å±æ€§ * éå†ç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡(ä¿®æ”¹textFieldçš„å ä½æ–‡å­—é¢œè‰²ã€å­—å…¸è½¬æ¨¡å‹ã€è‡ªåŠ¨å½’æ¡£è§£æŒ¡) * äº¤æ¢æ–¹æ³•(å®ç°hookç³»ç»Ÿæ–¹æ³•åŠŸèƒ½) * æ¶ˆæ¯è½¬å‘æœºåˆ¶è§£å†³æ–¹æ³•æ‰¾ä¸åˆ°çš„å¼‚å¸¸é—®é¢˜(weakåº•å±‚å®ç°ä¹Ÿæ˜¯ä¾èµ–äºruntime) * ....... 4 - ä¸‹é¢ä¸€æ®µä»£ç æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687@interface Studenrt : Person- (void) test;@end@implementation Student- (void)test1&#123; NSLog(@\"%@\",[self class]); NSLog(@\"%@\",[super class]);&#125;- (void)test2&#123; BOOL rest1 = [[NSObject class] isKindOfClass:[NSObject class]]; BOOL rest2 = [[NSObject class] isMemberOfClass:[NSObject class]]; BOOL rest3 = [[Person class] isKindOfClass:[Person class]]; BOOL rest4 = [[Person class] isMemberOfClass:[Person class]]; NSLog(@\"%d %d %d %d\",rest1,rest2,rest3,rest4);&#125;@end`/** test1ç­”æ¡ˆ: [self class] é€šè¿‡isaæŒ‡é’ˆæ‰¾åˆ°ç±»å¯¹è±¡: Student [super class] é€šè¿‡isaæŒ‡é’ˆæ‰¾åˆ°ç±»å¯¹è±¡: å†é€šè¿‡superClassæŒ‡é’ˆæ‰¾åˆ°çˆ¶ç±» person*/``/** test2ç­”æ¡ˆ: æ‰“å°ç»“æœä¸º 1 0 0 0 \"isKindOfClass:\" ç”¨æ¥åˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦å±äºæŸä¸ªç±»ï¼Œæˆ–è€…æ˜¯å±äºæŸä¸ªæ´¾ç”Ÿç±»ã€‚\"isMemberOfClass:\" ç”¨æ¥åˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦ä¸ºå½“å‰ç±»çš„å®ä¾‹psï¼š sMemberOfClassä¸èƒ½æ£€æµ‹ä»»ä½•çš„ç±»éƒ½æ˜¯åŸºäºNSObjectç±»è¿™ä¸€äº‹å®ï¼Œ è€ŒisKindOfClasså¯ä»¥ã€‚*/5 - ä»¥ä¸‹ä»£ç èƒ½ä¸èƒ½æ‰§è¡ŒæˆåŠŸï¼Ÿå¦‚æœå¯ä»¥ï¼Œæ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ@interface Studenrt : NSObject@property (nonatomic, copy) NSString *name;- (void)print;@end@implementation Student- (void)print&#123; NSLog(@\"my name's %@\", self.name);&#125;@end/****/@implementation ViewController- (void)viewDidLoad&#123; [super viewDidLoad]; id cls = [Person class]; void *objc = &amp;cls; [(__bridge id)obj print];&#125;/**ç­”æ¡ˆ: èƒ½æ‰§è¡Œï¼Œæ‰§è¡Œç»“æœæ˜¯: my name's &lt;ViewController: 0x60c0000e1a00&gt; åŸå› ï¼š */@end 5 - ä½ äº†è§£isaæŒ‡é’ˆå— 1234/** ç­”: isaæŒ‡é’ˆåœ¨arm64ä¹‹å‰æ˜¯å­˜å‚¨ Class / Meta-classåœ°å€å€¼çš„æŒ‡é’ˆï¼›ä¹‹åisaåˆ©ç”¨åˆ°äº†å…±ç”¨ä½“(union)çš„æ•°æ®ç»“æ„ï¼Œç”¨64ä½(8ä¸ªå­—èŠ‚)æ¥å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯, å…¶ä¸­33ä½æ˜¯å­˜å‚¨Class / Meta-Classåœ°å€ä¿¡æ¯ï¼Œå…¶ä»–å­˜å‚¨å…¶ä»–ä¸€äº›ä¿¡æ¯*/ 1 - è®²ä¸€ä¸‹OCçš„æ¶ˆæ¯æœºåˆ¶ 1 OCä¸­æ–¹æ³•çš„è°ƒç”¨å…¶å®éƒ½æ˜¯è½¬æˆäº†objc_msgSendå‡½æ•°çš„è°ƒç”¨ï¼Œç»™receiver(æ–¹æ³•è°ƒç”¨è€…)å‘é€äº†ä¸€æ¡æ¶ˆæ¯(selectoræ–¹æ³•å) 2 objc_msgSendåº•å±‚æœ‰3å¤§é˜¶æ®µ - æ¶ˆæ¯å‘é€(å½“å‰ç±»ã€çˆ¶ç±»ä¸­æŸ¥æ‰¾) - åŠ¨æ€æ–¹æ³•è§£æ - æ¶ˆæ¯è½¬å‘ 2 - @dynamicä¸@synthesize 3 - isKingOfClass ä¸ isMemeberOfClassçš„åŒºåˆ« isKindOfClass ä¼šé€šè¿‡superclassæŒ‡é’ˆå¾€ä¸Šæ‰¾ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å…¶æˆ–è€…å…¶å­ç±»å®ä¾‹å¯¹è±¡ isMemeberOfClass åªé€šè¿‡isaæŒ‡é’ˆåªåˆ¤æ–­å½“å‰ç±»å¯¹è±¡ 4 - super åšäº†ä»€ä¹ˆ, [super classs] æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆ 1234567891011121314151617181920212223242526272829// super åº•å±‚æºç struct objc_super&#123; __unsafe_unretained _Nonnull id receiver // æ–¹æ³•æ¥æ”¶è€… __unsafe_unretained_Nonnull Class super_class // æ¶ˆæ¯æ¥æ”¶è€…çš„çˆ¶ç±»:å®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰å‡½æ•°æ‰¾æ–¹æ³•æ—¶,ä»çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨é‡Œå¼€å§‹æ‰¾&#125;- (void)test&#123; [super run]; /** struct objc_super arg = &#123;self, [Person class]&#125;; // Personä¸ºsuoerçš„çˆ¶ç±»ç±»å¯¹è±¡ objc_msgSendSuper(arg, sel_registerName(\"run\")); */&#125;/**classåº•å±‚å®ç°*/- (Class) class:(id)receiver (SEL)__cmd&#123; return object_getClass(\"self\")&#125;/**superclassåº•å±‚å®ç°*/- (Class) superclass:(id)receiver (SEL)__cmd&#123; return class_getSuperclass(object_getClass(self));&#125; superåº•å±‚è°ƒç”¨äº†objc_sendSendSuper(,)å‡½æ•°ï¼›[super classs]æ‰“å°ç»“æœæ˜¯ Person(selfçš„çˆ¶ç±»)ï¼Œclassçš„åº•å±‚è°ƒç”¨æ—¶object_getClass()å‡½æ•°ï¼Œæ¶ˆæ¯æ¥æ”¶è€…æ˜¯self.æ‰€ä»¥ä¼šæœ‰æ­¤ç»“æœ superçš„è°ƒç”¨ï¼Œæ¶ˆæ¯æ¥æ”¶è€…ä»ç„¶æ˜¯å½“å‰å¯¹è±¡ï¼ŒæŸ¥æ‰¾æ–¹æ³•æ˜¯ä»çˆ¶ç±»å¼€å§‹æŸ¥æ‰¾ 5 æ¶ˆæ¯è½¬å‘æœ‰ä»€ä¹ˆç”¨é€” è§£å†³æ–¹æ³•æ‰¾ä¸åˆ°çš„é”™è¯¯ï¼Œæ”¶é›†é”™è¯¯å‘é€åˆ°æœåŠ¡å™¨ è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜(åˆ©ç”¨ä¸­é—´å¯¹è±¡ï¼Œå¹¶å®ç°æ–¹æ³•è½¬å‘æ¥è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜) 6 æ¶ˆæ¯è½¬å‘-é—®é¢˜æ”¶é›† NSProxy 7 - Hook(äº¤æ¢)ç³»ç»Ÿæ–¹æ³• åº”ç”¨åœºæ™¯ hook æŒ‰é’®ç‚¹å‡» hook è®¾ç½®å­—ä½“åšé€‚é… hook å¯å˜å­—å…¸æ•°ç»„setæ–¹æ³•ï¼ˆé˜²æ­¢ä¼ nilï¼‰ hook æŒ‰é’® 1234567891011121314151617181920212223242526272829303132333435//// UIButton+Hook.m// hookControlDemo//// Created by å°åº¦é˜¿ä¸‰ on 2018/6/1.// Copyright Â© 2018å¹´ å°åº¦é˜¿ä¸‰. All rights reserved.// #import \"UIButton+Hook.h\" #import &lt;objc/runtime.h&gt;@implementation UIButton (Hook)+ (void)load&#123; //1.1 è·å–ç³»ç»Ÿæ–¹æ³•(ç›´æ¥ä»åŸç±»çš„rw_tç»“æ„ä½“ä¸­çš„method_array_té‡Œé¢å–) Method method = class_getInstanceMethod(self, sel_registerName(\"sendAction:to:forEvent\")); //1.2 è·å–åˆ†ç±»å®šä¹‰çš„æ–¹æ³•(ä¹Ÿä¼šå­˜æ”¾åˆ°åŸç±»çš„rw_tç»“æ„ä½“ä¸­method_array_tçš„æ•°ç»„é‡Œé¢) Method method2 = class_getInstanceMethod(self, @selector(pg_sendAction:to:forEvent:)); // 2 è¿›è¡Œäº¤æ¢æ–¹æ³•(äº¤æ¢çš„æ˜¯rw_tç»“æ„ä½“ä¸­method_array_tçš„æ•°ç»„ä¸­çš„method_tä¸­çš„IMP) // å½“è°ƒç”¨æ­¤æ–¹æ³•æ—¶ä¼šæ¸…ç©ºç¼“å­˜ method_exchangeImplementations(method, method2);&#125;// åˆ†ç±»ä¸­å®ç°çš„æ–¹æ³•- (void)pg_sendAction:(SEL)action to:(id)target forEvent:(UIEvent *)event&#123; NSLog(@\"hook\"); /** è°ƒç”¨æ­¤æ–¹æ³• ç›¸å½“äºè°ƒç”¨ç³»ç»Ÿçš„ sendAction:to:forEvent: æ–¹æ³• (å› ä¸ºç³»ç»Ÿçš„sendAction ä¸ ps_sendActionçš„ç»“æ„ä½“ä¸­çš„IMPå·²ç»äº¤æ¢äº†) */ [self pg_sendAction:action to:target forEvent:event];&#125;@end hook å¯å˜æ•°ç»„ 12345678910111213141516171819202122#import \"NSMutableArray+hook.h\"#import &lt;objc/runtime.h&gt;@implementation NSMutableArray (hook)+ (void)load&#123; // æ­£å¸¸æƒ…å†µä¸‹loadè°ƒç”¨ä¸€æ¬¡,ä½†æ˜¯æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹å¯èƒ½è°ƒç”¨å¤šæ¬¡ static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^&#123; // ç±»ç°‡ï¼šNSStringã€NSArrayã€NSDictionaryï¼ŒçœŸå®ç±»å‹æ˜¯å…¶ä»–ç±»å‹ Class cls = NSClassFromString(@\"__NSArrayM\"); Method method = class_getInstanceMethod(cls, @selector(insertObject:atIndex:)); Method method2 = class_getInstanceMethod(cls, @selector(pg_insertObject:atIndex:)); method_exchangeImplementations(method, method2); &#125;);&#125;- (void)pg_insertObject:(id)anObject atIndex:(NSUInteger)index&#123; if (!anObject)return; [self pg_insertObject:anObject atIndex:index];&#125;@end","categories":[],"tags":[]},{"title":"Git","slug":"Git","date":"2018-07-02T11:24:06.000Z","updated":"2018-07-07T13:46:53.777Z","comments":true,"path":"2018/07/02/Git/","link":"","permalink":"http://PGGMan.github.io/2018/07/02/Git/","excerpt":"","text":"1 åˆ›å»ºæ–°åˆ†æ”¯(æœ¬åœ°å’Œè¿œç¨‹)12345678//1 åˆ›å»ºdev_pgåˆ†æ”¯git branch dev_pg //2 åˆ‡æ¢åˆ°æ–°åˆ†æ”¯(dev_pg)git checkout dev_pg//3 åˆ›å»ºå¹¶æ¨é€ä»£ç åˆ°è¿œç¨‹åˆ†æ”¯(dev_pg)git push origin dev_pg 2 åˆ é™¤åˆ†æ”¯12345//1 åˆ é™¤æœ¬åœ°åˆ†æ”¯(dev_pg)git branch -D dev_pg//2 åˆ é™¤è¿œç¨‹åˆ†æ”¯(dev_pg)git branch -r -D origin/dev_pg 3 æŸ¥è¯¢åˆ†æ”¯12345678// 1 åˆ—å‡ºæ‰€æœ‰åˆ†æ”¯(æœ¬åœ°åŠè¿œç¨‹) -aï¼ˆallçš„æ„æ€ï¼‰git branch -a// 2 åˆ—å‡ºè¿œç¨‹åˆ†æ”¯ -r(remote)git branch -r // 3 åˆ—å‡ºæœ¬åœ°åˆ†æ”¯ -l(local)git branch -l 4 æŸ¥è¯¢æœ¬åœ°gitçŠ¶æ€1git status 5 åˆå¹¶ä»£ç 1234567891011121314//1 åˆ‡æ¢åˆ°åˆå¹¶åˆ†æ”¯ (ä¾‹å¦‚devåˆ†æ”¯å¼€å‘ï¼Œéœ€è¦åˆå¹¶åˆ°masteråˆ†æ”¯ã€‚åˆ™å…ˆåˆ‡æ¢åˆ°masteråˆ†æ”¯)git checkout master//2 åˆå¹¶ä»£ç git merge dev//3 æŸ¥çœ‹æ˜¯å¦æœ‰å†²çªgit status//4 å†æ¬¡æ‹‰ä¸€æ¬¡ä»£ç git pull origin master//5 æ¨é€åˆ°è¿œç¨‹git push origin master 6 æ‰“æ ‡ç­¾(tag) æˆ‘ä»¬å¸¸å¸¸åœ¨ä»£ç å°æ¿æ—¶,ä½¿ç”¨git åˆ›å»ºä¸€ä¸ªtag ,è¿™æ ·ä¸€ä¸ªä¸å¯ä¿®æ”¹çš„å†å²ä»£ç ç‰ˆæœ¬å°±åƒè¢«æˆ‘ä»¬å°å­˜èµ·æ¥ä¸€æ ·,ä¸è®ºæ˜¯è¿ç»´å‘å¸ƒæ‹‰å–,æˆ–è€…ä»¥åçš„ä»£ç ç‰ˆæœ¬ç®¡ç†,éƒ½æ˜¯ååˆ†æ–¹ä¾¿çš„. (1): è½»é‡çº§çš„ å®ƒå…¶å®æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åˆ†æ”¯,æˆ–è€…è¯´æ˜¯ä¸€ä¸ªä¸å¯å˜çš„åˆ†æ”¯.æŒ‡å‘ç‰¹å®šæäº¤å¯¹è±¡çš„å¼•ç”¨. (2):å¸¦é™„æ³¨çš„ å®é™…ä¸Šæ˜¯å­˜å‚¨åœ¨ä»“åº“ä¸­çš„ä¸€ä¸ªç‹¬ç«‹å¯¹è±¡ï¼Œå®ƒæœ‰è‡ªèº«çš„æ ¡éªŒå’Œä¿¡æ¯ï¼ŒåŒ…å«ç€æ ‡ç­¾çš„åå­—ï¼Œæ ‡ç­¾è¯´æ˜ï¼Œæ ‡ç­¾æœ¬èº«ä¹Ÿå…è®¸ä½¿ç”¨ GNU Privacy Guard (GPG) æ¥ç­¾ç½²æˆ–éªŒè¯,ç”µå­é‚®ä»¶åœ°å€å’Œæ—¥æœŸï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½å»ºè®®ä½¿ç”¨å«é™„æ³¨å‹çš„æ ‡ç­¾ï¼Œä»¥ä¾¿ä¿ç•™ç›¸å…³ä¿¡æ¯. 1234567891011121314151617181920//1 åˆ›å»ºtaggit tag -a V1.2 -m &apos;WebSite version 1.2&apos;//2 æŸ¥çœ‹taggit tag//3 æŸ¥çœ‹tagæè¿°å†…å®¹git tag show V1.2//4 æ¨é€çš„è¿œç¨‹git push origin --tags//5 åˆ é™¤æœ¬åœ°æ ‡ç­¾git tag -d V1.2//6 åˆ é™¤è¿œç¨‹æ ‡ç­¾git push origin :refs/tags/V1.2//7 è·å–è¿œç¨‹æ ‡ç­¾ç‰ˆæœ¬ä¸‹çš„åˆ†æ”¯git fetch origin tagV1.2 7 æŸ¥çœ‹åˆ†æ”¯é“¾æ¥åœ°å€12345//1 æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯åœ°å€ï¼ˆfetch pushï¼‰git remote -v//2git remote show origin 8 æ›´æ”¹æ–‡ä»¶å¤¹åå­—12// å°†abcæ–‡ä»¶å¤¹æ”¹åä¸ºaaamv abc aaa 9 å¿½ç•¥æ–‡ä»¶123456789101112131415// åˆ›å»ºå¿½ç•¥æ–‡ä»¶$ touch .gitignore// å¿½ç•¥æ–‡ä»¶å†…å®¹(æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¤åˆ¶å†…å®¹)NSString *gitignore = @\"https://github.com/github/gitignore\";/** å¿½ç•¥ç”¨æˆ·æ“ä½œä¿¡æ¯(æ–‡ä»¶å¤¹ä½ç½®è°ƒæ•´ç­‰) */// åˆ é™¤ç”¨æˆ·æ“ä½œæ–‡ä»¶ (å·¥ç¨‹æœ‰ä¿®æ”¹æ—¶ï¼Œä½¿ç”¨git statusèƒ½æŸ¥åˆ°ä¸‹é¢çš„æ–‡ä»¶ *è¯·è§é™„å½•1*)$ git rm --cached XXX.xcodeproj/project.xcworkspace/xcuserdata/mac.xcuserdatad/UserInterfaceState.xcuserstate// æäº¤æœ¬åœ°åº“$ git commit -m \"Removed the stupid strange file that shouldn't be tracked\"// æ¨é€åˆ°è¿œç¨‹æœåŠ¡$ git push","categories":[],"tags":[]},{"title":"Cocapods","slug":"Cocapods","date":"2018-07-02T09:57:48.000Z","updated":"2018-07-09T05:52:15.831Z","comments":true,"path":"2018/07/02/Cocapods/","link":"","permalink":"http://PGGMan.github.io/2018/07/02/Cocapods/","excerpt":"","text":"1 åˆ é™¤æº12 // (sudoæ˜¯rootçº§åˆ«çš„æŒ‡ä»¤)$ sudo gem sources -r https://rubygems.org/ 2 æ·»åŠ æº1$ sudo gem sources -a https://gems.ruby-china.org/ 3 æŸ¥çœ‹æº1$ gem sources -l 4 åˆå§‹åŒ–ç¯å¢ƒ1$ sudo gem install cocoapods 5 æŸ¥çœ‹ç‰ˆæœ¬1$ pod --version 6 å®‰è£…(ä¸‹è½½)1$ pod setup æ¡†æ¶æ”¯æŒCocoapodsSpecæ–‡ä»¶1234567891011121314151617181920212223//1 Specæ–‡ä»¶é…ç½®ç›¸å…³Pod::Spec.new do |s| #s.name = \"PGTimer\" // æ¡†æ¶åç§°s.version = \"0.0.1\" // æ¡†æ¶ç‰ˆæœ¬å·s.summary = \"all kinds of categories for iOS develop\" //æ‘˜è¦:ç®€å•æè¿°s.description = &lt;&lt;-DESC this project provide all kinds of categories for iOS developerDESC //è¯¦ç»†æè¿°s.homepage = \"https://github.com/PggMan/PGTimerDemo\" //é¡¹ç›®ä¸»è·¯å¾„s.license = \"MIT\" // å¼€æºè®¸å¯ çº§åˆ«ä¸ä½œç”¨è§ä¸‹å›¾s.author = &#123;&#123; \"PggMan\" =&gt; \"pg890101@gmail.com\" &#125; //ä½œè€…é‚®ç®±åã€é‚®ç®±åœ°å€s.platform = :ios // æ¡†æ¶ç›¸å…³å¹³å°s.source = &#123; :git =&gt; \"https://github.com/PggMan/PGTimerDemo.git\", :tag =&gt; s.version &#125; // ä¸‹è½½è·¯å¾„ã€ç‰ˆæœ¬å· æ³¨æ„è·¯å¾„ç»“å°¾å¿…é¡»æ·»åŠ .gitã€‚ä¸ç„¶Cocopodsä¸ä¼šä¼šæŠ¥è­¦å‘Š\"- WARN | github_sources: Github repositories should end in `.git`.\" ä¸ä¼šé€šè¿‡çš„s.source_files = \"PGTimerDemo/PGTimer/*.&#123;h,m&#125;\"//è¢«ç®¡ç†æ–‡ä»¶åœ¨é¡¹ç›®ä¸­çš„è·¯å¾„s.exclude_files = \"Classes/Exclude\" //éœ€è¦å¿½ç•¥ç®¡ç†æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶s.public_header_files = \"iOS_Category/Classes/UIKit/UI_Categories.h\"ï¼Œ\"iOS_Category/Classes/Foundation/Foundation_Category.h\"ï¼Œ\"iOS_Category/Classes/**/*.h\" // å…¬å¼€å¤´æ–‡ä»¶è·¯å¾„s.requires_arc = true // æ˜¯å¦æ˜¯ARCæ¨¡å¼end Specæƒé™ç­‰çº§ 1 è¯·è§é™„å½•ä¸€ 2 æƒé™æ–‡ä»¶å†…å®¹ (ç›´æ¥å¤åˆ¶åˆ°æ–°å»º.txtæ–‡ä»¶ä¸­ï¼Œé‡å‘½åæ–‡ä»¶ä¸º: LICENSE) 1234567891011121314151617181920212223242526272829303132333435363738394041 Copyright (c) 2011-2018 PGTimerDemo Software Foundation (https://github.com/PggMan/PGTimerDemo)Permission is hereby granted, free of charge, to any person obtaining a copyof this software and associated documentation files (the \"Software\"), to dealin the Software without restriction, including without limitation the rightsto use, copy, modify, merge, publish, distribute, sublicense, and/or sellcopies of the Software, and to permit persons to whom the Software isfurnished to do so, subject to the following conditions:The above copyright notice and this permission notice shall be included inall copies or substantial portions of the Software.THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS ORIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THEAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHERLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS INTHE SOFTWARE. Specæ“ä½œ123456789101112/**ç»ˆç«¯æŒ‡ä»¤*/1.$ pod spec create PGTimer // æœ¬åœ°ä¼šç”ŸæˆPGTimer.podspecæ–‡ä»¶å»ºè®®ç”¨Xcode æ‰“å¼€2.$ pod lib lint // ç¼–è¾‘å®Œpodspecæ–‡ä»¶åéœ€è¦éªŒè¯ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶æ˜¯å¦å¯ç”¨//#æ–‡ä»¶ä¸å…è®¸æœ‰ä»»ä½•çš„Warningæˆ–è€…Error#3.$ git tag -m\" first release of my testDemo\" \"0.0.1\"$ git push --tags// æ‰“tag podspecæ–‡ä»¶ä¸­éœ€è¦æŒ‡å®šçš„tag æ¯æ¬¡ä¸Šä¼ æ–°tag ç‰ˆæœ¬ éƒ½éœ€è¦æ›´æ”¹specæ–‡ä»¶ä¸­çš„tagé…ç½®æè¿° podè´¦å·æ³¨å†Œ123456789101112131415161718192021/**æ³¨å†Œ*/$ pod trunk register pg890101@gmail.com 'PggMan' --verbose//1 pg890101@gmail.com æ³¨å†Œçš„é‚®ç®±ï¼Œä¼šå‘é€ä¿¡æ¯è‡³æ­¤é‚®ç®±//2 PggMan ç”¨æˆ·å/**æŸ¥çœ‹*/$ pod trunk me // å¯ä»¥æŸ¥çœ‹ä½ å·²ç»æ³¨å†Œçš„ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…å«ä½ çš„nameã€emailã€sinceã€Podsã€sessionsï¼Œå…¶ä¸­Podsä¸ºä½ å¾€CocoaPodsæäº¤çš„æ‰€æœ‰çš„Podï¼/**æŠŠé¡¹ç›®å¯¹åº”çš„podspecæ–‡ä»¶æ¨é€åˆ°CocoapodsæœåŠ¡ä¸Šå»*/$ pod trunk push PGTimer.podspec/**æ›´æ”¹å·²Cocoapodså·²ç»ç»æ‹¥æœ‰çš„é¡¹ç›®*/$ pod trunk add-owner PGTimer pg890101@gmail.com// CocoapodsDemo æ¡†æ¶å// æ·»åŠ ç®¡ç†è€…çš„é‚®ç®±/**æ›´æ–°æœ¬åœ°åº“*/$ pod repo update// è¡¥å…… é—®é¢˜1 ä¸Šä¼ åï¼Œpod search PGTimer æœç´¢ä¸åˆ° 1 - æ‰“å¼€ Finder ,ç„¶åå‰å¾€æ–‡ä»¶å¤¹(å¿«æ·é”®: shift + command + G) ,è¾“å…¥ä»¥ä¸‹åœ°å€:~/Library/Caches/CocoaPods/ 2 - åˆ é™¤ search_index.json è¿™ä¸ªæ–‡ä»¶,è¿™ä¸ªæ–‡ä»¶æ˜¯ pod search æœç´¢æ—¶çš„ç¼“å­˜æ–‡ä»¶(æœ¬åœ°ç´¢å¼•åº“)ã€‚","categories":[],"tags":[]},{"title":"å†…å­˜ç®¡ç†","slug":"å†…å­˜ç®¡ç†","date":"2018-07-02T09:43:50.000Z","updated":"2018-07-16T13:32:59.469Z","comments":true,"path":"2018/07/02/å†…å­˜ç®¡ç†/","link":"","permalink":"http://PGGMan.github.io/2018/07/02/å†…å­˜ç®¡ç†/","excerpt":"","text":"iOSç¨‹åºçš„å†…å­˜å¸ƒå±€ Tagged Point 1 ä»arm64å¼€å§‹ï¼ŒiOSå¼•å…¥äº†Tagged PointeræŠ€æœ¯ï¼Œç”¨äºä¼˜åŒ–NSNumberã€NSDateã€NSStringç­‰å°å¯¹è±¡çš„å­˜å‚¨ã€‚ 2 åœ¨æ²¡æœ‰ä½¿ç”¨Tagged Pointerä¹‹å‰ï¼ŒNSNumberç­‰å¯¹è±¡éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜ã€ç»´æŠ¤å¼•ç”¨è®¡æ•°ç­‰ã€NSNumberæŒ‡é’ˆå­˜å‚¨çš„æ˜¯å †ä¸­NSNunberå¯¹è±¡çš„åœ°å€å€¼ã€‚ 3 ä½¿ç”¨Tagged Pointerä¹‹åï¼ŒNSNumberæŒ‡é’ˆé‡Œé¢å­˜å‚¨çš„æ•°æ®å˜æˆäº†ï¼šTag + Dataï¼Œä¹Ÿå°±æ˜¯å°†æ•°æ®ç›´æ¥å­˜å‚¨åœ¨äº†æŒ‡é’ˆä¸­ã€‚ 4 å½“æŒ‡é’ˆä¸å¤Ÿå­˜å‚¨æ•°æ®æ—¶ï¼Œæ‰ä¼šä½¿ç”¨åŠ¨æ€åˆ†é…å†…å­˜çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®(å †) 5 NSNumberã€NSDateã€NSString ä¹Ÿä¼šè°ƒç”¨objc_msgSendå‡½æ•°ï¼Œæ­¤å‡½æ•°å†…éƒ¨å¯¹Tagged Pointè¿›è¡Œäº†åˆ¤æ–­ã€‚ æ¯”å¦‚NSNumberçš„intValueæ–¹æ³•ï¼Œç›´æ¥ä»æŒ‡é’ˆä¸­æå–æ•°æ®ï¼ŒèŠ‚çœäº†ä»¥åçš„è°ƒç”¨å¼€é”€(è¿‡ç¨‹è§ Runtime -&gt;objc_msgSendæ‰§è¡Œæµç¨‹) Tagged Pointåˆ¤æ–­æ–¹æ³• iOSå¹³å°ï¼šæœ€é«˜æœ‰æ•ˆä½æ˜¯1 (ç¬¬64bit) Macå¹³å°: æœ€ä½æœ‰æ•ˆä½æ˜¯1 (ç¬¬0bit) OCå¯¹è±¡å†…å­˜ç®¡ç† åœ¨iOSä¸­ï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥ç®¡ç†OCå¯¹è±¡çš„å†…å­˜ ä¸€ä¸ªæ–°åˆ›å»ºçš„OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1(1)ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º0ï¼ŒOCå¯¹è±¡å°±ä¼šé”€æ¯ï¼Œé‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ç©ºé—´ã€‚ è°ƒç”¨retainå¼•ç”¨è®¡æ•°ä¼š+1ï¼Œè°ƒç”¨releaseä¼šè®©OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°-1ã€‚ å†…å­˜ç®¡ç†ç»éªŒ å½“è°ƒç”¨allocã€newã€copyã€mutableCopyã€æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ã€‚åœ¨ä¸éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œè¦è°ƒç”¨releaseæˆ–è€…autoreleaseæ¥é‡Šæ”¾å®ƒ æƒ³æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©å®ƒçš„å¼•ç”¨è®¡æ•°+1(retain)ï¼›ä¸æƒ³å†æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©å®ƒçš„å¼•ç”¨è®¡æ•°-1(release) æŸ¥çœ‹è‡ªåŠ¨é‡Šæ”¾æ±  de å‡½æ•° ç§æœ‰å‡½æ•°ï¼Œè°ƒç”¨æ­¤å‡½æ•°ä¼šæ‰“å°å‡ºè‡ªåŠ¨é‡Šæ”¾æ± ç›¸å…³ä¿¡æ¯ 1extern void _objc_autoreleasePoolPrint(void); å¼•ç”¨è®¡æ•°å­˜å‚¨ isa_t -&gt; uintptr_t has_sidetable_rc åœ¨64bitä¸­ï¼Œå¼•ç”¨è®¡æ•°å¯ä»¥ç›´æ¥å­˜å‚¨åœ¨ä¼˜åŒ–è¿‡å¾—isaæŒ‡é’ˆä¸­ï¼Œä¹Ÿå¯èƒ½å­˜å‚¨åœ¨SideTableç±»ä¸­(extra_rc ç”¨19ä½æ¥å­˜å‚¨è®¡æ•°å™¨ç›¸å…³æ•°æ®,è¶…å‡ºåä¼šå­˜å‚¨äº has_sidetable_rcç»“æ„ä½“å†…(N - 1)) SideTableç»“æ„ä½“ä¸­refcntsæ˜¯ä¸€ä¸ªå­˜æ”¾ç€å¯¹è±¡å¼•ç”¨è®¡æ•°çš„æ•£åˆ—è¡¨ã€‚ 123456789101112131415161718192021222324252627struct SideTable &#123; spinlock_t slock; RefcountMap refcnts; weak_table_t weak_table; SideTable() &#123; memset(&amp;weak_table, 0, sizeof(weak_table)); &#125; ~SideTable() &#123; _objc_fatal(\"Do not delete SideTable.\"); &#125; void lock() &#123; slock.lock(); &#125; void unlock() &#123; slock.unlock(); &#125; void forceReset() &#123; slock.forceReset(); &#125; template&lt;HaveOld, HaveNew&gt; static void lockTwo(SideTable *lock1, SideTable *lock2); template&lt;HaveOld, HaveNew&gt; static void unlockTwo(SideTable *lock1, SideTable *lock2);&#125;; è‡ªåŠ¨é‡Šæ”¾æ±  è‡ªåŠ¨é‡Šæ”¾æ± çš„ä¸»è¦åº•å±‚æ•°æ®ç»“æ„æ˜¯: __AtAutoreleasePoolã€AutoreleasePoolPageã€‚ è°ƒç”¨äº†autoreleaseçš„å¯¹è±¡æœ€ç»ˆéƒ½æ˜¯é€šè¿‡AutoreleasePoolPageå¯¹è±¡æ¥ç®¡ç†çš„ã€‚ AutoreleasePoolPageæ˜¯ä¸“å±äºæŸä¸€ä¸ªçº¿ç¨‹çš„,ç»“æ„ä½“å†…æœ‰ä¸€ä¸ªthreadå±æ€§ç”¨æ¥å­˜å‚¨å®ƒçš„å½’å±çº¿ç¨‹ã€‚ @autoreleasepool{}çš„è°ƒç”¨ä¸__AtAutoreleasePoolæœ‰å…³ 12345678910111213141516// OC MRC ä»£ç @autoreleasepool&#123;Person *person = [[Person alloc] init] autorelease];&#125;// è½¬æˆc++ä»£ç  ç›¸å½“äº@autoreleasepool&#123; atautoreleasepoolobj = objc_autoreleasePoolPush(); // å¼€å¤´è°ƒç”¨ Person *person = [[Person alloc] init] autorelease]; objc_autoreleasePoolPop(atautoreleasepoolobj) // ç»“å°¾è°ƒç”¨&#125; __AtAutoreleasePoolçš„ç»“æ„ä½“ __AtAutoreleasePoolç»“æ„ä½“å†…å®šä¹‰äº†objc_autoreleasePoolPush()å’Œ objc_autoreleasePoolPop()ä¸¤ä¸ªå‡½æ•°ã€‚ 1234567891011121314151617181920// c++ ç»“æ„ä¸­å¯ä»¥å®šä¹‰å‡½æ•°struct __AtAutoreleasePool &#123; __AtAutoreleasePool() &#123; // æ„é€ å‡½æ•°ã€‚åœ¨åˆ›å»ºç»“æ„ä½“çš„æ—¶å€™è°ƒç”¨ // atautoreleasepoolobj æ˜¯ POOL_BOUNDARYçš„åœ°å€å€¼ atautoreleasepoolobj = objc_autoreleasePoolPush(); &#125; __AtAutoreleasePool() &#123;// ææ„å‡½æ•°ï¼Œåœ¨ç»“æ„ä½“é”€æ¯çš„æ—¶å€™è°ƒç”¨ objc_autoreleasePoolPop(atautoreleasepoolobj); &#125; void * atautoreleasepoolobj; &#125;; 123456789101112131415161718192021222324// 1void *objc_autoreleasePoolPush(void)&#123; return AutoreleasePoolPage::push();&#125;class AutoreleasePoolPage &#123; // 2 static inline void *push() &#123; id *dest; // POOL_BOUNDARY å¸¸é‡ (Null) æœ€åè¿”å›çš„æ˜¯å®ƒåœ¨pageä¸­çš„å†…å­˜åœ°å€ if (DebugPoolAllocation) &#123; dest = autoreleaseNewPage(POOL_BOUNDARY); &#125; else &#123; dest = autoreleaseFast(POOL_BOUNDARY); &#125; assert(dest == EMPTY_POOL_PLACEHOLDER || *dest == POOL_BOUNDARY); return dest; &#125; AutoreleasePoolPageçš„ç»“æ„ è‡ªåŠ¨é‡Šæ”¾æ± é€šè¿‡ __AtAutoreleasePoolå†…éƒ¨å®šä¹‰çš„å‡½æ•°æ¥æ“ä½œAutoreleasePoolPageæ¥ç®¡ç†autoreleaseå¯¹è±¡çš„åœ°å€ æ‰€æœ‰AutoreleasePoolPageå¯¹è±¡é€šè¿‡åŒå‘é“¾è¡¨çš„å½¢å¼è¿æ¥åœ¨ä¸€èµ·ã€‚ æ¯ä¸ªAutoreleasePoolPageå¯¹è±¡å ç”¨4096å­—èŠ‚å†…å­˜ï¼Œé™¤äº†ç”¨æ¥å­˜æ”¾å®ƒå†…éƒ¨çš„æˆå‘˜å˜é‡ï¼Œå‰©ä¸‹çš„ç©ºé—´ç”¨æ¥å­˜æ”¾autoreleaseå¯¹è±¡çš„åœ°å€ æ¯ä¸ªAutoreleasePoolPageå¯¹è±¡å†…æœ‰å›ºå®šçš„7ä¸ªå±æ€§(å 56ä¸ªå­—èŠ‚),å…¶ä½™ç©ºé—´(4096 - 56 = 4040 å­—èŠ‚)ç”¨äºå­˜å‚¨autoreleaseå¯¹è±¡çš„å†…å­˜åœ°å€ nextæŒ‡å‘äº†ä¸‹ä¸€ä¸ªèƒ½å­˜æ”¾autoreleaseå¯¹è±¡åœ°å€çš„åŒºåŸŸ è‡ªåŠ¨é‡Šæ”¾æ± æ“ä½œæµç¨‹ç»“æ„ä½“ @autoreleasepool @autoreleasepoolé€šè¿‡__AtAutoreleasePoolæ¥æ“ä½œï¼Œé€šè¿‡AutoreleasePoolPageæ¥ç®¡ç†ã€‚ objc_autoreleasePoolPush() objc_autoreleasePoolPush() æ˜¯è°ƒç”¨äº† AutoreleasePoolPageç»“æ„ä½“å†…å®šä¹‰çš„push()å‡½æ•°ï¼Œé¦–å…ˆï¼Œå°†POOL_BOUNDARYå…¥æ ˆï¼Œå¹¶è¿”å›å…¶å­˜å‚¨çš„å†…å­˜åœ°å€ å°†Nä¸ªautoreleaseå¯¹è±¡æŒ‰é¡ºåºå­˜å‚¨åˆ°pageä¸­ã€‚ å½“å‰pageæ»¡äº†ï¼Œå°±ä¼šæ–°åˆ›å»ºä¸€ä¸ªpageï¼ŒæŠŠautoreleaseå¯¹è±¡å­˜å‚¨åˆ°æ–°çš„pageä¸­ã€‚ objc_autoreleasePoolPop() objc_autoreleasePoolPop() æ˜¯è°ƒç”¨äº† AutoreleasePoolPageç»“æ„ä½“å†…å®šä¹‰çš„pop()å‡½æ•°ï¼Œè°ƒç”¨æ­¤å‡½æ•°éœ€è¦ä¼ å…¥objc_autoreleasePoolPush()çš„è¿”å›å€¼(POOL_BOUNDARYçš„å†…å­˜åœ°å€) pop()ä¼šä»hotpageï¼ˆæœ€åä¸€é¡µï¼‰çš„æœ€åä¸€ä¸ªautoreleaseå¯¹è±¡å¼€å§‹è°ƒç”¨ä»–ä»¬çš„releaseæ–¹æ³•ï¼Œç›´åˆ°é‡åˆ°ä¼ å…¥çš„å†…å­˜åœ°å€ï¼Œåœæ­¢ã€‚ Runloopå’ŒAutorelease iOSåœ¨ä¸»çº¿ç¨‹çš„Runloopä¸­æ³¨å†Œäº†2ä¸ªObserver ç¬¬ä¸€ä¸ªObserverç›‘å¬KCFRunLoopEntryäº‹ä»¶ï¼Œä¼šè°ƒç”¨objc_autoreleasePoolPush() ç¬¬äºŒä¸ªObserver: ç›‘å¬äº†KCFRunloopBeforeWaitingäº‹ä»¶ï¼Œä¼šè°ƒç”¨objc_autoreleasePoolPop()ã€ objc_autoreleasePoolPush()å‡½æ•° ç›‘å¬äº†KCFRunloopBeforeExitäº‹ä»¶ï¼Œä¼šè°ƒç”¨objc_autoreleasePoolPop() å±æ€§ä¿®é¥°è¯ å±æ€§ - assign 1 - assign settingæ–¹æ³•ç›´æ¥èµ‹å€¼ã€‚ä¸ä¼šè¿›è¡Œå¼•ç”¨è®¡æ•°æ“ä½œã€‚ 1@property (nonatomic ,assign) NSInteger age; å±æ€§ - retain 2 - retain settingæ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ˜¯ä¸æ˜¯æ–°å€¼ï¼›è‹¥æ˜¯ï¼Œä¼šreleaseæ—§å€¼ï¼Œretainæ–°å€¼ åœ¨deallocä¸­ä¼š releaseé‡Šæ”¾å¯¹è±¡ã€‚ 1@property (nonatomic , retain) Dog *dog; å±æ€§ - copy 3 - copy settingæ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ˜¯ä¸æ˜¯æ–°å€¼ï¼›è‹¥æ˜¯ï¼Œä¼šreleaseæ—§å€¼ï¼Œcopyæ–°å€¼ åœ¨deallocä¸­ä¼š releaseé‡Šæ”¾å¯¹è±¡ å±æ€§ä¸å­˜åœ¨ mutableCopy æ“ä½œ 1@property (nonatomic , copy) NSArray *ary; å±æ€§ - weak 4 - weak ä¸è¿›è¡Œå¼•ç”¨è®¡æ•°æ“ä½œï¼Œåœ¨å…¶æŒ‡å‘å¯¹è±¡é”€æ¯æ—¶ï¼Œä¼šè¿›è¡Œä¸€æ¬¡æ¸…ç©ºæ“ä½œ åœ¨settingæ–¹æ³•ä¸­è°ƒç”¨objc_storeWeakå‡½æ•°ï¼Œä¼šæŠŠweakæŒ‡é’ˆåœ¨æ•£åˆ—è¡¨ä¸­æ¸…é™¤å¹¶æ¸…ç©ºweakæŒ‡é’ˆæ¸…ç©ºã€‚ç„¶åæŠŠèµ‹å€¼åçš„æ–°weak æŒ‡é’ˆå­˜å‚¨åˆ°å½“å‰OCå¯¹è±¡çš„æ•£åˆ—è¡¨ä¸­(sideTable -&gt; refonts(RefcountMap)) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990@property (nonatomic , weak) Person *p;/********************** æºç  **********************/idobjc_storeWeak(id *location, id newObj)&#123; return storeWeak&lt;DoHaveOld, DoHaveNew, DoCrashIfDeallocating&gt; (location, (objc_object *)newObj);&#125;template &lt;HaveOld haveOld, HaveNew haveNew, CrashIfDeallocating crashIfDeallocating&gt;static id storeWeak(id *location, objc_object *newObj)&#123; assert(haveOld || haveNew); if (!haveNew) assert(newObj == nil); Class previouslyInitializedClass = nil; id oldObj; SideTable *oldTable; // æ—§å¾—å¼•ç”¨è®¡æ•°è¡¨, SideTable *newTable;// æ“ä½œæ’åºé¡ºåºç›¸å…³(é”) retry: if (haveOld) &#123; oldObj = *location; oldTable = &amp;SideTables()[oldObj]; &#125; else &#123; oldTable = nil; &#125; if (haveNew) &#123; newTable = &amp;SideTables()[newObj]; &#125; else &#123; newTable = nil; &#125; SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); if (haveOld &amp;&amp; *location != oldObj) &#123; SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); goto retry; &#125; if (haveNew &amp;&amp; newObj) &#123; Class cls = newObj-&gt;getIsa(); if (cls != previouslyInitializedClass &amp;&amp; !((objc_class *)cls)-&gt;isInitialized()) &#123; SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); _class_initialize(_class_getNonMetaClass(cls, (id)newObj)); previouslyInitializedClass = cls; goto retry; &#125; &#125; // æ­¤weakæŒ‡é’ˆå­˜å‚¨åœ¨å¼•ç”¨è®¡æ•°ç»“æ„ä½“(sideTable)çš„æ•£åˆ—è¡¨(refonts)ä¸­ï¼Œå°†å…¶å–å‡ºæ¸…ç©º if (haveOld) &#123; weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location); &#125; // æŠŠæ–°å€¼å­˜å‚¨åˆ°æ•£åˆ—è¡¨ä¸­ if (haveNew) &#123; newObj = (objc_object *) weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location, crashIfDeallocating); if (newObj &amp;&amp; !newObj-&gt;isTaggedPointer()) &#123; newObj-&gt;setWeaklyReferenced_nolock(); &#125; *location = (id)newObj; &#125; else &#123; &#125; SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); return (id)newObj;&#125; å±æ€§ - strong 5 - strongåœ¨settingæ–¹æ³•ä¸­ä¼šå¯¹ä¼ å…¥çš„æ–°å€¼è¿›è¡Œå¼•ç”¨è®¡æ•°æ“ä½œ(retain),é™ä½æ—§å€¼å¼•ç”¨è®¡æ•°(release) 123456789101112131415@property (nonatomic , strong) Person *p;/********************** æºç  **********************/voidobjc_storeStrong(id *location, id obj)&#123; id prev = *location; if (obj == prev) &#123; return; &#125; objc_retain(obj); // retainæ–°å€¼ *location = obj; objc_release(prev); // releaseæ—§å€¼&#125; OCæŒ‡é’ˆä¿®é¥°è¯ OCæŒ‡é’ˆä¿®é¥°è¯ - __strong è¶…å‡º__strongä¿®é¥°æŒ‡é’ˆçš„ä½œç”¨åŸŸåæ‰ä¼šé‡Šæ”¾ã€‚å¯¹å¼•ç”¨è®¡æ•°è¿›è¡Œäº†æ“ä½œ(+1) 123456789101112- (void)test &#123; __strong Person *p1; &#123; Person *p = [[Person alloc] init]; p1 = p; &#125; &#125;// p é‡Šæ”¾ OCæŒ‡é’ˆä¿®é¥°è¯ - __weak __weakåªæ˜¯å¯¹å…¶ä¿®é¥°æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡è¿›è¡Œå¼•ç”¨ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œå¼•ç”¨è®¡æ•°æ“ä½œã€‚åœ¨å¯¹è±¡é”€æ¯æ—¶ï¼Œä¼šå¯¹å¯¹å…¶ä¿®é¥°æŒ‡é’ˆè¿›è¡Œä¸€æ¬¡æ¸…ç©ºæ“ä½œã€‚ 123456789101112- (void)test &#123; __weak Person *p2; &#123; Person *p = [[Person alloc] init]; p2 = p; &#125;// p é‡Šæ”¾ &#125; OCæŒ‡é’ˆä¿®é¥°è¯ - __unsafe_unretained __unsafe_unretained åŒ__weakæœ‰äº›ç±»ä¼¼ï¼Œåªæ˜¯å¯¹å…¶ä¿®é¥°æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡è¿›è¡Œå¼•ç”¨ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œå¼•ç”¨è®¡æ•°æ“ä½œ.ä½†æ˜¯,ä¸ä¼šå¯¹å…¶ä¿®é¥°æŒ‡é’ˆè¿›è¡Œæ¸…ç©ºæ“ä½œ(è¿˜æŒ‡å‘åŸæ¥pçš„å†…å­˜åœ°å€)ã€‚ 12345678910111213- (void)test &#123; __unsafe_unretained Person *p2; &#123; Person *p = [[Person alloc] init]; p2 = p; &#125;// p é‡Šæ”¾ // æ­¤æ—¶ p2 ä»ç„¶æŒ‡å‘ påŸæ¥çš„å†…å­˜åœ°å€ &#125; weakå®ç°åŸç† å…³äºweakçš„runtimeæºç  å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106// 1 - (void)dealloc &#123; _objc_rootDealloc(self);&#125;// 2 void_objc_rootDealloc(id obj)&#123; assert(obj); obj-&gt;rootDealloc();&#125;// 3inline voidobjc_object::rootDealloc()&#123; if (isTaggedPointer()) return; // fixme necessary? if (fastpath(isa.nonpointer &amp;&amp; // æ˜¯å¦æ˜¯ä¼˜åŒ–è¿‡å¾—isa !isa.weakly_referenced &amp;&amp; // æ˜¯å¦ æ²¡æœ‰ å¼±å¼•ç”¨æŒ‡å‘å®ƒ !isa.has_assoc &amp;&amp; // æ˜¯å¦ æ²¡æœ‰ å…³è”å¯¹è±¡ !isa.has_cxx_dtor &amp;&amp; // æ˜¯å¦ æ²¡æœ‰ c++ææ„å‡½æ•° !isa.has_sidetable_rc)) // æ˜¯å¦ æ²¡æœ‰ å¦ä¸€ä¸ªsidetableç»“æ„ä½“å­˜å‚¨å¼•ç”¨è®¡æ•°ç›¸å…³ &#123; // ç›´æ¥é‡Šæ”¾ assert(!sidetable_present()); free(this); &#125; else &#123; // è¿›è¡Œç›¸å…³å¤„ç†(é‡Šæ”¾å…³è”å¯¹è±¡ã€weakæŒ‡é’ˆã€sidetable ç­‰) // è¿›è¡Œ 4 5 object_dispose((id)this); &#125;&#125;// 4id object_dispose(id obj)&#123; if (!obj) return nil; objc_destructInstance(obj); free(obj); return nil;&#125;// 5void *objc_destructInstance(id obj) &#123; if (obj) &#123; bool cxx = obj-&gt;hasCxxDtor(); bool assoc = obj-&gt;hasAssociatedObjects(); if (cxx) object_cxxDestruct(obj); // é”€æ¯c++ææ„å‡½æ•°(é”€æ¯æˆå‘˜å˜é‡) if (assoc) _object_remove_assocations(obj); // é”€æ¯å…³è”å¯¹è±¡ obj-&gt;clearDeallocating(); // æ¸…ç©ºè‹¥æŒ‡é’ˆ &#125; return obj;&#125;// 6 inline void objc_object::clearDeallocating()&#123; if (slowpath(!isa.nonpointer)) &#123; // æ˜¯æ™®é€šæŒ‡é’ˆ sidetable_clearDeallocating(); &#125; else if (slowpath(isa.weakly_referenced || isa.has_sidetable_rc)) &#123; // æ˜¯ä¼˜åŒ–è¿‡å¾—isaæŒ‡é’ˆ å¹¶ä¸”æœ‰å¼±å¼•ç”¨æŒ‡é’ˆæŒ‡å‘å®ƒ clearDeallocating_slow(); &#125; assert(!sidetable_present());&#125;// 7 NEVER_INLINE voidobjc_object::clearDeallocating_slow()&#123; assert(isa.nonpointer &amp;&amp; (isa.weakly_referenced || isa.has_sidetable_rc)); // å¼•ç”¨è®¡æ•°å­˜å‚¨è¡¨(å“ˆå¸Œè¡¨) SideTable&amp; table = SideTables()[this]; table.lock(); if (isa.weakly_referenced) &#123; // ç”¨å¯¹è±¡çš„å†…å­˜åœ°å€(this)ä½œä¸ºkeyï¼Œå»SideTablesè¡¨é‡Œå»é™¤è‹¥æŒ‡é’ˆè¿›è¡Œæ¸…ç©º weak_clear_no_lock(&amp;table.weak_table, (id)this); &#125; if (isa.has_sidetable_rc) &#123; table.refcnts.erase(this); &#125; table.unlock();&#125; æ€»ç»“ä¸€å¥è¯: weakä¿®é¥°çš„å¯¹è±¡æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡é”€æ¯æ—¶ï¼Œä¼šåœ¨è¯¥å¯¹è±¡çš„deallocå‡½æ•°ä¸­å‘é€æ¶ˆæ¯(è°ƒç”¨å‡½æ•°)ã€‚å»è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è¡¨ä¸­å¯¹weakæŒ‡é’ˆè¿›è¡Œæ¸…ç©ºæ“ä½œã€‚ copyä¸mutableCopy æœ€ç®€æ´çš„ä¸¤ç‚¹ 1 æ”¹å˜æ–°å€¼ä¸å½±å“æ—§å€¼ï¼Œæ”¹å˜æ—§å€¼ä¸å½±å“æ–°å€¼ 2 copyå‡ºæ¥çš„å¿…æ˜¯ä¸å¯å˜ï¼ŒmutableCopyå‡ºæ¥çš„å¿…æ˜¯å¯å˜","categories":[],"tags":[]}]}