<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      音视频 | 印度阿三 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="葛朋">
    
    

    <meta name="description" content="音视频 直播 直播流程：采集、处理、编码、推流、流分发、播放。  音视频采集 音视频的采集是直播架构的第一个环节、也是直播的视频来源 采集的来源包括； PC端：屏幕摄像头（摄像头驱动适配） iOS端：摄像头采集（前后摄像头采集） Android端：屏幕摄像头采集（硬件过多，适配一堆坑）    前处理 处理主要包括: 美颜、模糊效果、水印等 各个平台处理方法 PC端：美颜镜头、一些美颜软件 iOS端">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="音视频 | 印度阿三">
<meta property="og:url" content="http://PGGMan.github.io/2018/07/21/音视频/index.html">
<meta property="og:site_name" content="印度阿三">
<meta property="og:description" content="音视频 直播 直播流程：采集、处理、编码、推流、流分发、播放。  音视频采集 音视频的采集是直播架构的第一个环节、也是直播的视频来源 采集的来源包括； PC端：屏幕摄像头（摄像头驱动适配） iOS端：摄像头采集（前后摄像头采集） Android端：屏幕摄像头采集（硬件过多，适配一堆坑）    前处理 处理主要包括: 美颜、模糊效果、水印等 各个平台处理方法 PC端：美颜镜头、一些美颜软件 iOS端">
<meta property="og:locale" content="Chinese/English">
<meta property="og:image" content="http://pggman.github.io/2018/07/21/音视频/my_map.png">
<meta property="og:updated_time" content="2018-07-23T11:24:51.235Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="音视频 | 印度阿三">
<meta name="twitter:description" content="音视频 直播 直播流程：采集、处理、编码、推流、流分发、播放。  音视频采集 音视频的采集是直播架构的第一个环节、也是直播的视频来源 采集的来源包括； PC端：屏幕摄像头（摄像头驱动适配） iOS端：摄像头采集（前后摄像头采集） Android端：屏幕摄像头采集（硬件过多，适配一堆坑）    前处理 处理主要包括: 美颜、模糊效果、水印等 各个平台处理方法 PC端：美颜镜头、一些美颜软件 iOS端">
<meta name="twitter:image" content="http://pggman.github.io/2018/07/21/音视频/my_map.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">印度阿三</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          I&#39;m my own hero
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">音视频</h1>

    

    <div class="post-meta">
      <time datetime="2018-07-21" class="post-meta__date date">2018-07-21</time> 

      <span class="post-meta__tags tags">

          

          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <h2 id="音视频"><a href="#音视频" class="headerlink" title="音视频 "></a><font color="#037aff" face="黑体">音视频 </font></h2><h4 id="直播"><a href="#直播" class="headerlink" title="直播"></a>直播</h4><ul>
<li>直播流程：<code>采集</code>、<code>处理</code>、<code>编码</code>、<code>推流</code>、<code>流分发</code>、<code>播放</code>。<br><img src="/2018/07/21/音视频/my_map.png" alt="图片生成流程"></li>
</ul>
<h4 id="音视频采集"><a href="#音视频采集" class="headerlink" title="音视频采集"></a><code>音视频采集</code></h4><ul>
<li>音视频的采集是直播架构的第一个环节、也是直播的视频来源</li>
<li>采集的来源包括；<ul>
<li>PC端：屏幕摄像头（摄像头驱动适配）</li>
<li>iOS端：摄像头采集（前后摄像头采集）</li>
<li>Android端：屏幕摄像头采集（硬件过多，适配一堆坑）</li>
</ul>
</li>
</ul>
<h4 id="前处理"><a href="#前处理" class="headerlink" title="前处理"></a><code>前处理</code></h4><ul>
<li>处理主要包括: 美颜、模糊效果、水印等</li>
<li>各个平台处理方法<ul>
<li>PC端：美颜镜头、一些美颜软件</li>
<li>iOS端：图像处理库是GPUImage，提供了丰富的预处理效果，也可利用该库自定义设计</li>
<li>Android端：Google开源的grafika，是一个非常强大的图形处理库</li>
</ul>
</li>
</ul>
<h4 id="编码"><a href="#编码" class="headerlink" title="编码"></a><code>编码</code></h4><ul>
<li>没经过编码的视频非常庞大，存储起来都麻烦，更何况网络传输<ul>
<li>编码通过压缩<code>音视频</code>数据来减少体积，方便<code>音视频</code>数据的推流、拉流和存储，能大大提高存储和传输效率</li>
<li><code>音视频</code>必须经过压缩编码才能进行存储和传输</li>
</ul>
</li>
<li>各个平台处理：<ul>
<li>iOS端：硬件性能好，可以直接进行硬编码</li>
<li>Android端：硬编码较难，难找到同一的库兼容各个平台（推荐使用软编码）</li>
</ul>
</li>
<li>编码标砖：<ul>
<li>视频编码：H.265、<code>H.264</code>、VP8、VP9等</li>
<li>音频编码：AAC（高级音频编码，目的是取代MP3格式）、Opus</li>
</ul>
</li>
</ul>
<h4 id="传输"><a href="#传输" class="headerlink" title="传输"></a><code>传输</code></h4><ul>
<li><p>从推流端到服务端</p>
<ul>
<li>数据经过推流端采集和预处理，编码之后推流到服务端</li>
<li>流传输就涉及到相应的传输协议，最常用的协议是RTMP、RTSP、HLS、        <h4 id="流分发"><a href="#流分发" class="headerlink" title="流分发"></a><code>流分发</code></h4></li>
</ul>
</li>
<li><p>音频流推到服务器后，为了适配各个平台端各种不同协议，需要在服务端做一些流处理工作。比如转码成不同格式支持不同协议如<code>RTMP</code>、<code>HLS</code>、<code>FLV</code>。以适应各个平台。</p>
<ul>
<li>比如：iOS、Android、PC、网页 </li>
</ul>
</li>
</ul>
<h4 id="播放"><a href="#播放" class="headerlink" title="播放"></a><code>播放</code></h4><ul>
<li>拉流获取音视频数据后，需要通过解码器解码，渲染才能在播放器上播放。</li>
<li>总体步骤概览：<ul>
<li>解协议：去除网络传输过程中一些无用信息</li>
<li>解封装：获取到的是音频&amp;视频放在一起的封装文件</li>
<li>音视频解码：音视频都是经过压缩编码的内容，解码后才能进行播放</li>
<li>音视频同步：视频&amp;音频文件需要同步播放</li>
<li>音视频播放：声卡&amp;显卡等对音视频进行播放。   </li>
</ul>
</li>
</ul>
<h2 id="采集音视频"><a href="#采集音视频" class="headerlink" title="采集音视频"></a><font color="#037aff" face="黑体">采集音视频</font></h2><ul>
<li>音视频采集是直播架构的第一环节，是视频的来源    <ul>
<li>其实视频的采集有多个应用场景：比如二维码开发 </li>
</ul>
</li>
<li>音视频采集包括两部分<ul>
<li>视频采集</li>
<li>音频采集</li>
</ul>
</li>
<li>在iOS开发中，是可以同步采集视频&amp;音频的，使用方式也非常简单</li>
<li>相关的采集API都封装在AVFoundation框架中，导入对应框架，实现功能即可</li>
</ul>
<h4 id="采集步骤"><a href="#采集步骤" class="headerlink" title="采集步骤"></a>采集步骤</h4><ul>
<li>PS：如果做过二维码开发、应该对相关操作非常数据（非常类似）</li>
<li>导入框架<ul>
<li>相关API主要在AVFoundation框架中，因此需要先导入框架  </li>
</ul>
</li>
<li>创建捕捉回话    (AVCaptureSession)<ul>
<li>该回话适用于连接之后的输入源&amp;输出源</li>
<li>输入源：摄像头&amp;话筒</li>
<li>输出源：拿到对应的音频&amp;视频</li>
<li>回话：用于将输入源&amp;输出源连接起来 </li>
</ul>
</li>
<li>设置视频输入源&amp;输出源<ul>
<li>输入源：（AVCaptureDeviceInput）：从摄像头输入</li>
<li>输出源：(AVCaptureAudioDataOutput）：可以设置代理，在代理方法中拿到数据</li>
<li>将输入&amp;输出添加到回话中     </li>
</ul>
</li>
<li>添加预览图层（可选）<ul>
<li>如果希望用户看到采集的画面，可以添加预览图层</li>
<li>该预览图层不是必须的，即使没有添加也可以正常采集数据。</li>
</ul>
</li>
<li>开始采集即可<ul>
<li>调用会话（AVCaptureSession）的startRunning方法即可开始采集。</li>
</ul>
</li>
</ul>
<pre><code class="objc">
<span class="meta">#import <span class="meta-string">"VideoToolController.h"</span></span>
<span class="meta">#import <span class="meta-string">&lt;AVFoundation/AVFoundation.h&gt;</span></span>
<span class="class"><span class="keyword">@interface</span> <span class="title">VideoToolController</span> ()&lt;<span class="title">AVCaptureMetadataOutputObjectsDelegate</span>&gt;</span>

<span class="keyword">@end</span>

<span class="class"><span class="keyword">@implementation</span> <span class="title">VideoToolController</span></span>

- (<span class="keyword">void</span>)viewDidLoad {
    [<span class="keyword">super</span> viewDidLoad];


    [<span class="keyword">self</span> catchVideo];

}


- (<span class="keyword">void</span>)catchVideo{
    <span class="comment">//1 创建回话</span>
    <span class="built_in">AVCaptureSession</span> *session = [[<span class="built_in">AVCaptureSession</span> alloc] init];

    <span class="comment">//2 创建Device</span>
    <span class="built_in">AVCaptureDevice</span> *device = [<span class="built_in">AVCaptureDevice</span> defaultDeviceWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];
    <span class="comment">//3 创建输入源并添加到回话中</span>
    <span class="built_in">NSError</span> *error;
    <span class="built_in">AVCaptureDeviceInput</span> *input =  [<span class="built_in">AVCaptureDeviceInput</span> deviceInputWithDevice:device error:&amp;error];

    <span class="keyword">if</span>(input) {
        [session addInput:input];
    } <span class="keyword">else</span> {
        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, error);
        <span class="keyword">return</span>;
    }

    <span class="comment">//4 创建输出源并添加到回话中</span>
    <span class="comment">//output</span>
    <span class="built_in">AVCaptureMetadataOutput</span> *output = [[<span class="built_in">AVCaptureMetadataOutput</span> alloc] init];
    [session addOutput:output];

    [output setMetadataObjectTypes:@[<span class="built_in">AVMetadataObjectTypeQRCode</span>]];

    [output setMetadataObjectsDelegate:<span class="keyword">self</span> queue:dispatch_get_main_queue()];

    <span class="comment">// 预览layer</span>
    <span class="comment">/**</span>
<span class="comment">    self.previewLayer = [AVCaptureVideoPreviewLayer layerWithSession:self.session];</span>
<span class="comment">    [self.preview.layer addSublayer:self.previewLayer];</span>
<span class="comment">    */</span>
    <span class="comment">//start</span>
    [session startRunning];

}

<span class="comment">/**</span>
<span class="comment"> 代理 输出</span>
<span class="comment"> */</span>
- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureOutput</span> *)captureOutput didOutputMetadataObjects:(<span class="built_in">NSArray</span> *)metadataObjects fromConnection:(<span class="built_in">AVCaptureConnection</span> *)connection
{
    <span class="keyword">for</span> (<span class="built_in">AVMetadataMachineReadableCodeObject</span> *metadata <span class="keyword">in</span> metadataObjects) {
        <span class="keyword">if</span> ([metadata.type isEqualToString:<span class="built_in">AVMetadataObjectTypeQRCode</span>]) {

            <span class="keyword">if</span> ([metadata.stringValue length] &gt;<span class="number">0</span>)
            {
                <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,metadata.stringValue);

            }<span class="keyword">else</span>{

                <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,metadata.stringValue);
            }
        }
    }
}

<span class="keyword">@end</span>

</code></pre>

  </section>

  <section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
